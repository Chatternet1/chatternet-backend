<!DOCTYPE html>  
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chatternet — Dating</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Poppins:wght@600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --brand:#3498db; --brand-2:#2980b9;
    --bg:#f5f7fb; --card:#fff; --ink:#0f172a;
    --muted:#667085; --line:#e6eaf2; --heart:#ff3b5c;
    --content:1160px; --radius:12px; --control-h:46px;
    --navH:44px; /* height of app nav (set by JS) */
  }
  .ct, .ct * { box-sizing:border-box }
  .ct{ background:var(--bg); color:var(--ink); font-family:'Inter',ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Helvetica,Arial; font-size:16px; line-height:1.5; -webkit-font-smoothing:antialiased; overflow-x:hidden }
  .ct h1,.ct h2,.ct h3{margin:0 0 12px; line-height:1.2; font-family:'Poppins','Inter',ui-sans-serif}
  .ct h2{font-weight:800}
  .ct .muted{color:var(--muted)}
  .ct input,.ct select,.ct textarea,.ct button{ font:inherit }
  .ct input:not([type="checkbox"]), .ct select{ height:var(--control-h) }
  .ct input:not([type="checkbox"]), .ct select, .ct textarea{
    width:100%; max-width:100%; padding:12px 14px; background:#fff; color:var(--ink);
    border:1px solid #d8e0f0; border-radius:var(--radius);
    outline:none; box-shadow:none; appearance:none; background-image:none
  }
  .ct textarea{ min-height:120px; resize:vertical }
  .ct input:focus,.ct select:focus,.ct textarea:focus{ border-color:var(--brand); box-shadow:0 0 0 4px rgba(52,152,219,.18) }
  .ct ::placeholder{ color:#98a2af }

  .btn{padding:11px 14px;border:1px solid #d8e0f0;border-radius:var(--radius);background:#fff;cursor:pointer;white-space:nowrap}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-2)}
  .btn.ghost{background:#f2f7ff;border-color:#d8e8ff}

  /* ===== App Nav (same as Home/Admin) ===== */
  .app-nav{
    position:sticky; top:0; z-index:80;
    background:linear-gradient(#edf4ff,#eaf2ff);
    border-bottom:1px solid #d7e6ff;
  }
  .app-nav .inner{
    max-width:1400px; margin:0 auto; padding:10px 14px;
    display:flex; flex-wrap:wrap; gap:18px; align-items:center;
  }
  .app-nav a{
    text-decoration:none; color:#0f2742; font-weight:700; letter-spacing:.2px;
    padding:4px 0; border-bottom:2px solid transparent;
  }
  .app-nav a:hover{ border-bottom-color:#9bc2ff; }
  .app-nav a.active{ border-bottom-color:#2b78e4; color:#0b3a67; }

  /* Topbar sits below app nav */
  .topbar{position:sticky;top:var(--navH);z-index:40;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--brand);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2)}
  .topbar h2{margin:0}
  .topactions{display:flex;gap:8px;align-items:center}
  .avatar{width:38px;height:38px;border-radius:50%;border:2px solid rgba(255,255,255,.9);object-fit:cover;cursor:pointer}

  .page{max-width:calc(var(--content) + 100px); margin:18px auto; padding:0 34px 28px}

  .card{background:var(--card);border:1px solid rgba(0,0,0,.06);border-radius:16px;box-shadow:0 8px 24px rgba(17,23,41,.08);padding:18px;overflow:hidden}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin:0 0 12px}
  .row>*{min-width:0;flex:1}

  /* Discover deck */
  .deckwrap{position:relative;height:520px;width:100%;margin-top:6px}
  @media (max-width:640px){ .deckwrap{height:430px} }
  .deck{position:relative;height:100%;width:100%}
  .person{position:absolute;inset:0;border-radius:16px;overflow:hidden;background:#fff;border:1px solid #e5e7eb;box-shadow:0 10px 24px rgba(0,0,0,.12);display:flex;flex-direction:column;transform-origin:50% 100%;touch-action:none;user-select:none}
  .cover{flex:1;background:#e5e7eb;position:relative}
  .cover img{position:absolute;inset:0;width:100%;height:100%;object-fit:cover}
  .info{padding:16px}
  .name{font-family:'Poppins',sans-serif;font-size:22px;font-weight:800}
  .bio{color:#475569;margin-top:6px;white-space:pre-wrap}
  .chips{display:flex;gap:6px;flex-wrap:wrap;margin:10px 0 0}
  .chip{background:#fff;border:1px solid var(--line);padding:6px 10px;border-radius:999px}

  .badge{position:absolute;top:18px;padding:8px 12px;border:3px solid;border-radius:10px;font-weight:800;font-size:16px;background:rgba(255,255,255,.85);text-transform:uppercase;letter-spacing:.5px}
  .badge.like{left:18px;color:#10b981;border-color:#10b981}
  .badge.pass{right:18px;color:#64748b;border-color:#64748b;transform:rotate(12deg)}
  .badge.super{left:18px;color:#7c3aed;border-color:#7c3aed;transform:rotate(-12deg)}

  .deckactions{display:flex;justify-content:center;gap:10px;margin:12px 0 0;flex-wrap:wrap}
  .circle{width:58px;height:58px;border-radius:50%;border:2px solid #e5e7eb;background:#fff;display:flex;align-items:center;justify-content:center;cursor:pointer}
  .circle:hover{background:#f3f4f6}
  .circle svg{width:26px;height:26px}

  /* ===== Admin-style tabs (same UI as Admin) ===== */
  .tabs{display:flex;gap:10px;align-items:center;margin:16px 0 8px;flex-wrap:wrap}
  .tab{
    background:#fff; border:1px solid #e5e7eb; color:#0f172a; font-weight:800;
    padding:10px 16px; border-radius:14px; cursor:pointer;
    box-shadow:0 1px 2px rgba(0,0,0,.06);
  }
  .tab:hover{background:#f7fbff;border-color:#dbeafe}
  .tab.active{
    border-color:#cfe1ff;
    box-shadow:0 4px 14px rgba(34,139,230,.18);
  }
  .panes{position:relative}
  .pane{display:none}
  .pane.active{display:block}

  /* Lists */
  .item{display:flex;gap:12px;padding:12px;border:1px solid #ececec;border-radius:12px;background:#fafafa;align-items:flex-start;margin-top:12px}
  .ava{width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #fff;flex:0 0 auto}
  .meta{color:#475569;margin:0 0 8px;font-size:.95rem}
  .ptitle{font-family:'Poppins',sans-serif;font-size:18px;font-weight:800;margin:0 0 6px}
  .media{border-radius:12px;overflow:hidden;border:1px solid var(--line);background:#fff;margin:8px 0}
  .media iframe,.media video{aspect-ratio:16/9;height:auto;min-height:220px}
  .util{display:flex;align-items:center;gap:12px;margin-top:8px;flex-wrap:wrap}
  .heart{width:36px;height:36px;border-radius:10px;background:#f6f7fb;border:1px solid #e6e8f2;display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
  .heart svg{width:20px;height:20px;fill:none;stroke:#555;stroke-width:2}
  .heart.active{background:#ffe7ed;border-color:#ffd3de}
  .heart.active svg{fill:var(--heart);stroke:var(--heart)}

  /* Modals (above nav) */
  .modalbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:2000}
  .sheet{background:#fff;border-radius:12px;max-width:520px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
  .notifitem{padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;margin:8px 0}

  /* Error overlay */
  #errOv{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.55);z-index:3000}
  #errPanel{margin-top:24px;background:#fff;color:#111;border-radius:12px;max-width:900px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
  #errPanel pre{white-space:pre-wrap;overflow:auto;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;max-height:50vh}

  /* Toast */
  .toast{position:fixed;left:50%;bottom:90px;transform:translateX(-50%);background:#0ea5e9;color:#fff;padding:10px 14px;border-radius:10px;box-shadow:0 8px 20px rgba(0,0,0,.25);z-index:4000;animation:toastIn .2s ease}
  @keyframes toastIn{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}
  .jabbed{animation:jabshake .35s ease}
  @keyframes jabshake{
    0%{transform:translate(0,0)}
    25%{transform:translate(8px,-2px) rotate(2deg)}
    50%{transform:translate(-6px,2px) rotate(-2deg)}
    75%{transform:translate(4px,-1px) rotate(1deg)}
    100%{transform:translate(0,0)}
  }
</style>
</head>
<body class="ct">

<!-- ===== App Nav (global) ===== -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="friends.html">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a class="active" href="dating.html" aria-current="page">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a href="music.html">Music</a>
    <a href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- Topbar -->
<div class="topbar">
  <h2>Dating</h2>
  <div class="topactions">
    <button id="btnNotif" class="btn">Notifications</button>
    <button id="btnInbox" class="btn">Inbox</button>
    <button id="btnMsgs" class="btn">Messages</button>
    <img id="myProfile" class="avatar" title="My Profile" />
  </div>
</div>

<div class="page">
  <!-- Discover -->
  <section class="card" id="secDiscover">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
      <h3 style="margin:0">Discover</h3>
      <span class="muted">Swipe: ← Pass • → Like • ↑ Super Like</span>
    </div>
    <div class="deckwrap"><div id="deck" class="deck" aria-live="polite"></div></div>
    <div id="deckEmpty" class="muted" style="display:none;margin-top:8px">No profiles found. Tap “Reset profiles”.</div>

    <!-- Swipe buttons -->
    <div class="deckactions" id="deckActions">
      <button class="circle" id="actPass"  title="Pass" aria-label="Pass">
        <svg viewBox="0 0 24 24"><path d="M6 6l12 12M18 6L6 18" stroke="#475569" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      </button>
      <button class="circle" id="actSuper" title="Super Like" aria-label="Super Like">
        <svg viewBox="0 0 24 24"><path d="M12 2l3.1 6.4 7.1 1-5.1 5 1.3 7.1L12 18l-6.4 3.5 1.3-7.1-5.1-5 7.1-1L12 2z" fill="#7c3aed"/></svg>
      </button>
      <button class="circle" id="actLike"  title="Like" aria-label="Like">
        <svg viewBox="0 0 24 24"><path d="M12 21s-6.716-4.27-9.167-7.38C.63 11.154 1.57 7.9 3.985 6.54c1.75-1.01 4.005-.63 5.348.89L12 9.2l2.667-1.77c1.343-1.52 3.598-1.9 5.348-.89 2.414 1.36 3.354 4.614 1.152 7.08C18.716 16.73 12 21 12 21z" fill="#22c55e" stroke="#22c55e"/></svg>
      </button>
      <button class="circle" id="actJab"   title="Jab" aria-label="Jab">
        <svg viewBox="0 0 24 24"><path d="M3 12c0-2 1.5-3.5 3.5-3.5H8V7a2 2 0 1 1 4 0v1h.5V7a2 2 0 1 1 4 0v1h.5V7a2 2 0 1 1 4 0v4.8c0 2.2-1.8 4-4 4H11l-4 2v-2.6c-2-0.4-4-2.2-4-4.2z" fill="#0ea5e9"/></svg>
      </button>
      <button class="circle" id="actMsg"   title="Message" aria-label="Message">
        <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4v8z" fill="#64748b"/></svg>
      </button>
    </div>

    <div class="row" style="justify-content:flex-start;margin-top:8px">
      <button id="resetProfiles" class="btn ghost" style="flex:0 0 auto">Reset profiles</button>
    </div>
  </section>

  <!-- Tabs (Admin UI) -->
  <div class="tabs" id="tabs">
    <button class="tab active" data-tab="filters">Filters</button>
    <button class="tab" data-tab="feed">Dating Feed</button>
    <button class="tab" data-tab="matches">Matches</button>
    <button class="tab" data-tab="trending">Trending</button>
  </div>

  <div class="panes">
    <!-- Filters -->
    <section class="card pane active" id="tab-filters">
      <h3 style="margin:0 0 10px">Filters</h3>
      <div class="row">
        <select id="fGender">
          <option value="">Any gender</option><option>Female</option><option>Male</option><option>Non-binary</option>
        </select>
        <input id="fMinAge" type="number" min="18" max="100" value="18" placeholder="Min age">
        <input id="fMaxAge" type="number" min="18" max="100" value="99" placeholder="Max age">
        <button id="applyFilters" class="btn primary" style="flex:0 0 120px">Apply</button>
      </div>
    </section>

    <!-- Dating Feed -->
    <section class="card pane" id="tab-feed">
      <h3 style="margin:0 0 8px">Dating Feed</h3>
      <div class="row"><input id="pTitle" placeholder="Title (optional)"><select id="pAuthor"></select></div>
      <div class="row"><textarea id="pBody" placeholder="Share something with Dating…"></textarea></div>
      <div class="row"><input id="pMediaUrl" placeholder="Media URL (YouTube/image/video -- optional)"></div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <label style="display:flex;align-items:center;gap:8px"><input id="pShareMain" type="checkbox"> Also share to Main Feed</label>
        <div style="display:flex;gap:8px"><button id="btnPublish" class="btn primary">Publish</button><button id="btnClear" class="btn ghost">Clear</button></div>
      </div>
      <div id="postList"></div>
      <div id="postEmpty" class="muted" style="display:none;margin-top:8px">No posts yet — be the first!</div>
    </section>

    <!-- Matches -->
    <section class="card pane" id="tab-matches">
      <h3 style="margin:0 0 8px">Matches <span id="matchCount" class="btn ghost" style="padding:4px 10px">0</span></h3>
      <div id="matchList" style="display:flex;flex-direction:column;gap:10px"></div>
    </section>

    <!-- Trending -->
    <section class="card pane" id="tab-trending">
      <h3 style="margin:0 0 8px">Trending</h3>
      <div id="trendTags" class="chips"></div>
      <div id="trendPeople" style="margin-top:8px"></div>
    </section>
  </div>
</div>

<!-- Notifications / Inbox -->
<div class="modalbg" id="notifBg"><div class="sheet"><h3 style="margin:0 0 10px">Notifications</h3><div id="notifList"></div><button id="clearNotif" class="btn primary" style="margin-top:8px;">Clear</button><button id="closeNotif" class="btn" style="margin-top:8px;">Close</button></div></div>
<div class="modalbg" id="inboxBg"><div class="sheet"><h3 style="margin:0 0 10px">Inbox</h3><div id="inboxList"></div><button id="closeInbox" class="btn" style="margin-top:8px;">Close</button></div></div>

<!-- Error overlay -->
<div id="errOv"><div id="errPanel"><h3 style="margin:0 0 8px">⚠️ Script error</h3><p class="muted" style="margin:0 0 10px">Nothing will blank; details below so we can fix fast:</p><pre id="errText"></pre><div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px"><button class="btn" onclick="document.getElementById('errOv').style.display='none'">Close</button></div></div></div>

<script>
/* App-nav height → place blue bar underneath (same as stack) */
(function(){
  function setNavH(){
    var nav=document.querySelector('.app-nav');
    if(!nav) return;
    var h=Math.round(nav.getBoundingClientRect().height)||44;
    document.documentElement.style.setProperty('--navH', h+'px');
  }
  setNavH();
  window.addEventListener('resize', setNavH);
  window.addEventListener('orientationchange', setNavH);
  setTimeout(setNavH,120);
  setTimeout(setNavH,400);
})();
</script>

<script>
/* Error catcher */
(function(){ const show=(msg)=>{ const o=document.getElementById('errOv'); const t=document.getElementById('errText'); if(!o||!t) return; t.textContent=String(msg||'Unknown error'); o.style.display='flex'; }; window.addEventListener('error',e=>show(e.error? (e.error.stack||e.error.message||e.message) : e.message)); window.addEventListener('unhandledrejection',e=>show(e.reason && (e.reason.stack||e.reason.message||String(e.reason)))); })();

/* Helpers & storage */
const LS={ USERS:'ct_users_v3', PROFILE:'ct_profile_data_v1', VIEW:'ct_profile_view_v1', NOTIF:'ct_notifications_v1', INBOX:'ct_inbox_v1', D_PROFILES:'ct_dating_profiles_v2', D_INDEX:'ct_dating_index_v2', D_REWIND:'ct_dating_rewind_v2', D_LIKED_BY:'ct_dating_liked_by_v2', D_MATCH:'ct_dating_matches_v2', D_FEED:'ct_dating_posts_v2' };
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const load=(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;}}; 
const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
const uid=(p='id')=>`${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`, nowISO=()=>new Date().toISOString();
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
const face = n => `https://i.pravatar.cc/120?u=${encodeURIComponent(n)}`;
const photo = n => `https://picsum.photos/seed/${encodeURIComponent(n)}-p/1000/700`;

/* Seed users */
const NAMES = ["Grace Lee","Liam Adams","Ava Morgan","Noah Walker","Sophia Turner","Mason Hill","Emma Davis","Ethan Brooks","Olivia Perez","Logan Price","Mia Carter","Lucas Reed","Chloe Evans","Henry Scott","Amelia Ross","Elijah Gray","Isabella Wood","James Hall","Luna Kelly","Benjamin Ward","Aria King","Michael Reed","Kate White","Bill Thomas"];
(function seedUsers(){
  let users=load(LS.USERS,null);
  if(!users || !Array.isArray(users) || users.length<1){
    users=[{name:'Me',avatar:face('Me')}];
    NAMES.forEach(n=>users.push({name:n,avatar:face(n)}));
  }else{
    if(!users.find(u=>u.name==='Me')) users.unshift({name:'Me',avatar:face('Me')});
    NAMES.forEach(n=>{ if(!users.find(u=>u.name===n)) users.push({name:n,avatar:face(n)}); });
  }
  save(LS.USERS,users);
})();
const Users=load(LS.USERS,[]);
const getAvatarFor=name=> (load(LS.PROFILE,{}))[name]?.avatar || (Users.find(u=>u.name===name)?.avatar) || face(name);
function goToProfile(name){ try{localStorage.setItem(LS.VIEW,JSON.stringify({name}));}catch{} location.href='profile.html'; }
function addNotif(text){const arr=load(LS.NOTIF,[]);arr.unshift({id:uid('n'),text,time:nowISO()});save(LS.NOTIF,arr);} function addInbox(text){const arr=load(LS.INBOX,[]);arr.unshift({id:uid('m'),text,time:nowISO()});save(LS.INBOX,arr);}

/* Header */
(function(){
  const img=$('#myProfile'); const me=(load(LS.PROFILE,{}))['Me']||{};
  if(img){ img.src=me.avatar||face('Me'); img.alt=me.displayName?.trim()||'Me'; img.onclick=()=>goToProfile('Me'); }
  $('#btnMsgs')?.addEventListener('click',(e)=>{ e.preventDefault(); if(window.ctOpen) ctOpen(); else location.href='messages.html'; });

  document.addEventListener('click', (e) => {
    const a = e.target.closest && e.target.closest('a[href*="messages.html"]');
    if (a) { e.preventDefault(); if (window.ctOpen) ctOpen(); else location.href='messages.html'; }
  });

  const notifBg=$('#notifBg'), notifList=$('#notifList');
  function renderNotif(){ const arr=load(LS.NOTIF,[]); notifList.innerHTML=''; if(!arr.length){notifList.innerHTML='<div class="notifitem">No notifications yet.</div>';return;} arr.forEach(n=>{ const d=document.createElement('div'); d.className='notifitem'; d.innerHTML=`<strong>${new Date(n.time).toLocaleString()}</strong><br>${esc(n.text)}`; notifList.appendChild(d); });}
  $('#btnNotif')?.addEventListener('click',()=>{ renderNotif(); notifBg.style.display='flex'; });
  $('#clearNotif')?.addEventListener('click',()=>{ save(LS.NOTIF,[]); renderNotif(); });
  $('#closeNotif')?.addEventListener('click',()=>{ notifBg.style.display='none'; });

  const inboxBg=$('#inboxBg'), inboxList=$('#inboxList');
  function renderInbox(){ const arr=load(LS.INBOX,[]); inboxList.innerHTML=''; if(!arr.length){inboxList.innerHTML='<div class="notifitem">Inbox is empty.</div>';return;} arr.forEach(n=>{ const d=document.createElement('div'); d.className='notifitem'; d.innerHTML=`<strong>${new Date(n.time).toLocaleString()}</strong><br>${esc(n.text)}`; inboxList.appendChild(d); });}
  $('#btnInbox')?.addEventListener('click',()=>{ renderInbox(); inboxBg.style.display='flex'; });
  $('#closeInbox')?.addEventListener('click',()=>{ inboxBg.style.display='none'; });
})();

/* Profiles */
function synthProfile(u, i){
  const seed=(u.name||'').split('').reduce((a,c)=>a+c.charCodeAt(0),0) + i;
  const age=18+(seed%35);
  const genders=['Female','Male','Non-binary']; const gender=genders[seed%genders.length];
  const bio=`Hi, I'm ${u.name}. I enjoy music, movies, and good chats. Looking to connect.`;
  const tags=['music','movies','walking','cooking','gaming','art','travel','coffee','reading','outdoors'];
  const picks=[tags[seed%tags.length],tags[(seed+3)%tags.length],tags[(seed+6)%tags.length]];
  return {id:u.name,name:u.name,age,gender,bio,avatar:getAvatarFor(u.name),photos:[photo(u.name)],tags:picks};
}
function forceProfiles(){
  const base=Users.filter(u=>(u.name||'').toLowerCase()!=='me');
  const list=base.map((u,i)=>synthProfile(u,i));
  save(LS.D_PROFILES,list);
  return list;
}
let ALL=[], filtered=[], deckIndex=load(LS.D_INDEX,0), rewindStack=load(LS.D_REWIND,[]);
function ensureProfiles(){ let stored=load(LS.D_PROFILES,null); if(!stored || !Array.isArray(stored) || stored.length<6){ stored = forceProfiles(); } ALL = stored; }
function applyFilter(){ const g=$('#fGender').value; const min=+$('#fMinAge').value||18; const max=+$('#fMaxAge').value||99; filtered=(ALL||[]).filter(p=>(!g||p.gender===g)&&p.age>=min&&p.age<=max); if(deckIndex>=filtered.length) deckIndex=0; save(LS.D_INDEX,deckIndex); $('#deckEmpty').style.display=filtered.length?'none':'block'; }
function renderDeck(){
  const deck=$('#deck'); deck.innerHTML=''; if(!filtered.length){ $('#deckEmpty').style.display='block'; return; }
  for(let i=0;i<3;i++){
    const p=filtered[(deckIndex+i)%filtered.length]; if(!p) break;
    const el=document.createElement('div'); el.className='person'; el.style.transform=`translateY(${i*6}px) scale(${1-i*0.02})`; el.dataset.user=p.id;
    el.innerHTML=`
      <div class="cover"><img src="${esc(p.photos[0])}" alt="${esc(p.name)}"/>
        <div class="badge like" style="display:none">LIKE</div>
        <div class="badge pass" style="display:none">PASS</div>
        <div class="badge super" style="display:none">SUPER</div>
      </div>
      <div class="info">
        <div class="name">${esc(p.name)}, ${p.age} <span class="muted" style="font-size:.95rem">• ${esc(p.gender)}</span></div>
        <div class="bio">${esc(p.bio)}</div>
        <div class="chips">${p.tags.map(t=>`<span class="chip">#${esc(t)}</span>`).join('')}</div>
      </div>`;
    if(i===0) attachGesture(el,p); deck.appendChild(el);
  }
}
function attachGesture(cardEl,p){
  let sx=0,sy=0,dx=0,dy=0,drag=false;
  const like=cardEl.querySelector('.badge.like'), pass=cardEl.querySelector('.badge.pass'), sup=cardEl.querySelector('.badge.super');
  function down(e){ drag=true; const t=('touches'in e)?e.touches[0]:e; sx=t.clientX; sy=t.clientY; dx=dy=0; cardEl.style.transition='none'; }
  function move(e){ if(!drag) return; const t=('touches'in e)?e.touches[0]:e; dx=t.clientX-sx; dy=t.clientY-sy; const rot=Math.max(-20,Math.min(20,dx/10));
    cardEl.style.transform=`translate(${dx}px,${dy}px) rotate(${rot}deg)`; const ax=Math.abs(dx), ay=Math.abs(dy);
    like.style.display=(dx>40&&ax>ay)?'block':'none'; pass.style.display=(dx<-40&&ax>ay)?'block':'none'; sup.style.display=(dy<-60&&ay>ax)?'block':'none'; }
  function up(){ if(!drag) return; drag=false; const THX=110, THY=110;
    if(dx>THX) act('like'); else if(dx<-THX) act('pass'); else if(dy<-THY) act('super');
    else { cardEl.style.transition='transform .2s ease'; cardEl.style.transform='translate(0,0)'; like.style.display=pass.style.display=sup.style.display='none'; }
  }
  function act(kind){
    cardEl.style.transition='transform .25s ease';
    if(kind==='like') cardEl.style.transform='translate(600px,-20px) rotate(18deg)';
    if(kind==='pass') cardEl.style.transform='translate(-600px,-20px) rotate(-18deg)';
    if(kind==='super') cardEl.style.transform='translate(0,-700px)';
    setTimeout(()=>{ rewindStack.unshift({id:p.id,kind,time:nowISO()}); save(LS.D_REWIND,rewindStack.slice(0,10));
      if(kind!=='pass') likeUser(p.id,kind==='super'); deckIndex=(deckIndex+1)%(filtered.length||1); save(LS.D_INDEX,deckIndex); renderDeck(); renderMatches(); },180);
  }
  cardEl.addEventListener('pointerdown',down); window.addEventListener('pointermove',move,{passive:false}); window.addEventListener('pointerup',up);
  cardEl.addEventListener('touchstart',down,{passive:true}); cardEl.addEventListener('touchmove',move,{passive:false}); cardEl.addEventListener('touchend',up);
}

/* Likes / matches */
const getMatches=()=>load(LS.D_MATCH,[]), setMatches=a=>save(LS.D_MATCH,a);
const getLikedBy=()=>load(LS.D_LIKED_BY,{}), setLikedBy=m=>save(LS.D_LIKED_BY,m);
function likeUser(id,superLike=false){
  const LB=getLikedBy(); const s=new Set(LB[id]||[]); if(s.size===0&&Math.random()<0.35) s.add('Me'); LB[id]=Array.from(s); setLikedBy(LB);
  if((LB[id]||[]).includes('Me')){ const ms=getMatches(); if(!ms.find(m=>m.userId===id)){ ms.unshift({id:uid('match'),userId:id,time:nowISO(),superLike}); setMatches(ms); addNotif(`It's a match! You and ${id} like each other.`); addInbox(`Match made with ${id}.`);} return true;} return false;
}

/* Jab */
function jabUser(id){
  const K='ct_jabs_sent_v2';
  const sent=load(K,{});
  const arr=sent[id]||[];
  const now=Date.now();
  const cooldownMs=60*1000;
  const ok=!arr.length || (now - new Date(arr[0]).getTime()) > cooldownMs;
  if(!ok) return false;
  arr.unshift(nowISO());
  sent[id]=arr.slice(0,5);
  save(K,sent);
  addNotif(`You poked ${id}.`);
  addInbox(`Jab sent to ${id}.`);
  return true;
}
const current=()=> filtered[deckIndex] || null;

/* Toast + wiggle */
function toast(msg){
  const t=document.createElement('div'); t.className='toast'; t.textContent=msg;
  document.body.appendChild(t);
  setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity .2s'; setTimeout(()=>t.remove(),220); },1400);
}
function wiggleTopCard(){
  const top=$('#deck')?.firstElementChild;
  if(!top) return;
  top.classList.add('jabbed');
  setTimeout(()=>top.classList.remove('jabbed'),380);
}

/* Visible action buttons */
$('#actPass')  ?.addEventListener('click',()=>{ deckIndex=(deckIndex+1)%(filtered.length||1); save(LS.D_INDEX,deckIndex); renderDeck(); });
$('#actLike')  ?.addEventListener('click',()=>{ const p=current(); if(!p) return; likeUser(p.id,false); deckIndex=(deckIndex+1)%(filtered.length||1); save(LS.D_INDEX,deckIndex); renderDeck(); renderMatches(); });
$('#actSuper') ?.addEventListener('click',()=>{ const p=current(); if(!p) return; likeUser(p.id,true); deckIndex=(deckIndex+1)%(filtered.length||1); save(LS.D_INDEX,deckIndex); renderDeck(); renderMatches(); });
$('#actJab')   ?.addEventListener('click',()=>{ const p=current(); if(!p) return; const ok=jabUser(p.id); wiggleTopCard(); toast(ok?`You poked ${p.id} □`:`You poked recently — try again soon`); });
$('#actMsg')   ?.addEventListener('click',()=>{ window.ctMessage ? ctMessage(current()?.id || '') : (location.href='messages.html'); });

/* Filters + reset */
$('#applyFilters')?.addEventListener('click',()=>{ applyFilter(); renderDeck(); });
$('#resetProfiles')?.addEventListener('click',()=>{ forceProfiles(); ensureProfiles(); applyFilter(); renderDeck(); });

/* Matches */
function renderMatches(){ const list=getMatches(); $('#matchCount').textContent=String(list.length); const box=$('#matchList'); box.innerHTML='';
  if(!list.length){ box.innerHTML='<div class="muted">No matches yet. Keep swiping!</div>'; return; }
  list.forEach(m=>{ const name=m.userId; const row=document.createElement('div'); row.style.cssText='display:flex;align-items:center;gap:12px;padding:12px;border:1px solid #ececec;border-radius:12px;background:#fafafa';
    row.innerHTML=`<img src="${esc(getAvatarFor(name))}" alt="${esc(name)}" style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid #fff">
      <div style="flex:1"><div style="font-weight:700">${esc(name)}</div><div class="muted" style="font-size:.95rem">${new Date(m.time).toLocaleString()} ${m.superLike?'• Super Like ⭐':''}</div></div>
      <button class="btn ghost" data-profile="${esc(name)}">Profile</button>
      <button class="btn primary" data-message="${esc(name)}">Message</button>`;
    row.querySelector('[data-profile]').onclick=()=>goToProfile(name);
    row.querySelector('[data-message]').onclick=()=>{ window.ctMessage ? ctMessage(name) : (location.href='messages.html'); };
    box.appendChild(row); });
}

/* Dating Feed (local) */
const ensurePostShape=p=>({ id:p.id||uid('dp'), title:p.title||'', content:p.content||'', authorName:p.authorName||'Me', createdAt:p.createdAt||nowISO(), updatedAt:p.updatedAt||p.createdAt||nowISO(), media:p.media||null, tags:Array.isArray(p.tags)?p.tags:[], likes:Array.isArray(p.likes)?Array.from(new Set(p.likes)):[], shares:Number.isFinite(p.shares)?p.shares:0 });
const getFeed=()=> (load(LS.D_FEED,[])||[]).map(ensurePostShape);
const setFeed=arr=> save(LS.D_FEED,arr.map(ensurePostShape));
function toYouTubeEmbed(url){ try{ const u=new URL(url); const host=u.hostname.replace(/^www\./,'').replace(/^m\./,''); let id=''; if(host==='youtu.be'){ id=u.pathname.split('/')[1]||''; } else if(host.endsWith('youtube.com')){ if(u.pathname==='/watch') id=u.searchParams.get('v')||''; else id=(u.pathname.split('/')[2]||''); } if(!id) return null; return `https://www.youtube.com/embed/${encodeURIComponent(id)}?rel=0&modestbranding=1&playsinline=1`; }catch{ return null; } }
function detectMedia(url){ if(!url) return null; try{ new URL(url); }catch{ return null; } const yt=toYouTubeEmbed(url); const lower=url.toLowerCase(); if(yt) return {type:'embed',src:yt,allow:"accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"}; if(/\.(png|jpg|jpeg|gif|webp)(\?|$)/.test(lower)) return {type:'image',src:url}; if(/\.(mp4|webm|ogg|ogv|mov|m4v)(\?|$)/.test(lower)) return {type:'video',src:url}; return {type:'link',src:url}; }
function heartBtn(active){ const b=document.createElement('button'); b.className='heart'; if(active) b.classList.add('active'); b.innerHTML=`<svg viewBox="0 0 24 24"><path d="M12 21s-6.716-4.27-9.167-7.38C.63 11.154 1.57 7.9 3.985 6.54c1.75-1.01 4.005-.63 5.348.89L12 9.2l2.667-1.77c1.343-1.52 3.598-1.9 5.348-.89 2.414 1.36 3.354 4.614 1.152 7.08C18.716 16.73 12 21 12 21z"/></svg>`; return b; }
function renderTrending(list){ const tagCounts={}; (list||[]).forEach(p=> (p.tags||[]).forEach(t=> tagCounts[t]=(tagCounts[t]||0)+1 )); const top=Object.entries(tagCounts).sort((a,b)=>b[1]-a[1]).slice(0,8);
  document.getElementById('trendTags').innerHTML = top.length? top.map(([t,c])=>`<span class="chip">#${esc(t)} <span class="btn ghost" style="padding:2px 8px;margin-left:6px">${c}</span></span>`).join('') : '<span class="muted">No tags yet.</span>';
  const m=getMatches(); const people=m.map(x=>x.userId);
  document.getElementById('trendPeople').innerHTML = people.length? people.map(n=>`<div style="display:flex;align-items:center;gap:10px;margin-top:8px"><img src="${esc(getAvatarFor(n))}" style="width:36px;height:36px;border-radius:50%"><div>${esc(n)}</div></div>`).join('') : '<div class="muted">No popular profiles yet.</div>';
}
function postRow(p){
  const wrap=document.createElement('div'); wrap.className='item'; wrap.dataset.id=p.id;
  const ava=document.createElement('img'); ava.className='ava'; ava.src=getAvatarFor(p.authorName||'Me'); ava.alt=p.authorName||'Me'; ava.setAttribute('data-profile-name', p.authorName||'Me');
  const info=document.createElement('div'); info.style.flex='1'; info.style.minWidth='0';
  const title=document.createElement('div'); title.className='ptitle'; title.textContent=p.title||''; if(!p.title) title.style.display='none';
  const meta=document.createElement('div'); meta.className='meta'; meta.textContent=`${p.authorName} • ${new Date(p.createdAt).toLocaleString()}`;
  const body=document.createElement('div'); body.textContent=p.content||'';
  const mediaBox=document.createElement('div'); if(p.media){ if(p.media.type==='image') mediaBox.innerHTML=`<div class="media"><img src="${esc(p.media.src)}" style="width:100%"></div>`;
    else if(p.media.type==='video') mediaBox.innerHTML=`<div class="media"><video controls src="${esc(p.media.src)}" style="width:100%"></video></div>`;
    else if(p.media.type==='embed') mediaBox.innerHTML=`<div class="media"><iframe src="${esc(p.media.src)}" allow="${p.media.allow||''}" frameborder="0" allowfullscreen style="width:100%"></iframe></div>`;
    else mediaBox.innerHTML=`<div class="media"><a href="${esc(p.media.src)}" target="_blank" style="display:block;padding:12px">${esc(p.media.src)}</a></div>`; }
  const util=document.createElement('div'); util.className='util';
  const actor=()=>document.querySelector('#pAuthor').value||'Me'; p.likes=p.likes||[]; const btn=heartBtn(p.likes.includes(actor())); const cnt=document.createElement('span'); cnt.textContent=String(p.likes.length);
  btn.onclick=()=>{ const who=actor(); const set=new Set(p.likes); set.has(who)?set.delete(who):set.add(who); p.likes=Array.from(set); update(p.id,{likes:p.likes}); btn.classList.toggle('active',set.has(who)); cnt.textContent=String(set.size); };
  util.appendChild(btn); util.append(' Like • ',cnt);
  info.append(title,meta,body,mediaBox,util); wrap.append(ava,info); return wrap;
}
function update(id,patch){ const list=getFeed(); const i=list.findIndex(x=>x.id===id); if(i>-1){ list[i]={...list[i],...patch,updatedAt:nowISO()}; setFeed(list); } }
function renderFeed(){ const list=getFeed().sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)); const box=document.getElementById('postList'); box.innerHTML=''; if(!list.length){ document.getElementById('postEmpty').style.display='block'; return; } document.getElementById('postEmpty').style.display='none'; list.forEach(p=> box.appendChild(postRow(p))); }
document.getElementById('btnPublish')?.addEventListener('click',()=>{ const title=document.getElementById('pTitle').value.trim(); const content=document.getElementById('pBody').value.trim(); const author=document.getElementById('pAuthor').value||'Me'; const url=document.getElementById('pMediaUrl').value.trim(); let media=url?detectMedia(url):null; if(!content && !title && !media){ alert('Write something or add media.'); return; } const p={id:uid('dp'),title,content,authorName:author,createdAt:nowISO(),updatedAt:nowISO(),media,tags:[],likes:[]}; const list=getFeed(); list.unshift(p); setFeed(list); ['#pTitle','#pBody','#pMediaUrl'].forEach(s=>document.querySelector(s).value=''); renderFeed(); addNotif(`${author} posted${title?` “${title}”`:''}.`); });
document.getElementById('btnClear')?.addEventListener('click',()=>{ ['#pTitle','#pBody','#pMediaUrl'].forEach(s=>document.querySelector(s).value=''); });

/* Tabs */
document.getElementById('tabs')?.addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  const name=t.dataset.tab;
  document.querySelectorAll('.tab').forEach(b=>b.classList.toggle('active',b===t));
  document.querySelectorAll('.pane').forEach(p=>p.classList.toggle('active',p.id===`tab-${name}`));
});

/* Boot */
(function boot(){
  const authorSel=document.getElementById('pAuthor'); (Users||[{name:'Me'}]).forEach(u=>{ const o=document.createElement('option'); o.value=u.name; o.textContent=u.name; authorSel.appendChild(o); }); authorSel.value='Me';
  ensureProfiles(); applyFilter(); renderDeck(); renderMatches(); renderFeed(); renderTrending(getFeed());
})();
</script>

<!-- ===== Inline Messages Overlay (footer – no external files) ===== -->
<script>
/* (unchanged overlay; sits above nav with z-index 4000) */
(function () {
  "use strict";
  const LS = { USERS: "ct_users_v3", THREADS: "ct_threads_v4" };
  const load = (k, f) => { try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : f; } catch { return f; } };
  const save = (k, v) => { try { localStorage.setItem(k, JSON.stringify(v)); } catch {} };
  const uid  = (p = "id") => `${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`;
  const now  = () => Date.now();
  const face = (u) => `https://i.pravatar.cc/100?u=${encodeURIComponent(u || "chatternet")}`;
  const FALLBACK = "data:image/svg+xml;utf8," + encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='96' height='96'><rect width='96' height='96' fill='#e5e7eb'/><circle cx='48' cy='36' r='16' fill='#cbd5e1'/><rect x='20' y='60' width='56' height='20' rx='10' fill='#cbd5e1'/></svg>");

  (function seed() {
    let users = load(LS.USERS, null);
    if (!users) users = [{ name: "Me", avatar: face("me") }, { name: "Echo Bot", avatar: face("echobot") }];
    if (!users.find(u => u.name === "Me")) users.unshift({ name: "Me", avatar: face("me") });
    if (!users.find(u => u.name === "Echo Bot")) users.push({ name: "Echo Bot", avatar: face("echobot") });
    save(LS.USERS, users);

    let threads = load(LS.THREADS, null);
    if (!threads) {
      threads = [{ id: "t_echo", name: "Echo Bot", avatar: face("echobot"),
        messages: [{ id: uid("m"), from: "Echo Bot", text: "Hi! I repeat what you say □", time: now() }] }];
      save(LS.THREADS, threads);
    }
  })();

  const CSS = `
#ctMessengerRoot{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:4000;align-items:center;justify-content:center}
#ctMessenger{background:#fff;width:min(1000px,96vw);max-height:86vh;border-radius:14px;overflow:hidden;box-shadow:0 12px 40px rgba(0,0,0,.3);display:flex}
#ctM_left{width:290px;border-right:1px solid #e5e7eb;background:#fafafa;display:flex;flex-direction:column}
#ctM_left h3{margin:0;padding:12px 14px;font-size:16px;border-bottom:1px solid #e5e7eb}
#ctThreads{overflow:auto}
.ctRow{display:flex;gap:10px;align-items:center;padding:10px 12px;cursor:pointer;border-bottom:1px solid #f1f5f9;background:#fff}
.ctRow:hover{background:#f8fafc}
.ctRow.active{background:#eef4ff}
.ctRow img{width:34px;height:34px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb}
#ctM_right{flex:1;display:flex;flex-direction:column}
#ctHead{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid #e5e7eb}
#ctMsgs{flex:1;overflow:auto;padding:12px;background:#f8fafc}
.ctMsg{max-width:70%;padding:10px 12px;border-radius:12px;border:1px solid #e5e7eb;background:#fff;margin:6px 0}
.ctMe{margin-left:auto;background:#e6f2ff;border-color:#d7e8ff}
#ctComposer{display:flex;gap:8px;padding:12px;border-top:1px solid #e5e7eb;background:#fff}
#ctInput{flex:1;padding:10px 12px;border:1px solid #cbd5e1;border-radius:10px}
#ctSend{padding:10px 14px;border:1px solid #2f86d8;background:#2f86d8;color:#fff;border-radius:10px;cursor:pointer}
#ctFloat{position:fixed;right:16px;bottom:16px;width:54px;height:54px;border-radius:50%;display:flex;align-items:center;justify-content:center;background:#2f86d8;color:#fff;font-size:22px;cursor:pointer;box-shadow:0 10px 20px rgba(0,0,0,.25);z-index:3000}`;
  function ensureRoot() {
    if (document.getElementById("ctMessengerRoot")) return;
    const st = document.createElement("style"); st.textContent = CSS; document.head.appendChild(st);
    const root = document.createElement("div");
    root.id = "ctMessengerRoot";
    root.innerHTML = `
      <div id="ctMessenger" role="dialog" aria-modal="true" aria-label="Messages">
        <div id="ctM_left">
          <h3 style="display:flex;align-items:center;justify-content:space-between">Messages
            <button id="ctClose" class="btn" style="border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:6px 10px;cursor:pointer">Close</button>
          </h3>
          <div id="ctThreads"></div>
        </div>
        <div id="ctM_right">
          <div id="ctHead"><div id="ctWho">—</div></div>
          <div id="ctMsgs"></div>
          <div id="ctComposer">
            <input id="ctInput" placeholder="Write a message…" />
            <button id="ctSend">Send</button>
          </div>
        </div>
      </div>`;
    document.body.appendChild(root);
    document.getElementById("ctClose").onclick = hide;
    document.getElementById("ctSend").onclick = send;
    document.getElementById("ctInput").addEventListener("keydown", (e) => e.key === "Enter" && send());
  }

  function users() { return load(LS.USERS, []); }
  function threads(){ return load(LS.THREADS, []); }
  function saveThreads(t){ save(LS.THREADS, t); }
  const faceFor = (n) => `https://i.pravatar.cc/100?u=${encodeURIComponent(n||"user")}`;

  function threadByName(name){
    const n = String(name||"").toLowerCase();
    return (threads() || []).find(t => (t.name||"").toLowerCase() === n) || null;
  }
  function createThreadFor(name){
    const clean = String(name||"").trim();
    if (!clean) return null;
    const list = threads();
    const t = { id: uid("t"), name: clean, avatar: faceFor(clean), messages: [] };
    list.unshift(t); saveThreads(list);
    return t;
  }
  function sortByRecent(list){
    return (list||[]).slice().sort((a,b) => {
      const at = (a.messages?.length ? a.messages[a.messages.length-1].time : 0);
      const bt = (b.messages?.length ? b.messages[b.messages.length-1].time : 0);
      return bt - at;
    });
  }

  let CURRENT = null;
  function ensureAva(el, name){ if(!el) return; el.src = faceFor(name); el.onerror = () => { el.onerror=null; el.src = FALLBACK; }; }

  function renderThreads(activeId) {
    const box = document.getElementById("ctThreads");
    const list = sortByRecent(threads());
    box.innerHTML = "";
    list.forEach((t) => {
      const row = document.createElement("div");
      row.className = "ctRow" + (t.id === activeId ? " active" : "");
      row.innerHTML = `<img alt=""><div style="flex:1;min-width:0">
          <div style="font-weight:700">${t.name || "Thread"}</div>
          <div style="font-size:12px;color:#64748b;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">
            ${(t.messages?.slice(-1)[0]?.text || "").toString()}
          </div>
        </div>`;
      ensureAva(row.querySelector("img"), t.name);
      row.onclick = () => openThread(t.id);
      box.appendChild(row);
    });
  }
  function renderMessages() {
    const t = threads().find((x) => x.id === CURRENT);
    const box = document.getElementById("ctMsgs");
    const who = document.getElementById("ctWho");
    box.innerHTML = "";
    who.textContent = t ? t.name : "—";
    (t?.messages || []).forEach((m) => {
      const el = document.createElement("div");
      el.className = "ctMsg" + (m.from === "Me" ? " ctMe" : "");
      el.textContent = m.text;
      box.appendChild(el);
    });
    box.scrollTop = box.scrollHeight;
  }

  function openThread(id) {
    ensureRoot();
    CURRENT = id;
    renderThreads(id);
    renderMessages();
    show();
    setTimeout(() => document.getElementById("ctInput")?.focus(), 0);
  }
  function openByName(name) {
    ensureRoot();
    const t = threadByName(name) || createThreadFor(name) || null;
    if (t) openThread(t.id); else openDefault();
  }

  function send() {
    const input = document.getElementById("ctInput");
    const text = (input?.value || "").trim();
    if (!text || !CURRENT) return;
    input.value = "";

    const list = threads();
    const t = list.find((x) => x.id === CURRENT);
    if (!t) return;

    (t.messages ||= []).push({ id: uid("m"), from: "Me", text, time: now() });
    if (/echo/i.test(t.name || "")) {
      t.messages.push({ id: uid("m"), from: "Echo Bot", text, time: now() + 200 });
    }
    saveThreads(sortByRecent(list));
    renderThreads(CURRENT);
    renderMessages();
  }

  function show(){ ensureRoot(); document.getElementById("ctMessengerRoot").style.display = "flex"; }
  function hide(){ const r = document.getElementById("ctMessengerRoot"); if (r) r.style.display = "none"; }
  function openDefault() {
    const list = threads();
    if (list.length) openThread(sortByRecent(list)[0].id);
    else {
      const t = { id: uid("t"), name: "Echo Bot", avatar: faceFor("echobot"), messages: [] };
      const all = threads(); all.unshift(t); saveThreads(all); openThread(t.id);
    }
  }

  function attachTriggers() {
    const hdr = document.getElementById("btnMsgs");
    if (hdr) hdr.addEventListener("click", (e) => { e.preventDefault?.(); e.stopPropagation?.(); openDefault(); });

    if (!hdr && !document.getElementById("ctFloat")) {
      const b = document.createElement("div");
      b.id = "ctFloat"; b.title = "Messages"; b.textContent = "□";
      b.onclick = () => openDefault();
      document.body.appendChild(b);
    }
  }
  document.addEventListener("click", function(e){
    const t = e.target;
    const link = t.closest && t.closest('a[href*="messages.html"]');
    const msgTo = t.closest && t.closest('[data-ct-message-name]');
    if (link) {
      e.preventDefault && e.preventDefault();
      e.stopPropagation && e.stopPropagation();
      e.stopImmediatePropagation && e.stopImmediatePropagation();
      openDefault();
      return;
    }
    if (msgTo) {
      const name = msgTo.getAttribute("data-ct-message-name") || "";
      if (name) {
        e.preventDefault && e.preventDefault();
        e.stopPropagation && e.stopPropagation();
        e.stopImmediatePropagation && e.stopImmediatePropagation();
        openByName(name);
      }
    }
  }, true);

  window.ctOpen    = openDefault;
  window.ctMessage = function(name){ if (name) openByName(name); else openDefault(); };

  if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", attachTriggers);
  else attachTriggers();
})();
</script>
</body>
</html>
