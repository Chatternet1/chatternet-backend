<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Chatternet — Settings (Persistent)</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --brand:#3498db;--brand-2:#2980b9;--bg:#f0f2f5;--card:#fff;--ink:#0f172a;--muted:#667085;--line:#e6eaf2;
    --bad:#b91c1c;--ok:#0f766e;--warn:#b45309
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 'Segoe UI',Arial,sans-serif}
  a{color:inherit;text-decoration:none}

  /* Top bar */
  .top-bar{position:sticky;top:0;z-index:40;display:flex;justify-content:space-between;align-items:center;padding:10px 14px;background:var(--brand);color:#fff;box-shadow:0 2px 8px rgba(0,0,0,.2)}
  .top-bar h2{margin:0;font-weight:800;letter-spacing:.2px}
  .top-actions{display:flex;gap:8px;align-items:center}
  .top-actions button{background:#fff;color:#000;border:none;padding:8px 10px;border-radius:10px;cursor:pointer}
  .top-actions button:hover{background:#eef4ff}
  .top-actions img{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.85);cursor:pointer;object-fit:cover}

  /* Layout */
  .page{max-width:1100px;margin:18px auto;padding:0 12px 28px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin:0 0 12px}
  .tab{padding:8px 12px;border:1px solid #dfe3f0;border-radius:999px;background:#fff;cursor:pointer;font-weight:700;user-select:none}
  .tab.active{background:#e9f2ff;border-color:#cfe1ff}
  .card{background:var(--card);border:1px solid rgba(0,0,0,.08);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.08);padding:14px;margin:14px 0}
  .section-title{font-size:22px;font-weight:800;margin:0 0 10px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center}
  .row>*{flex:1}
  input,select,textarea,button{font-family:'Segoe UI',Arial,sans-serif}
  input,select,textarea{width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:10px;font-size:14px;background:#fff}
  select{cursor:pointer}
  textarea{resize:vertical;min-height:90px}
  .btn{padding:10px 14px;border:1px solid #d7d7d7;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-2)}
  .btn.ghost{background:#f6f9ff;border-color:#e5edff}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .pill{display:inline-block;padding:4px 8px;border:1px solid #d7d7d7;border-radius:999px;background:#f8fafc;font-size:12px;margin-right:6px}
  .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}
  .grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
  @media (max-width:900px){.grid2,.grid3{grid-template-columns:1fr}}
  .small{font-size:12px}
  .kbd{font-family:ui-monospace, Menlo, Consolas, monospace;background:#f1f5f9;border:1px solid #e2e8f0;border-radius:6px;padding:2px 6px}
  .flex-col{display:flex;flex-direction:column;gap:8px}
  .list{display:flex;flex-direction:column;gap:6px}
  .codebox{background:#f8fafc;border:1px dashed #d7d7d7;border-radius:10px;padding:10px;word-break:break-all}
  .hint{font-size:12px;color:#475569}

  /* tiny toast */
  #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:5000}
  #toast.show{opacity:1}

  /* Error overlay */
  #errOverlay{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.55);z-index:3000}
  #errPanel{margin-top:24px;background:#fff;color:#111;border-radius:12px;max-width:900px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
  #errPanel pre{white-space:pre-wrap;overflow:auto;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;max-height:50vh}

  /* Simple modals */
  .modalbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:3500}
  .sheet{background:#fff;border-radius:14px;max-width:520px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 18px 50px rgba(0,0,0,.3);padding:16px}
  .notifitem{padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;margin:8px 0}
</style>
</head>
<body>

<!-- Header -->
<div class="top-bar">
  <h2>Settings</h2>
  <div class="top-actions">
    <button id="btnNotif">Notifications</button>
    <button id="btnInbox">Inbox</button>
    <button id="btnMsgs">Messages</button>
    <img id="myProfile" title="My Profile" />
  </div>
</div>

<!-- Notifications / Inbox Modals -->
<div class="modalbg" id="notifModal">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="row" style="margin-top:8px">
      <button id="clearNotif" class="btn primary">Clear</button>
      <button id="closeNotif" class="btn">Close</button>
    </div>
  </div>
</div>

<div class="modalbg" id="inboxModal">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="row" style="margin-top:8px">
      <button id="closeInbox" class="btn">Close</button>
    </div>
  </div>
</div>

<div class="page">
  <div class="tabs" id="tabsBar">
    <div class="tab active" data-tab="account">Account</div>
    <div class="tab" data-tab="security">Security</div>
    <div class="tab" data-tab="notifications">Notifications</div>
    <div class="tab" data-tab="privacy">Privacy</div>
    <div class="tab" data-tab="monetization">Monetization</div>
    <div class="tab" data-tab="tools">Data Tools</div>
  </div>

  <!-- ACCOUNT -->
  <section class="card panel" id="panel-account">
    <h3 class="section-title">Account</h3>
    <div class="grid2">
      <div>
        <label class="small muted">Display name</label>
        <input id="dName" placeholder="Your name">
      </div>
      <div>
        <label class="small muted">Default actor (who you post as)</label>
        <select id="actorSel"></select>
      </div>
    </div>
    <div style="margin-top:8px">
      <label class="small muted">Bio</label>
      <textarea id="dBio" placeholder="Tell people about you…"></textarea>
    </div>
    <div class="grid2" style="margin-top:8px">
      <div>
        <label class="small muted">Avatar URL</label>
        <input id="dAvatarUrl" placeholder="https://">
        <div class="row" style="margin-top:6px">
          <input type="file" id="dAvatarFile" accept="image/*">
          <button class="btn" id="btnUseAvatar">Use uploaded</button>
        </div>
      </div>
      <div>
        <label class="small muted">Cover URL</label>
        <input id="dCoverUrl" placeholder="https://">
        <div class="row" style="margin-top:6px">
          <input type="file" id="dCoverFile" accept="image/*">
          <button class="btn" id="btnUseCover">Use uploaded</button>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:10px;flex-wrap:wrap">
      <button class="btn primary" id="btnSaveProfile">Save profile</button>
      <button class="btn" id="btnViewProfile">Open Profile</button>
      <span class="pill" id="statPosts">0 Posts</span>
      <span class="pill" id="statMedia">0 Media</span>
      <span class="pill" id="statFriends">0 Friends</span>
    </div>
  </section>

  <!-- SECURITY -->
  <section class="card panel" id="panel-security" style="display:none">
    <h3 class="section-title">Security</h3>
    <div class="card" style="margin:8px 0">
      <div class="grid2">
        <div>
          <label class="small muted">Primary email</label>
          <input id="secEmail" type="email" placeholder="you@example.com">
          <div class="hint">Used for recovery + notifications (if enabled).</div>
        </div>
        <div class="flex-col">
          <div><span id="emailStatus" class="pill muted">Not set</span></div>
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" id="btnSaveEmail">Save</button>
            <button class="btn ghost" id="btnSendCode">Send verify code</button>
            <input id="codeInput" placeholder="Enter 6-digit code">
            <button class="btn primary" id="btnVerifyCode">Verify</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:10px">
        <div>
          <label class="small muted">Phone number (E.164)</label>
          <input id="secPhone" placeholder="+447700900123">
          <div class="hint">Optional, used for password resets and login alerts.</div>
        </div>
        <div class="flex-col">
          <div><span id="phoneStatus" class="pill muted">Not set</span></div>
          <div class="row" style="flex-wrap:wrap">
            <button class="btn" id="btnSavePhone">Save</button>
            <button class="btn ghost" id="btnSendPhoneCode">Send SMS code</button>
            <input id="phoneCodeInput" placeholder="6-digit">
            <button class="btn primary" id="btnVerifyPhone">Verify</button>
          </div>
        </div>
      </div>
    </div>

    <div class="card" style="margin:8px 0">
      <strong>Password</strong>
      <div class="grid3" style="margin-top:6px">
        <input id="pwCurrent" type="password" placeholder="Current password">
        <input id="pwNew" type="password" placeholder="New password (8+ chars)">
        <input id="pwNew2" type="password" placeholder="Confirm new password">
      </div>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <button class="btn primary" id="btnChangePw">Change password</button>
        <button class="btn" id="btnSendReset">Send reset code</button>
        <input id="pwResetCode" placeholder="Reset code">
        <button class="btn ghost" id="btnApplyReset">Apply reset</button>
      </div>
      <div id="pwHint" class="hint" style="margin-top:6px">If your site has <span class="kbd">auth.js</span>, we use it. Otherwise this protects your local device only.</div>
    </div>

    <div class="card" style="margin:8px 0">
      <div class="row" style="align-items:center;justify-content:space-between">
        <div>
          <strong>Two-Step Verification (email codes)</strong>
          <div class="hint">On login, require a code sent to your email or one of your backup codes.</div>
        </div>
        <label style="display:flex;align-items:center;gap:8px">
          <input type="checkbox" id="twoFA" style="width:auto"> Enable
        </label>
      </div>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="btnGenBackups">Generate backup codes</button>
        <button class="btn ghost" id="btnShowBackups">Show backup codes</button>
        <button class="btn danger" id="btnRevokeBackups">Revoke backup codes</button>
      </div>
      <div id="backupBox" class="codebox small" style="display:none;margin-top:8px"></div>
    </div>
  </section>

  <!-- NOTIFICATIONS -->
  <section class="card panel" id="panel-notifications" style="display:none">
    <h3 class="section-title">Notifications</h3>
    <div class="grid3">
      <label style="display:flex;align-items:center;gap:8px"><input id="nDM" type="checkbox" style="width:auto"> Direct messages</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="nComments" type="checkbox" style="width:auto"> Comments & replies</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="nLikes" type="checkbox" style="width:auto"> Likes</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="nFollows" type="checkbox" style="width:auto"> New followers</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="nBlogs" type="checkbox" style="width:auto"> Blog activity</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="nPolls" type="checkbox" style="width:auto"> Poll activity</label>
    </div>
    <div class="grid2" style="margin-top:10px">
      <div>
        <strong>Channels</strong>
        <div class="flex-col" style="margin-top:6px">
          <label style="display:flex;align-items:center;gap:8px"><input id="chInapp" type="checkbox" style="width:auto"> In-app</label>
          <label style="display:flex;align-items:center;gap:8px"><input id="chEmail" type="checkbox" style="width:auto"> Email (requires verified email)</label>
          <label style="display:flex;align-items:center;gap:8px"><input id="nSound" type="checkbox" style="width:auto"> Play sound</label>
        </div>
      </div>
      <div>
        <strong>Delivery</strong>
        <div class="flex-col" style="margin-top:6px">
          <label>Frequency
            <select id="nFreq">
              <option value="instant">Instant</option>
              <option value="daily">Daily Digest</option>
              <option value="weekly">Weekly Digest</option>
            </select>
          </label>
          <label style="margin-top:6px">Do Not Disturb</label>
          <div class="row">
            <label class="small muted" style="flex:1;display:flex;align-items:center;gap:6px"><input id="dndEn" type="checkbox" style="width:auto"> Enable</label>
            <input id="dndStart" type="time" value="22:00">
            <input id="dndEnd" type="time" value="08:00">
          </div>
        </div>
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSaveNotify">Save notification settings</button>
      <button class="btn" id="btnTestNotify">Send test alert</button>
    </div>
    <div id="nStatus" class="hint" style="margin-top:6px"></div>
  </section>

  <!-- PRIVACY -->
  <section class="card panel" id="panel-privacy" style="display:none">
    <h3 class="section-title">Privacy</h3>
    <div class="grid3">
      <label>Profile visibility
        <select id="pvProfile"><option value="public">Public</option><option value="friends">Friends</option><option value="private">Only me</option></select>
      </label>
      <label>Default post visibility
        <select id="pvPost"><option value="public">Public</option><option value="friends">Friends</option><option value="paid">Paid</option><option value="private">Only me</option></select>
      </label>
      <label>Allow DMs from
        <select id="pvDM"><option value="everyone">Everyone</option><option value="friends">Friends</option><option value="none">No one</option></select>
      </label>
      <label style="display:flex;align-items:center;gap:8px"><input id="pvOnline" type="checkbox" style="width:auto"> Show “online” status</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="pvShowLikes" type="checkbox" style="width:auto"> Show likes</label>
      <label style="display:flex;align-items:center;gap:8px"><input id="pvShowComments" type="checkbox" style="width:auto"> Show comments</label>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSavePrivacy">Save privacy</button>
    </div>
  </section>

  <!-- MONETIZATION -->
  <section class="card panel" id="panel-monetization" style="display:none">
    <h3 class="section-title">Monetization</h3>
    <div class="grid2">
      <div>
        <label class="small muted">Paywall link (Stripe/PayPal/Patreon/custom)</label>
        <input id="mPaywall" placeholder="https://">
        <div class="hint">If set, your Profile can show a “Support/Unlock” button.</div>
      </div>
      <div>
        <label class="small muted">Access code (optional)</label>
        <input id="mCode" placeholder="e.g., GOLD2025">
      </div>
    </div>
    <div class="row" style="margin-top:10px">
      <button class="btn primary" id="btnSaveMon">Save monetization</button>
    </div>
  </section>

  <!-- DATA TOOLS -->
  <section class="card panel" id="panel-tools" style="display:none">
    <h3 class="section-title">Data Tools</h3>
    <div class="row" style="flex-wrap:wrap">
      <button class="btn" id="btnExport">Export data.json</button>
      <input type="file" id="importFile" accept="application/json" />
      <button class="btn" id="btnImport">Import</button>
      <button class="btn danger" id="btnResetLocal">Factory reset (local)</button>
    </div>
    <div class="hint" style="margin-top:6px">Export/import affects local data. Backend sync (if any) is separate.</div>
  </section>
</div>

<div id="toast"></div>

<!-- Error overlay -->
<div id="errOverlay"><div id="errPanel">
  <h3 style="margin:4px 0 10px">Error details</h3>
  <pre id="errText"></pre>
  <div class="row" style="justify-content:flex-end"><button class="btn" onclick="document.getElementById('errOverlay').style.display='none'">Close</button></div>
</div></div>

<!-- (Keep only your app scripts here; common.js & messenger.js are loaded by the universal footer) -->
<script src="auth.js"></script>
<script src="api.js"></script>

<script>
/* Error catcher so you see problems fast */
(function(){ const show=(msg)=>{ const o=document.getElementById('errOverlay'); const t=document.getElementById('errText'); if(!o||!t) return; t.textContent=String(msg||'Unknown error'); o.style.display='flex'; }; window.addEventListener('error',e=>show(e.error? (e.error.stack||e.error.message||e.message) : e.message)); window.addEventListener('unhandledrejection',e=>show(e.reason && (e.reason.stack||e.reason.message||String(e.reason)))); })();

(function(){
  "use strict";

  /* ===== Storage with cookie fallback (for Weebly/private modes) ===== */
  const Storage = (()=>{ function lsOk(){ try{ const k="__ct_probe__"; localStorage.setItem(k,"1"); localStorage.removeItem(k); return true; }catch{ return false; } }
    const HAS_LS = lsOk();
    function getCookie(name){ const m=document.cookie.match(new RegExp("(?:^|; )"+encodeURIComponent(name)+"=([^;]*)")); return m?decodeURIComponent(m[1]):null; }
    function setCookie(name,val){ try{ document.cookie=encodeURIComponent(name)+"="+encodeURIComponent(val)+"; path=/; max-age=31536000"; }catch{} }
    function get(k,f){ if(HAS_LS){ try{ const v=localStorage.getItem(k); if(v!=null) return JSON.parse(v); }catch{} } const c=getCookie(k); if(c){ try{ return JSON.parse(c); }catch{} } return f; }
    function set(k,v){ const s=JSON.stringify(v); if(HAS_LS){ try{ localStorage.setItem(k,s); }catch{} } setCookie(k,s); }
    return { get,set,hasLS:HAS_LS };
  })();

  /* ===== Helpers ===== */
  const $  = (s)=>document.querySelector(s);
  const $$ = (s)=>Array.from(document.querySelectorAll(s));
  const LS = {
    USERS:"ct_users_v3", PROFILE:"ct_profile_data_v1",
    SETTINGS:"ct_settings_v1", SETTINGS_GLOBAL:"ct_settings_global",
    FRIENDS:"ct_friend_list_v2", POSTS:"ct_feed_posts_v7", MEDIA:"ct_media_v1",
    NOTIF:"ct_notifications_v1", INBOX:"ct_inbox_v1"
  };
  const DEFAULT = {
    profile:{ displayName:"", bio:"", avatarUrl:"", coverUrl:"", actor:"Me" },
    notifications:{ dm:true, comments:true, likes:true, follows:true, blogs:true, polls:true,
      channels:{ inapp:true, email:false, sound:false }, freq:"instant",
      dnd:{ enabled:false, start:"22:00", end:"08:00" } },
    privacy:{ profile:"public", post:"public", dm:"everyone", online:true, showLikes:true, showComments:true },
    monetization:{ paywall:"", code:"" },
    security:{ email:"", emailVerified:false, phone:"", phoneVerified:false, twoFA:false, backups:[] },
    sessions:[]
  };

  function toast(msg){ const t=$("#toast"); t.textContent=msg; t.className=""; void t.offsetWidth; t.className="show"; setTimeout(()=>t.className="",1300); }
  function settings(){ return Storage.get(LS.SETTINGS, DEFAULT); }
  function saveSettings(obj){
    Storage.set(LS.SETTINGS, obj);
    Storage.set(LS.SETTINGS_GLOBAL, obj); // mirror for legacy pages
    try{ window.dispatchEvent(new CustomEvent("chatternet:settings-updated", { detail: obj })); }catch{}
    try{ localStorage.setItem("ct_settings_poke", String(Date.now())); }catch{}
  }
  function load(k,f){ return Storage.get(k,f); }
  function save(k,v){ Storage.set(k,v); }

  /* ===== Header wiring (avatar + buttons) ===== */
  (function wireHeader(){
    // Avatar
    const prof = (load(LS.PROFILE, {})["Me"] || {});
    const img = $("#myProfile");
    if(img){
      img.src = (prof.avatar || prof.avatarUrl || "https://i.pravatar.cc/100?u=me");
      img.alt = (prof.displayName || "Me");
      img.style.cursor = "pointer";
      img.onclick = ()=>location.href="profile.html";
    }

    // Notifications modal
    const notifModal=$("#notifModal"), notifList=$("#notifList");
    function renderNotif(){
      const arr=load(LS.NOTIF,[]);
      notifList.innerHTML = arr.length
        ? arr.map(n=>`<div class="notifitem"><strong>${new Date(n.time).toLocaleString()}</strong><br>${(n.text||"")}</div>`).join("")
        : '<div class="notifitem">No notifications yet.</div>';
    }
    $("#btnNotif")?.addEventListener("click",()=>{ renderNotif(); notifModal.style.display="flex"; });
    $("#clearNotif")?.addEventListener("click",()=>{ save(LS.NOTIF,[]); renderNotif(); });
    $("#closeNotif")?.addEventListener("click",()=>{ notifModal.style.display="none"; });

    // Inbox modal
    const inboxModal=$("#inboxModal"), inboxList=$("#inboxList");
    function renderInbox(){
      const arr=load(LS.INBOX,[]);
      inboxList.innerHTML = arr.length
        ? arr.map(n=>`<div class="notifitem"><strong>${new Date(n.time).toLocaleString()}</strong><br>${(n.text||"")}</div>`).join("")
        : '<div class="notifitem">Inbox is empty.</div>';
    }
    $("#btnInbox")?.addEventListener("click",()=>{ renderInbox(); inboxModal.style.display="flex"; });
    $("#closeInbox")?.addEventListener("click",()=>{ inboxModal.style.display="none"; });

    // Messages -> open overlay (with safe fallback)
    $("#btnMsgs")?.addEventListener("click", (e)=>{
      e.preventDefault(); e.stopPropagation();
      if (window.ctOpen) return window.ctOpen();
      if (window.ChatternetMessenger?.open) return window.ChatternetMessenger.open();
      location.href="messages.html";
    });
  })();

  /* ===== Tabs ===== */
  function activateTab(id){
    $$("#tabsBar .tab").forEach(x=>x.classList.toggle("active", x.getAttribute("data-tab")===id));
    $$(".panel").forEach(p=>p.style.display = (p.id === "panel-"+id) ? "block" : "none");
    Storage.set("ct_last_settings_tab", id);
  }
  $("#tabsBar").addEventListener("click", (e)=>{
    const t = e.target.closest(".tab"); if(!t) return;
    e.preventDefault(); activateTab(t.getAttribute("data-tab"));
  });
  activateTab((Storage.get("ct_last_settings_tab","account"))||"account");

  /* ===== Ensure at least 'Me' exists so actor select works ===== */
  (function seedUsers(){
    let u = load(LS.USERS, null);
    if(!u){
      u = [{name:"Me", avatar:`https://i.pravatar.cc/100?u=me`},
           {name:"Grace Lee", avatar:`https://i.pravatar.cc/100?u=grace.lee`}];
      save(LS.USERS, u);
    } else {
      if(!u.find(x=>x.name==="Me")) u.unshift({name:"Me", avatar:`https://i.pravatar.cc/100?u=me`});
      save(LS.USERS, u);
    }
  })();

  /* ===== Hydrate form ===== */
  function fillStats(){
    $("#statFriends").textContent = (load(LS.FRIENDS,[]).length||0) + " Friends";
    $("#statPosts").textContent   = (load(LS.POSTS,[]).length||0) + " Posts";
    $("#statMedia").textContent   = (load(LS.MEDIA,[]).length||0) + " Media";
  }
  function hydrate(){
    const s = settings();
    // Populate actor list
    const sel = $("#actorSel"); sel.innerHTML = "";
    (load(LS.USERS, [])).forEach(u=>{
      const o=document.createElement("option"); o.value=u.name; o.textContent=u.name; sel.appendChild(o);
    });
    sel.value = s.profile.actor || "Me";

    $("#dName").value      = s.profile.displayName || "Me";
    $("#dBio").value       = s.profile.bio || "";
    $("#dAvatarUrl").value = s.profile.avatarUrl || "";
    $("#dCoverUrl").value  = s.profile.coverUrl || "";
    fillStats();

    // Update header avatar if changed
    const prof = (load(LS.PROFILE, {})["Me"] || {});
    const img = $("#myProfile");
    if (img){
      img.src = (prof.avatar || prof.avatarUrl || "https://i.pravatar.cc/100?u=me");
      img.alt = (prof.displayName || "Me");
    }
  }

  // File -> dataURL helpers
  function bindFileUse(btnId, inputId, outId){
    $(btnId).addEventListener("click", ()=>{
      const f=$(inputId).files && $(inputId).files[0]; if(!f) return;
      const r=new FileReader();
      r.onload = e => { $(outId).value = e.target.result || ""; };
      r.readAsDataURL(f);
    });
  }
  bindFileUse("#btnUseAvatar", "#dAvatarFile", "#dAvatarUrl");
  bindFileUse("#btnUseCover",  "#dCoverFile",  "#dCoverUrl");

  /* ===== Save handlers (with write-verify) ===== */
  function writeVerify(key, obj){
    save(key, obj);
    const back = load(key, null);
    return JSON.stringify(back) === JSON.stringify(obj);
  }

  $("#btnSaveProfile").onclick = ()=>{
    const s = settings();
    s.profile.displayName = ($("#dName").value||"").trim() || "Me";
    s.profile.bio        = ($("#dBio").value||"").trim();
    s.profile.avatarUrl  = ($("#dAvatarUrl").value||"").trim();
    s.profile.coverUrl   = ($("#dCoverUrl").value||"").trim();
    s.profile.actor      = $("#actorSel").value || "Me";

    // Mirror to PROFILE["Me"] so other pages update header immediately
    const profiles = load(LS.PROFILE, {});
    profiles["Me"] = profiles["Me"] || {};
    profiles["Me"].displayName = s.profile.displayName;
    if (s.profile.avatarUrl) profiles["Me"].avatar = s.profile.avatarUrl;
    if (s.profile.coverUrl)  profiles["Me"].cover  = s.profile.coverUrl;
    profiles["Me"].bio = s.profile.bio;

    const ok1 = writeVerify(LS.PROFILE, profiles);
    saveSettings(s);
    const ok2 = (JSON.stringify(settings()) === JSON.stringify(s));

    toast(ok1 && ok2 ? "Profile saved" : "Saved (fallback)");
    try{ window.CT && CT.addNotif && CT.addNotif("Profile saved."); }catch{}
    fillStats();
  };

  $("#btnViewProfile").onclick = ()=> location.href="profile.html";

  // Security
  const status = (el, ok, label)=>{ el.textContent = label || (ok?"Verified":"Not set"); el.className = "pill " + (ok?"ok":"bad"); };
  $("#btnSaveEmail").onclick = ()=>{ const s=settings(); s.security.email = ($("#secEmail").value||"").trim(); s.security.emailVerified=false; saveSettings(s); status($("#emailStatus"), false, "Saved (unverified)"); toast("Email saved"); };
  $("#btnSendCode").onclick  = ()=>{ const s=settings(); if(!s.security.email) return alert("Set email first."); s.security._emailCode=(""+Math.floor(100000+Math.random()*900000)); saveSettings(s); toast("Verification code sent (demo)"); };
  $("#btnVerifyCode").onclick= ()=>{ const s=settings(); const code=($("#codeInput").value||"").trim(); if(code && code===s.security._emailCode){ s.security.emailVerified=true; delete s.security._emailCode; saveSettings(s); status($("#emailStatus"), true, "Verified"); toast("Email verified"); } else alert("Wrong code."); };

  $("#btnSavePhone").onclick = ()=>{ const s=settings(); s.security.phone = ($("#secPhone").value||"").trim(); s.security.phoneVerified=false; saveSettings(s); status($("#phoneStatus"), false, "Saved (unverified)"); toast("Phone saved"); };
  $("#btnSendPhoneCode").onclick = ()=>{ const s=settings(); if(!s.security.phone) return alert("Set phone first."); s.security._smsCode=(""+Math.floor(100000+Math.random()*900000)); saveSettings(s); toast("SMS code sent (demo)"); };
  $("#btnVerifyPhone").onclick   = ()=>{ const s=settings(); const code=($("#phoneCodeInput").value||"").trim(); if(code && code===s.security._smsCode){ s.security.phoneVerified=true; delete s.security._smsCode; saveSettings(s); status($("#phoneStatus"), true, "Verified"); toast("Phone verified"); } else alert("Wrong code."); };

  $("#twoFA").addEventListener("change",(e)=>{ const s=settings(); s.security.twoFA=!!e.target.checked; saveSettings(s); toast("Two-step verification updated"); });

  // Notifications
  $("#btnSaveNotify").onclick = ()=>{
    const s=settings();
    s.notifications.dm       = $("#nDM").checked;
    s.notifications.comments = $("#nComments").checked;
    s.notifications.likes    = $("#nLikes").checked;
    s.notifications.follows  = $("#nFollows").checked;
    s.notifications.blogs    = $("#nBlogs").checked;
    s.notifications.polls    = $("#nPolls").checked;
    s.notifications.channels.inapp = $("#chInapp").checked;
    s.notifications.channels.email = $("#chEmail").checked;
    s.notifications.channels.sound = $("#nSound").checked;
    s.notifications.freq = $("#nFreq").value;
    s.notifications.dnd.enabled = $("#dndEn").checked;
    s.notifications.dnd.start   = $("#dndStart").value || "22:00";
    s.notifications.dnd.end     = $("#dndEnd").value || "08:00";
    saveSettings(s);
    $("#nStatus").textContent = "Notification preferences saved.";
    toast("Notification preferences saved");
  };
  $("#btnTestNotify").onclick = ()=>{ try{ window.CT && CT.addNotif && CT.addNotif("This is a test notification from Settings."); }catch{} toast("Test notification sent"); };

  // Privacy
  $("#btnSavePrivacy").onclick = ()=>{
    const s=settings();
    s.privacy.profile      = $("#pvProfile").value;
    s.privacy.post         = $("#pvPost").value;
    s.privacy.dm           = $("#pvDM").value;
    s.privacy.online       = $("#pvOnline").checked;
    s.privacy.showLikes    = $("#pvShowLikes").checked;
    s.privacy.showComments = $("#pvShowComments").checked;
    saveSettings(s);
    toast("Privacy saved");
  };

  // Monetization
  $("#btnSaveMon").onclick = ()=>{
    const s=settings();
    s.monetization.paywall = ($("#mPaywall").value||"").trim();
    s.monetization.code    = ($("#mCode").value||"").trim();
    saveSettings(s);
    toast("Monetization saved");
  };

  // Data tools
  $("#btnExport").onclick = ()=>{
    const blob = new Blob([ JSON.stringify({
      users: load(LS.USERS,[]),
      profile: load(LS.PROFILE,{}),
      settings: settings(),
      friends: load(LS.FRIENDS,[]),
      posts: load(LS.POSTS,[]),
      media: load(LS.MEDIA,[])
    }, null, 2)], {type:"application/json"});
    const a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="chatternet-data.json"; a.click(); URL.revokeObjectURL(a.href);
  };
  $("#btnImport").onclick = ()=>{
    const f=$("#importFile").files && $("#importFile").files[0]; if(!f) return alert("Choose a JSON file first.");
    const r=new FileReader();
    r.onload = e=>{
      try{
        const data=JSON.parse(e.target.result||"{}");
        if (data.users)    save(LS.USERS,data.users);
        if (data.profile)  save(LS.PROFILE,data.profile);
        if (data.settings) saveSettings(data.settings);
        if (data.friends)  save(LS.FRIENDS,data.friends);
        if (data.posts)    save(LS.POSTS,data.posts);
        if (data.media)    save(LS.MEDIA,data.media);
        toast("Import complete");
        hydrate();
      }catch(err){ alert("Import error: "+(err.message||err)); }
    };
    r.readAsText(f);
  };
  $("#btnResetLocal").onclick = ()=>{
    if (!confirm("Factory reset local data?")) return;
    try{ localStorage.clear(); }catch{}
    try{
      ["ct_users_v3","ct_profile_data_v1","ct_settings_v1","ct_settings_global",
       "ct_friend_list_v2","ct_feed_posts_v7","ct_media_v1","ct_last_settings_tab"]
       .forEach(k=>document.cookie=encodeURIComponent(k)+"=; path=/; max-age=0");
    }catch{}
    location.reload();
  };

  // Keep UI synced if other tabs change settings/profile
  window.addEventListener("storage",(ev)=>{
    if ([LS.SETTINGS,LS.SETTINGS_GLOBAL,LS.PROFILE,"ct_settings_poke"].includes(ev.key)){ hydrate(); }
  });

  // Initial fill
  if (!Storage.get(LS.SETTINGS, null)){ Storage.set(LS.SETTINGS, DEFAULT); Storage.set(LS.SETTINGS_GLOBAL, DEFAULT); }
  if (!Storage.hasLS){ setTimeout(()=>toast("Saving with cookie fallback"), 400); }
  hydrate();
})();
</script>
</body>
</html>
