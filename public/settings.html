<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Settings — Chatternet</title>

<style>
  :root{
    /* Brand + layout (unified base) */
    --brand:#0ea5e9; --brand-2:#0989c3;
    --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#667085; --line:#e6eaf2;
    --blueTop:132px; --barH:52px; --navH:48px;
    --pagePad: calc(var(--blueTop) + var(--barH) + var(--navH));
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
       font:14px/1.45 Arial,"Segoe UI",system-ui,-apple-system,sans-serif; max-width:100%; overflow-x:hidden}
  a{color:#2563eb;text-decoration:none}

  /* --- Global typography/kerning reset (fixes squashed text & pill alignment) --- */
  .top-bar, .top-bar *, nav.app-nav, nav.app-nav *, .page, .page *{
    letter-spacing: normal !important;
    word-spacing: normal !important;
    font-kerning: normal !important;
    font-variant-ligatures: none !important;
    text-rendering: optimizeLegibility !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
    line-height: 1.45;
  }

  /* ===== Fixed blue header ===== */
  .top-bar{
    position:fixed; left:0; right:0; top:var(--blueTop); z-index:1250;
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 14px; background:var(--brand); color:#fff;
    border-bottom:1px solid rgba(255,255,255,.2)
  }
  .top-bar h2{margin:0;font-weight:800;font-size:18px}
  .top-actions{display:flex;gap:10px;align-items:center}

  /* Pill button */
  .pillbtn,
  .pillbtn:link,.pillbtn:visited{
    display:inline-flex; align-items:center; justify-content:center;
    height:36px; padding:0 12px; border-radius:999px; cursor:pointer;
    border:1px solid rgba(255,255,255,.7); background:rgba(255,255,255,.15); color:#fff; font-weight:600;
    text-decoration:none; line-height:1;
  }
  .pillbtn:hover{background:rgba(255,255,255,.26)}
  #myProfile{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.85);object-fit:cover;cursor:pointer}

  /* ===== Fixed app nav ===== */
  nav.app-nav{
    position:fixed; left:0; right:0; top:calc(var(--blueTop) + var(--barH));
    z-index:1190; background:#fff; border-bottom:1px solid var(--line)
  }
  nav.app-nav .inner{
    max-width:1100px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px; justify-content:center;
  }
  nav.app-nav a{
    display:inline-block;padding:8px 10px;border-radius:999px;
    color:#111;background:#f3f4f6;text-decoration:none;font-weight:600
  }
  nav.app-nav a.active{background:#dbeafe;color:#1e3a8a}
  nav.app-nav a:hover{background:#e5e7eb}

  /* ===== Page layout ===== */
  .page{max-width:1100px;margin:14px auto;padding:0 12px; padding-top:var(--pagePad)}
  .grid{display:grid;grid-template-columns:1.05fr .95fr;gap:14px}
  @media (max-width:960px){ .grid{grid-template-columns:1fr} }

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px}
  .section-title{font-size:22px;font-weight:800;margin:0 0 10px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

  /* Controls */
  .ctrl{display:grid;grid-template-columns:160px 1fr 120px;gap:10px;align-items:center;margin:8px 0}
  .ctrl label{white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-weight:700}
  .ctrl input,.ctrl select,.ctrl textarea{
    width:100%;padding:10px 12px;border:1px solid #d7d7d7;border-radius:10px;background:#fff
  }
  .ctrl textarea{min-height:72px;resize:vertical}
  .btn{display:inline-flex;align-items:center;justify-content:center;height:36px;padding:0 12px;border-radius:999px;border:1px solid #d7d7d7;background:#fff;cursor:pointer;font-weight:600}
  .btn.primary{background:#0ea5e9;border-color:#0ea5e9;color:#fff}
  .btn.primary:hover{background:#0989c3}
  .hint{font-size:12px;color:#6b7280}
  .ok{color:#15803d;font-weight:700}
  .bad{color:#b91c1c;font-weight:700}
  .preview{display:flex;gap:10px;align-items:center;margin-top:8px}
  .preview img{width:48px;height:48px;border-radius:50%;object-fit:cover;border:1px solid #e5e7eb}

  /* Simple theme demo */
  [data-theme="dark"]{ --bg:#0b1220; --card:#0f172a; --ink:#e5ebff; --muted:#9aa5b1; --line:#1f2a44 }
  [data-theme="dark"] nav.app-nav a{ background:#1f2a44; color:#e5ebff }
  [data-theme="dark"] nav.app-nav a.active{ background:#23325a; color:#dbeafe }
</style>

<!-- Blue bar offset calculator (Unified Base Boot) -->
<script>
(function(){
  var GAP=12;
  var MENU_SELS=['.wsite-nav','.wsite-menu-default','.wsite-menus','.w-nav','.nav-wrapper','.navbar','.siteHeader .nav','.desktop-nav','.top-nav','nav[role="navigation"]','.site-navigation'];
  function pickMenuBottom(){
    var bottoms=[];
    for(var i=0;i<MENU_SELS.length;i++){
      var el=document.querySelector(MENU_SELS[i]); if(!el) continue;
      var r=el.getBoundingClientRect(), h=r.height, w=r.width;
      var ok=h>=32 && h<=140 && r.top>-20 && r.top<200 && w>300;
      if(ok) bottoms.push(Math.round(r.bottom));
    }
    var best=bottoms.length?Math.min.apply(null,bottoms):120;
    if(best>240) best=120;
    try{ var force=localStorage.getItem('ct_force_header_px'); if(force) best=parseInt(force,10)||best; }catch(_){}
    return best;
  }
  function measure(el,fb){ if(!el) return fb; var r=el.getBoundingClientRect(); return Math.max(fb, Math.round(r.height)); }
  function apply(){
    var blueTop = pickMenuBottom() + GAP;
    var barH = measure(document.querySelector('.top-bar'), 50);
    var navH = measure(document.querySelector('nav.app-nav'), 46);
    var root=document.documentElement;
    root.style.setProperty('--blueTop', blueTop+'px');
    root.style.setProperty('--barH', barH+'px');
    root.style.setProperty('--navH', navH+'px');
    root.style.setProperty('--pagePad', (blueTop+barH+navH)+'px');
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', apply); } else { apply(); }
  addEventListener('resize', apply, {passive:true});
  addEventListener('orientationchange', apply, {passive:true});
  setTimeout(apply, 0); setTimeout(apply, 250); setTimeout(apply, 800);
})();
</script>
</head>
<body>

<!-- Blue Header -->
<div class="top-bar" role="banner" aria-label="Page header">
  <h2>Settings</h2>
  <div class="top-actions">
    <a id="btnNotif" class="pillbtn" href="#">Notifications</a>
    <a id="btnInbox" class="pillbtn" href="#">Inbox</a>
    <!-- Messages: overlay if available, else fallback -->
    <a id="btnMsgs" class="pillbtn" href="messages.html">Messages</a>
    <img id="myProfile" alt="Me" />
  </div>
</div>

<!-- App Nav -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="friends.html">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a href="music.html">Music</a>
    <a class="message-link" href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a class="active" href="settings.html" aria-current="page">Settings</a>
  </div>
</nav>

<!-- Notifications modal -->
<div id="notifModal" class="modalbg" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:4000">
  <div class="card" style="max-width:520px;width:92%;max-height:80vh;overflow:auto">
    <h3 class="section-title" style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="row" style="margin-top:8px">
      <button id="clearNotif" class="btn primary">Clear</button>
      <button id="closeNotif" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Inbox modal -->
<div id="inboxModal" class="modalbg" style="position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:4000">
  <div class="card" style="max-width:520px;width:92%;max-height:80vh;overflow:auto">
    <h3 class="section-title" style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="row" style="margin-top:8px">
      <button id="closeInbox" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Page -->
<div class="page">
  <div class="grid">
    <main>

      <!-- Identity / @Me -->
      <section class="card">
        <h3 class="section-title">Identity</h3>

        <div class="ctrl">
          <label for="iName">Display name</label>
          <input id="iName" placeholder="Your name as seen on your profile"/>
          <button id="saveIdentity" class="btn primary">Save Identity</button>
        </div>

        <div class="ctrl">
          <label for="iHandle">@Me handle</label>
          <div style="display:flex;align-items:center;gap:6px">
            <span style="font-weight:800">@</span>
            <input id="iHandle" placeholder="yourname" style="flex:1"/>
          </div>
          <div id="handleState" class="hint"></div>
        </div>

        <div class="ctrl">
          <label for="iAvatar">Avatar</label>
          <input id="iAvatar" placeholder="https:// (leave blank to use default)"/>
          <button id="btnRandAvatar" class="btn">Randomize</button>
        </div>

        <div class="ctrl">
          <label for="iBio">Bio</label>
          <textarea id="iBio" placeholder="Short bio (optional)"></textarea>
          <span></span>
        </div>

        <div class="row preview" id="idPreview">
          <img id="prevAvatar" alt="avatar"/>
          <div>
            <div><strong id="prevName">Name</strong> <span class="muted">· <span id="prevHandle">@handle</span></span></div>
            <div class="hint" id="prevUrl">profile.html?u=handle</div>
          </div>
        </div>
      </section>

      <!-- Appearance & Notifications -->
      <section class="card">
        <h3 class="section-title">Appearance & Notifications</h3>

        <div class="ctrl">
          <label for="sTheme">Theme</label>
          <select id="sTheme">
            <option value="auto">Auto</option>
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
          <button id="applyTheme" class="btn">Apply</button>
        </div>

        <div class="ctrl">
          <label for="nBeep">Sound</label>
          <select id="nBeep">
            <option value="true">Enable notification beep</option>
            <option value="false">Mute</option>
          </select>
          <button id="testBeep" class="btn">Test Beep</button>
        </div>

        <div class="ctrl">
          <label>DND window</label>
          <div class="row" style="gap:6px">
            <input id="dndStart" type="time" style="width:140px">
            <span class="muted">to</span>
            <input id="dndEnd" type="time" style="width:140px">
          </div>
          <button id="saveNotify" class="btn primary">Save</button>
        </div>
      </section>

      <!-- Privacy (in a neat row) -->
      <section class="card">
        <h3 class="section-title">Privacy</h3>

        <div class="ctrl">
          <label for="pProfile">Profile visibility</label>
          <select id="pProfile">
            <option value="public">Public (everyone)</option>
            <option value="friends">Friends only</option>
            <option value="private">Only me</option>
          </select>
          <button id="savePrivacy" class="btn primary">Save Privacy</button>
        </div>

        <div class="ctrl">
          <label for="pPosts">Posts visibility</label>
          <select id="pPosts">
            <option value="public">Public</option>
            <option value="friends">Friends</option>
            <option value="private">Only me</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="pDM">Who can DM me</label>
          <select id="pDM">
            <option value="everyone">Everyone</option>
            <option value="friends">Friends</option>
            <option value="noone">No one</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="pSearch">Allow search</label>
          <select id="pSearch">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="pMentions">@mentions notify me</label>
          <select id="pMentions">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="pOnline">Show online status</label>
          <select id="pOnline">
            <option value="true">Show</option>
            <option value="false">Hide</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="pReceipts">Read receipts</label>
          <select id="pReceipts">
            <option value="true">Enable</option>
            <option value="false">Disable</option>
          </select>
          <span></span>
        </div>
      </section>

      <!-- Contact -->
      <section class="card">
        <h3 class="section-title">Contact</h3>

        <div class="ctrl">
          <label for="cEmail">Email</label>
          <input id="cEmail" placeholder="Add email (kept private by default)"/>
          <button id="saveContact" class="btn primary">Save Contact</button>
        </div>

        <div class="ctrl">
          <label for="cEmailWho">Show email to</label>
          <select id="cEmailWho">
            <option value="none">No one (auto-blank)</option>
            <option value="friends">Friends</option>
            <option value="everyone">Everyone</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="cPhone">Phone</label>
          <input id="cPhone" placeholder="Add phone (kept private by default)"/>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="cPhoneWho">Show phone to</label>
          <select id="cPhoneWho">
            <option value="none">No one (auto-blank)</option>
            <option value="friends">Friends</option>
            <option value="everyone">Everyone</option>
          </select>
          <span></span>
        </div>

        <div class="ctrl">
          <label for="cRoute">Message routing</label>
          <select id="cRoute">
            <option value="proxy">Route via Chatternet (hide details)</option>
            <option value="direct">Allow direct email/phone (if visible)</option>
          </select>
          <span></span>
        </div>
      </section>

      <!-- Security -->
      <section class="card">
        <h3 class="section-title">Security</h3>

        <div class="ctrl">
          <label for="sec2fa">Two-step verification</label>
          <select id="sec2fa">
            <option value="false">Off</option>
            <option value="true">On (placeholder)</option>
          </select>
          <button id="btnLogout" class="btn">Sign out</button>
        </div>
        <p class="hint">Auth endpoints aren’t wired yet on this build; “Sign out” clears local session and calls <code>/api/logout</code> if available.</p>
      </section>

      <!-- Data tools -->
      <section class="card">
        <h3 class="section-title">Your Data (local)</h3>

        <div class="row" style="margin-bottom:6px">
          <button id="btnCopyJSON" class="btn">Copy settings JSON</button>
          <button id="btnPasteJSON" class="btn">Apply pasted JSON</button>
        </div>
        <textarea id="dataJson" placeholder="Paste settings JSON here to import or read back exported values…"></textarea>
        <p class="hint">This works on-device (localStorage). Server sync will take over when backend endpoints are live.</p>
      </section>

      <!-- Danger zone -->
      <section class="card">
        <h3 class="section-title">Danger zone</h3>
        <div class="row">
          <button id="btnReset" class="btn" style="border-color:#b91c1c;color:#b91c1c">Reset local Chatternet data</button>
        </div>
        <p class="hint">Type <strong>RESET</strong> when prompted. This only clears local data for this browser.</p>
      </section>

    </main>

    <aside>
      <section class="card">
        <strong>Quick links</strong>
        <div class="row" style="margin-top:10px">
          <a class="btn" href="profile.html">My profile</a>
          <a class="btn message-link" href="messages.html">Messages</a>
        </div>
      </section>
    </aside>
  </div>
</div>

<script>
/* === storage + helpers (unified with your stack) === */
const LS={
  USERS:'ct_users_v3',
  PROFILE:'ct_profile_data_v1',
  PRIVACY:'CT_PRIVACY_V1',
  SETTINGS:'ct_settings_v1',
  NOTIF:'ct_notifications_v1',
  INBOX:'ct_inbox_v1',
  HANDLE:'ct_handle_v1'
};
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const load=(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch{ return f; } };
const save=(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} };
const nowISO=()=>new Date().toISOString();
const face=n=>`https://i.pravatar.cc/120?u=${encodeURIComponent(n||'me')}`;
function addNotif(text){ const a=load(LS.NOTIF,[]); a.unshift({text,time:nowISO()}); save(LS.NOTIF,a); }
function beep(){
  try{
    const ctx=new (window.AudioContext||window.webkitAudioContext)();
    const o=ctx.createOscillator(), g=ctx.createGain(); o.type='sine'; o.frequency.value=880;
    o.connect(g); g.connect(ctx.destination); g.gain.setValueAtTime(0.001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ctx.currentTime+0.01);
    o.start(); setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime+0.08); o.stop(ctx.currentTime+0.1); }, 70);
  }catch{}
}

/* Settings runtime bridge (uses CT.settings() if present, else local) */
function getCT(){ return (window.CT && typeof CT.settings==='function') ? CT.settings() : load(LS.SETTINGS,{}); }
function updateCT(patch){
  // Merge locally
  const cur=getCT();
  const next={...cur, ...patch};
  save(LS.SETTINGS, next);
  // Mirror to CT runtime if available
  if(window.CT && typeof CT.updateSettings==='function'){ try{ CT.updateSettings(patch); }catch{} }
  return next;
}

/* header wire-up */
(function header(){
  const meAll=load(LS.PROFILE,{});
  const me=meAll['Me']||{};
  const handle=load(LS.HANDLE, me.at || 'me');
  const ava=me.avatar||me.avatarUrl||face(handle);
  const img=$('#myProfile'); img.src=ava; img.referrerPolicy='no-referrer';
  img.onclick=()=>{ try{ localStorage.setItem('ct_profile_view_v1', JSON.stringify({name:me.name||'Me', at:handle})); }catch{}; location.href='profile.html'; };

  // Notifications/Inbox modals
  const nM=$('#notifModal'), iM=$('#inboxModal');
  const rN=()=>{ const a=load(LS.NOTIF,[]); $('#notifList').innerHTML=a.length?a.map(n=>`<div class="muted" style="margin:6px 0"><strong>${new Date(n.time).toLocaleString()}</strong><br>${n.text||''}</div>`).join(''):'No notifications yet.'; };
  const rI=()=>{ const a=load(LS.INBOX,[]); $('#inboxList').innerHTML=a.length?a.map(n=>`<div class="muted" style="margin:6px 0"><strong>${new Date(n.time).toLocaleString()}</strong><br>${n.text||''}</div>`).join(''):'Inbox is empty.'; };

  $('#btnNotif').onclick=(e)=>{ e.preventDefault(); rN(); nM.style.display='flex'; };
  $('#clearNotif').onclick=()=>{ save(LS.NOTIF,[]); rN(); };
  $('#closeNotif').onclick=()=>{ nM.style.display='none'; };

  $('#btnInbox').onclick=(e)=>{ e.preventDefault(); rI(); iM.style.display='flex'; };
  $('#closeInbox').onclick=()=>{ iM.style.display='none'; };

  // Messages overlay if available
  function openMessages(ev){
    if(ev) ev.preventDefault();
    if(window.ChatternetMessenger && typeof ChatternetMessenger.open==='function'){ ChatternetMessenger.open(); return; }
    if(window.ctOpen && typeof ctOpen==='function'){ ctOpen('messages'); return; }
    location.href='messages.html';
  }
  $('#btnMsgs').addEventListener('click', openMessages);
  $$('.message-link').forEach(a=>a.addEventListener('click', openMessages));
})();

/* defaults */
const DEFAULT_PRIV={ profile:'public', post:'public', dm:'everyone', online:true, search:true, receipts:true, mentions:true, emailWho:'none', phoneWho:'none', route:'proxy' };
const DEFAULT_SET={ theme:'auto', beep:true, dndStart:'22:00', dndEnd:'07:00', twofa:false };

/* handle rules & helpers */
const RESERVED = new Set(['me','admin','support','system','null','undefined']);
const HANDLE_RE = /^[a-z][a-z0-9._-]{2,19}$/;
function cleanHandle(s){ return (s||'').trim().toLowerCase().replace(/[^a-z0-9._-]/g,'').slice(0,20); }
function handleTaken(h){
  const users=load(LS.USERS,[]);
  const mine=(load(LS.HANDLE,'me'));
  if(h===mine) return false;
  for(const u of users){ const at=(u.at||u.handle||u.username||'').toLowerCase(); if(at===h) return true; }
  // also scan profiles cache (if any)
  const profs=load(LS.PROFILE,{});
  for(const k of Object.keys(profs)){ const at=(profs[k]?.at||'').toLowerCase(); if(at===h && k!=='Me') return true; }
  return false;
}

/* identity preview refresh */
function refreshPreview(){
  const prof=load(LS.PROFILE,{})['Me']||{};
  const at=load(LS.HANDLE, prof.at || 'me');
  $('#prevName').textContent = prof.name || 'Me';
  $('#prevHandle').textContent = '@'+at;
  $('#prevUrl').textContent = `profile.html?u=${at}`;
  $('#prevAvatar').src = prof.avatar||prof.avatarUrl||face(at);
}

/* boot UI */
(function boot(){
  // Privacy
  const priv = { ...DEFAULT_PRIV, ...(load(LS.PRIVACY, {})) };
  $('#pProfile').value = priv.profile;
  $('#pPosts').value   = priv.post;
  $('#pDM').value      = priv.dm;
  $('#pSearch').value  = String(!!priv.search);
  $('#pMentions').value= String(!!priv.mentions);
  $('#pOnline').value  = String(!!priv.online);
  $('#pReceipts').value= String(!!priv.receipts);

  // Contact
  const me=(load(LS.PROFILE,{}))['Me']||{};
  $('#cEmail').value = me.email||'';
  $('#cPhone').value = me.phone||'';
  $('#cEmailWho').value= priv.emailWho||'none';
  $('#cPhoneWho').value= priv.phoneWho||'none';
  $('#cRoute').value   = priv.route||'proxy';

  // Identity
  $('#iName').value = me.name||'';
  const at=load(LS.HANDLE, me.at || 'me');
  $('#iHandle').value = at;
  $('#iBio').value = me.bio||'';
  $('#iAvatar').value = me.avatar||me.avatarUrl||'';
  refreshPreview();
  validateHandle();

  // Appearance & Notifications
  const set={...DEFAULT_SET, ...getCT()};
  $('#sTheme').value=set.theme||'auto';
  $('#nBeep').value=String(!!set.beep);
  $('#dndStart').value=set.dndStart||'22:00';
  $('#dndEnd').value=set.dndEnd||'07:00';
  applyTheme(set.theme||'auto');

  // Security
  $('#sec2fa').value=String(!!set.twofa);
})();

/* validation feedback */
function validateHandle(){
  const raw=$('#iHandle').value;
  const h=cleanHandle(raw);
  const el=$('#handleState');
  if(!HANDLE_RE.test(h)){ el.innerHTML='<span class="bad">Invalid.</span> Use 3–20 chars: a–z, 0–9, . _ - (must start with a letter).'; return false; }
  if(RESERVED.has(h)){ el.innerHTML='<span class="bad">Reserved name.</span>'; return false; }
  if(handleTaken(h)){ el.innerHTML='<span class="bad">Already taken (on this device).</span>'; return false; }
  el.innerHTML='<span class="ok">Looks good.</span>';
  return true;
}
$('#iHandle').addEventListener('input', ()=>{
  $('#iHandle').value = cleanHandle($('#iHandle').value);
  validateHandle();
  const at=$('#iHandle').value||'me';
  $('#prevHandle').textContent='@'+at;
  $('#prevUrl').textContent=`profile.html?u=${at}`;
  $('#prevAvatar').src = ($('#iAvatar').value.trim()||face(at));
});
$('#iName').addEventListener('input', ()=>{ $('#prevName').textContent=$('#iName').value||'Me'; });

/* Avatar randomizer */
$('#btnRandAvatar').onclick=()=>{
  const at=$('#iHandle').value||'me';
  const url=face(at+'-'+Math.random().toString(36).slice(2));
  $('#iAvatar').value=url;
  $('#prevAvatar').src=url;
};

/* Theme */
function systemPrefersDark(){ return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches; }
function applyTheme(mode){
  let t=mode; if(mode==='auto') t=systemPrefersDark()?'dark':'light';
  document.documentElement.setAttribute('data-theme', t==='dark'?'dark':'light');
}
$('#applyTheme').onclick=()=>{ const mode=$('#sTheme').value; updateCT({theme:mode}); applyTheme(mode); addNotif('Theme preference saved.'); };

/* Beep */
$('#testBeep').onclick=()=>beep();

/* Saves */
$('#savePrivacy').onclick=()=>{
  const cur=load(LS.PRIVACY,{});
  const nxt={
    ...DEFAULT_PRIV, ...cur,
    profile:$('#pProfile').value,
    post:$('#pPosts').value,
    dm:$('#pDM').value,
    search:$('#pSearch').value==='true',
    mentions:$('#pMentions').value==='true',
    online:$('#pOnline').value==='true',
    receipts:$('#pReceipts').value==='true'
  };
  save(LS.PRIVACY,nxt);
  // also mirror to settings runtime
  updateCT({privacy:nxt});
  addNotif('Privacy settings saved.');
};

/* Contact save */
$('#saveContact').onclick=()=>{
  const prof=load(LS.PROFILE,{});
  prof['Me']=prof['Me']||{};
  prof['Me'].email=$('#cEmail').value.trim();
  prof['Me'].phone=$('#cPhone').value.trim();
  save(LS.PROFILE,prof);

  const cur=load(LS.PRIVACY,{});
  const nxt={ ...DEFAULT_PRIV, ...cur,
    emailWho:$('#cEmailWho').value,
    phoneWho:$('#cPhoneWho').value,
    route:$('#cRoute').value
  };
  save(LS.PRIVACY,nxt);
  updateCT({privacy:nxt});
  addNotif('Contact settings saved.');
};

/* Notifications save */
$('#saveNotify').onclick=()=>{
  const patch={
    beep: $('#nBeep').value==='true',
    dndStart: $('#dndStart').value || '22:00',
    dndEnd: $('#dndEnd').value || '07:00'
  };
  updateCT(patch);
  addNotif('Notification preferences saved.');
  if(patch.beep) beep();
};

/* Identity save (name, handle, avatar, bio) */
$('#saveIdentity').onclick=()=>{
  if(!validateHandle()){ alert('Fix your @Me handle first.'); return; }
  const name=$('#iName').value.trim()||'Me';
  const at=$('#iHandle').value.trim()||'me';
  const avatar=$('#iAvatar').value.trim();
  const bio=$('#iBio').value.trim();

  // Profile store
  const profAll=load(LS.PROFILE,{});
  profAll['Me']=profAll['Me']||{};
  Object.assign(profAll['Me'], { name, at, avatarUrl:avatar||undefined, avatar:avatar||undefined, bio });
  save(LS.PROFILE, profAll);

  // Users list (for local uniqueness & demo)
  const users=load(LS.USERS,[]);
  const meIdx=users.findIndex(u=> (u.id==='me') || ((u.at||'')===load(LS.HANDLE,'me')) );
  const rec={ id:'me', name, at, avatar: (avatar||face(at)), bio };
  if(meIdx>=0) users[meIdx]= { ...users[meIdx], ...rec };
  else users.unshift(rec);
  save(LS.USERS, users);

  // Handle key
  save(LS.HANDLE, at);

  refreshPreview();
  addNotif('Identity saved. Your @Me is now @'+at+'.');
};

/* Copy/Paste JSON (local) */
$('#btnCopyJSON').onclick=async()=>{
  const bundle={
    settings: load(LS.SETTINGS,{}),
    privacy: load(LS.PRIVACY,{}),
    profile: load(LS.PROFILE,{}),
    handle: load(LS.HANDLE,null)
  };
  const text=JSON.stringify(bundle, null, 2);
  $('#dataJson').value=text;
  try{ await navigator.clipboard.writeText(text); addNotif('Settings JSON copied to clipboard.'); }catch{ addNotif('Settings JSON ready in the box below.'); }
};
$('#btnPasteJSON').onclick=()=>{
  const text=$('#dataJson').value.trim();
  if(!text){ alert('Paste JSON first.'); return; }
  try{
    const o=JSON.parse(text);
    if(o.settings) save(LS.SETTINGS, o.settings), updateCT(o.settings);
    if(o.privacy) save(LS.PRIVACY, o.privacy), updateCT({privacy:o.privacy});
    if(o.profile) save(LS.PROFILE, o.profile);
    if(o.handle) save(LS.HANDLE, o.handle);
    refreshPreview();
    addNotif('Imported settings from JSON.');
  }catch(e){ alert('Invalid JSON.'); }
};

/* Logout (local + optional /api/logout) */
$('#btnLogout').onclick=async()=>{
  // best-effort server logout
  try{
    if(window.ctApi){ await ctApi('/api/logout',{method:'POST'}); }
  }catch{}
  // clear simple session hints (keep user data)
  try{ localStorage.removeItem('ct_session'); }catch{}
  addNotif('Signed out (local session cleared).');
};

/* Danger zone */
$('#btnReset').onclick=()=>{
  const ok=prompt('Type RESET to clear local Chatternet data for this browser only.');
  if(ok==='RESET'){
    [LS.SETTINGS,LS.PRIVACY,LS.PROFILE,LS.USERS,LS.HANDLE,LS.NOTIF,LS.INBOX].forEach(k=>{ try{ localStorage.removeItem(k); }catch{} });
    addNotif('Local data cleared. Reloading…');
    setTimeout(()=>location.reload(),400);
  }
};

/* keep preview avatar in sync while typing URL */
$('#iAvatar').addEventListener('input', ()=>{ $('#prevAvatar').src=$('#iAvatar').value.trim()||face($('#iHandle').value||'me'); });

</script>

</body>
</html>
