<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Chatternet — Music</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root{
    /* Base stack layout vars (set by positioner script below) */
    --blueTop:132px;     /* distance from site menu bottom to blue bar */
    --barH:52px;         /* measured height of blue bar */
    --navH:48px;         /* measured height of chip nav */
    --pagePad: calc(var(--blueTop) + var(--barH) + var(--navH));

    /* Theme (same palette as base stack pages) */
    --brand:#0ea5e9; --brand-2:#0989c3;
    --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#667085; --line:#e6eaf2;
    --heart:#ff3b5c;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.45 Arial,"Segoe UI",system-ui,-apple-system,sans-serif;overflow-x:hidden}

  a{color:#2563eb;text-decoration:none}

  /* ===== Fixed blue bar (base stack) ===== */
  .top-bar{
    position:fixed; left:0; right:0; top:var(--blueTop); z-index:1200;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; height:var(--barH);
    background:var(--brand); color:#fff; border-bottom:1px solid rgba(255,255,255,.2);
    box-shadow:0 2px 8px rgba(0,0,0,.12);
  }
  .top-bar h2{margin:0;font-weight:800;font-size:18px;letter-spacing:.2px}
  .top-actions{display:flex;gap:10px;align-items:center}
  .pillbtn{
    height:36px;padding:0 12px;border-radius:999px;cursor:pointer;
    border:1px solid rgba(255,255,255,.7);background:#fff;color:#0b3a67;font-weight:600
  }
  .pillbtn:hover{background:#eef4ff}
  #myProfile{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.85);object-fit:cover;cursor:pointer}

  /* ===== Chip nav (identical across app) ===== */
  nav.app-nav{position:fixed;left:0;right:0;top:calc(var(--blueTop) + var(--barH));z-index:1190;background:#fff;border-bottom:1px solid var(--line)}
  nav.app-nav .inner{max-width:1180px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px}
  nav.app-nav a{display:inline-block;padding:8px 10px;border-radius:999px;background:#f3f4f6;color:#111;font-weight:600;text-decoration:none}
  nav.app-nav a.active{background:#dbeafe;color:#1e3a8a}
  nav.app-nav a:hover{background:#e5e7eb}

  /* ===== Page shell ===== */
  .page{max-width:1180px;margin:14px auto;padding:0 12px;padding-top:var(--pagePad)}
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px;margin:14px 0}
  .section-title{font-size:22px;font-weight:800;margin:4px 0 10px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .row>*{flex:1}
  input,select,textarea,button{font:inherit}
  input,textarea,select{width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:10px}
  textarea{resize:vertical;min-height:90px}
  .btn{padding:10px 14px;border:1px solid #d7d7d7;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-2)}
  .btn.ghost{background:#f6f9ff;border-color:#e5edff}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}
  .muted{color:var(--muted)}
  .empty{color:#6b7280;text-align:center;padding:16px}

  /* ===== Music page components (kept from your page) ===== */
  .music-card{padding:12px;border:1px solid #eee;border-radius:12px;background:#fafafa;margin:12px 0}
  .music-card header{display:flex;gap:10px;align-items:center}
  .avatar{width:40px;height:40px;border-radius:50%;object-fit:cover;cursor:pointer;border:1px solid #e5e7eb;background:#fff}
  .author{font-weight:700;cursor:pointer}
  .meta{color:var(--muted);font-size:12px}
  .title{font-weight:800;font-size:18px;margin:6px 0}
  .desc{white-space:pre-wrap;margin-top:6px}
  .caption{color:#475569;margin-top:4px}
  .media{margin-top:8px;border-radius:10px;overflow:hidden;border:1px solid var(--line);background:#fff}
  .media video,.media audio,.media iframe{width:100%;display:block}
  .media iframe,.media video{aspect-ratio:16/9;min-height:320px;height:auto}
  .util{display:flex;align-items:center;gap:8px;margin-top:10px;flex-wrap:wrap}
  .add-pl{display:flex;gap:8px;align-items:center;margin-top:8px}

  /* Hearts */
  .heart-btn{width:36px;height:36px;border-radius:8px;background:#f6f7fb;border:1px solid #e6e8f2;display:inline-flex;align-items:center;justify-content:center;cursor:pointer;transition:transform .05s ease, background .2s ease, border-color .2s ease}
  .heart-btn:hover{background:#eef0f7}
  .heart-btn:active{transform:scale(0.97)}
  .heart-btn svg{width:20px;height:20px;fill:none;stroke:#555;stroke-width:2}
  .heart-btn.active{background:#ffe7ed;border-color:#ffd3de}
  .heart-btn.active svg{fill:var(--heart);stroke:var(--heart)}
  .like-count{font-weight:700}

  /* Comments */
  .comments{margin-top:8px;border-top:1px solid #e5e5e5;padding-top:8px}
  .comment{padding:8px;border:1px solid #eee;border-radius:10px;background:#fff;margin:8px 0;display:flex;gap:8px;align-items:flex-start}
  .comment .c-avatar{width:30px;height:30px;border-radius:50%;flex:0 0 auto;cursor:pointer;border:1px solid #e5e7eb;background:#fff}
  .comment .bubble{flex:1}
  .comment .bubble .by{font-weight:700;font-size:13px;cursor:pointer}
  .comment .bubble .ctxt{margin-top:2px;white-space:pre-wrap}

  /* Actor chip */
  .actorChip{display:inline-flex;align-items:center;gap:8px;background:#eef6ff;border:1px solid #d7e7ff;padding:6px 10px;border-radius:999px}
  .actorChip img{width:26px;height:26px;border-radius:50%}

  /* Mini player (kept) */
  .playerBar{position:fixed;left:0;right:0;bottom:0;background:#0f172a;color:#fff;z-index:1100;box-shadow:0 -6px 16px rgba(0,0,0,.24)}
  .playerRow{max-width:1180px;margin:0 auto;display:grid;grid-template-columns:1.6fr 1fr 1fr;gap:10px;align-items:center;padding:10px 12px}
  @media (max-width:900px){.playerRow{grid-template-columns:1fr}}
  .pInfo{display:flex;gap:10px;align-items:center;min-width:0}
  .pInfo img{width:42px;height:42px;border-radius:8px;object-fit:cover;border:2px solid rgba(255,255,255,.2)}
  .pTitle{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pMeta{font-size:12px;opacity:.8;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .pCtrls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pCtrls button{padding:8px 10px;border-radius:10px;border:1px solid rgba(255,255,255,.2);background:transparent;color:#fff;cursor:pointer}
  .pCtrls button.active{background:rgba(255,255,255,.12)}
  .pMore{display:flex;gap:8px;align-items:center;flex-wrap:wrap;justify-content:flex-end}
  .pMore input[type="range"]{width:140px}
  .pClose{justify-self:end}

  /* Modals */
  .modalbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:2000}
  .sheet{background:#fff;border-radius:12px;max-width:620px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
  .notif-item{padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;margin:8px 0}
  .actor-list{display:flex;flex-direction:column;gap:6px;margin-top:8px}
  .actor-row{display:flex;align-items:center;gap:10px;padding:8px;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer;background:#fafafa}
  .actor-row img{width:32px;height:32px;border-radius:50%}
  .actor-row:hover{background:#eef6ff;border-color:#cfe1ff}
  .pl-row{display:flex;gap:10px;align-items:center;border:1px solid #e5e7eb;border-radius:10px;padding:6px 8px;margin:6px 0;background:#fafafa}
</style>

<!-- Positioner: measure Weebly menu -> set --blueTop/--barH/--navH/--pagePad -->
<script>
(function(){
  var GAP=12, MENU_SELS=['.wsite-nav','.wsite-menu-default','.wsite-menus','.w-nav','.nav-wrapper','.navbar','.siteHeader .nav','.desktop-nav','.top-nav','nav[role="navigation"]','.site-navigation'];
  function pickMenuBottom(){var bottoms=[];for(var i=0;i<MENU_SELS.length;i++){var el=document.querySelector(MENU_SELS[i]);if(!el)continue;var r=el.getBoundingClientRect(),h=r.height,w=r.width;var ok=h>=32&&h<=120&&r.top>-20&&r.top<180&&w>300;if(ok)bottoms.push(Math.round(r.bottom));}var best=bottoms.length?Math.min.apply(null,bottoms):120;if(best>200)best=120;try{var force=localStorage.getItem('ct_force_header_px');if(force)best=parseInt(force,10)||best;}catch{}return best;}
  function measure(el,fb){if(!el)return fb;var r=el.getBoundingClientRect();return Math.max(fb,Math.round(r.height));}
  function apply(){var blueTop=pickMenuBottom()+GAP;var barH=measure(document.querySelector('.top-bar'),52);var navH=measure(document.querySelector('nav.app-nav'),48);
    document.documentElement.style.setProperty('--blueTop',blueTop+'px');
    document.documentElement.style.setProperty('--barH',barH+'px');
    document.documentElement.style.setProperty('--navH',navH+'px');
    document.documentElement.style.setProperty('--pagePad',(blueTop+barH+navH)+'px');}
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',apply);}else{apply();}
  addEventListener('resize',apply,{passive:true}); addEventListener('orientationchange',apply,{passive:true});
})();
</script>
</head>
<body>

<!-- ===== Blue bar ===== -->
<div class="top-bar">
  <h2>Music</h2>
  <div class="top-actions">
    <button id="btnNotif" class="pillbtn" type="button">Notifications</button>
    <button id="btnInbox" class="pillbtn" type="button">Inbox</button>
    <button id="btnMsgs" class="pillbtn" type="button">Messages</button>
    <img id="myProfile" title="My Profile" />
  </div>
</div>

<!-- ===== Chip nav (base stack) ===== -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="friends.html">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a class="active" href="music.html" aria-current="page">Music</a>
    <a href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- ===== Page ===== -->
<div class="page">

  <!-- Uploader -->
  <section class="card">
    <h3 class="section-title">Upload Music / Video</h3>

    <div class="row">
      <input id="musicTitle" placeholder="Title" />
      <div style="flex:0 0 360px;display:flex;gap:8px;align-items:center;justify-content:flex-end">
        <span class="actorChip"><img id="actorAva"><span id="actorName">Posting as —</span></span>
        <button id="actorChange" class="btn ghost" style="flex:0 0 110px">Change</button>
        <button id="rememberActor" class="btn ghost" style="flex:0 0 130px">Make Default</button>
      </div>
    </div>

    <div class="muted" id="postingAsHint"></div>

    <textarea id="musicDescription" placeholder="Description (optional)"></textarea>

    <div class="row">
      <input type="file" id="musicFile" accept="audio/*,video/*" />
      <input id="musicURL" placeholder="Or paste YouTube / audio / video URL" />
    </div>

    <div class="row">
      <input id="musicCaption" placeholder="Caption (optional)" />
      <select id="playlistSelect"><option value="">— Add to Playlist (optional) —</option></select>
    </div>

    <div class="row">
      <button class="btn primary" id="uploadMusicBtn">Upload</button>
      <div class="muted" id="uploadHint" style="flex:2">Tip: uploads here can be shared to the global Feed.</div>
    </div>
  </section>

  <!-- Playlists create -->
  <section class="card">
    <h3 class="section-title">Playlists</h3>
    <div class="row">
      <input id="newPlaylistName" placeholder="New playlist name" />
      <input id="newPlaylistDesc" placeholder="Playlist description" />
      <button class="btn primary" id="createPlaylistBtn" style="flex:0 0 180px">Create</button>
    </div>
  </section>

  <!-- Your Playlists -->
  <section class="card">
    <h3 class="section-title">Your Playlists</h3>
    <div id="playlistContainer"></div>
  </section>

  <!-- Music Feed controls -->
  <section class="card">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 class="section-title" style="margin:0">Music Feed</h3>
      <div class="row" style="flex:0 0 auto">
        <input id="searchBox" placeholder="Search title / author" style="min-width:220px">
        <select id="sortSel" style="flex:0 0 160px">
          <option value="new">Newest</option>
          <option value="liked">Most liked</option>
          <option value="title">Title A–Z</option>
        </select>
        <select id="filterSel" style="flex:0 0 170px">
          <option value="all">All</option>
          <option value="mine">My uploads</option>
          <option value="faves">Favorites ⭐</option>
        </select>
      </div>
    </div>
    <div id="musicGallery"></div>
    <div id="galleryEmpty" class="empty" style="display:none;">No uploads match your filters.</div>
  </section>
</div>

<!-- Notifications -->
<div class="modalbg" id="notifBg">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="row" style="margin-top:8px">
      <button id="clearNotif" class="btn primary" type="button">Clear</button>
      <button id="closeNotif" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Inbox -->
<div class="modalbg" id="inboxBg">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="row" style="margin-top:8px">
      <button id="closeInbox" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Actor Picker -->
<div class="modalbg" id="actorBg"><div class="sheet">
  <h3 style="margin:0 0 10px">Choose who you’re posting as</h3>
  <input id="actorSearch" placeholder="Search people…" />
  <div id="actorList" class="actor-list"></div>
  <div class="row" style="margin-top:8px;gap:8px">
    <button id="actorDefault" class="btn primary">Make Default</button>
    <button id="actorClose" class="btn">Close</button>
  </div>
</div></div>

<!-- Playlist Editor -->
<div class="modalbg" id="plEditBg"><div class="sheet">
  <h3 style="margin:0 0 10px">Edit Playlist</h3>
  <div class="row">
    <input id="plEditName" placeholder="Playlist name">
    <input id="plEditDesc" placeholder="Description (optional)">
  </div>
  <div class="muted" style="margin-top:6px">Tracks in this playlist</div>
  <div id="plEditList" style="margin-top:6px"></div>
  <div class="row" style="margin-top:10px">
    <button id="plSave" class="btn primary">Save changes</button>
    <button id="plClose" class="btn">Close</button>
  </div>
</div></div>

<!-- Mini Player -->
<div class="playerBar" id="playerBar" style="display:none">
  <div class="playerRow">
    <div class="pInfo">
      <img id="pAva" alt="">
      <div style="min-width:0">
        <div class="pTitle" id="pTitle">—</div>
        <div class="pMeta" id="pMeta">—</div>
      </div>
    </div>
    <div class="pCtrls">
      <button id="prevBtn">⏮ Prev</button>
      <button id="playBtn">▶ Play</button>
      <button id="nextBtn">⏭ Next</button>
      <button id="loopBtn">□ Loop</button>
      <button id="queueBtn">⤴ Queue (<span id="qCount">0</span>)</button>
      <button id="copyBtn">□ Copy link</button>
    </div>
    <div class="pMore">
      <label>Speed
        <select id="speedSel" style="width:84px">
          <option>0.75</option><option selected>1</option><option>1.25</option><option>1.5</option><option>1.75</option><option>2</option>
        </select>
      </label>
      <label>Volume <input id="volRange" type="range" min="0" max="1" step="0.01" value="1"></label>
      <button id="closePlayer" class="pClose">✕ Close</button>
    </div>
  </div>
</div>

<!-- Offscreen players -->
<audio id="miniAudio" style="display:none"></audio>
<video id="miniVideo" style="display:none"></video>
<div id="ytMiniHolder" style="position:absolute;left:-9999px;top:-9999px;width:200px;height:112px"></div>

<!-- Messenger overlay loader (same pattern as base pages) -->
<script>
(function () {
  var FALLBACK='https://chatternet-backend-1.onrender.com';
  var ls=localStorage.getItem('ct_api_base')||''; var base=(window.CT_API_BASE||ls||FALLBACK).replace(/\/+$/,'');
  window.CT_API_BASE=base; if(!ls){try{localStorage.setItem('ct_api_base',base);}catch{}}
  function chain(arr,cb){(function n(i){if(i>=arr.length){cb(false);return;}var s=document.createElement('script');s.src=arr[i];s.async=true;s.onload=function(){cb(true)};s.onerror=function(){s.remove();n(i+1)};(document.head||document.documentElement).appendChild(s);})(0);}
  chain([base+'/assets/messenger.js','/assets/messenger.js','assets/messenger.js','/messenger.js','messenger.js'],function(ok){
    if(ok && window.ChatternetMessenger?.open){ window.ctOpen=window.ctOpen||function(){window.ChatternetMessenger.open("")}; window.ctMessage=window.ctMessage||function(n){window.ChatternetMessenger.open(n||"")}; }
  });
})();
</script>

<script>
/* ===== Keys & helpers ===== */
const LS={USERS:'ct_users_v3',PROFILE:'ct_profile_data_v1',VIEW:'ct_profile_view_v1',NOTIF:'ct_notifications_v1',INBOX:'ct_inbox_v1',MUSIC:'ct_music_posts_v1',PLAYLISTS:'ct_music_playlists_v2',FEED:'ct_feed_posts_v7',PRIV:'CT_PRIVACY_V1',NSET:'CT_NOTIFY_V1',FAVES:'ct_music_faves_v1',ACTOR:'ct_default_actor_v1'};
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const load=(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;}}; const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const uid=(p='id')=>`${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`;
const nowISO=()=>new Date().toISOString();
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
const rel=iso=>{const d=(Date.now()-new Date(iso).getTime())/1000;if(d<60)return'just now';if(d<3600)return Math.floor(d/60)+'m';if(d<86400)return Math.floor(d/3600)+'h';return Math.floor(d/86400)+'d';};
function addNotif(text){const arr=load(LS.NOTIF,[]);arr.unshift({id:uid('n'),text,time:nowISO()});save(LS.NOTIF,arr);}
function addInbox(text){const arr=load(LS.INBOX,[]);arr.unshift({id:uid('m'),text,time:nowISO()});save(LS.INBOX,arr);}
function goToProfile(name){ try{localStorage.setItem(LS.VIEW,JSON.stringify({name}));}catch{} location.href='profile.html';}

/* ===== Avatar utilities ===== */
const FALLBACK_AVA = "data:image/svg+xml;utf8,"+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect width='64' height='64' fill='#e5e7eb'/><circle cx='32' cy='24' r='12' fill='#cbd5e1'/><rect x='16' y='42' width='32' height='14' rx='7' fill='#cbd5e1'/></svg>`);
function userByName(n){ const users=load(LS.USERS,[]); const u=users.find(x=>x.name===n); return u || {name:n||'Me',avatar:`https://i.pravatar.cc/100?u=${encodeURIComponent(n||'Me')}`}; }
(function seedUsers(){
  let users=load(LS.USERS,null);
  if(!users){ users=[{name:'Me',avatar:'https://i.pravatar.cc/100?u=me'},{name:'Chatternet',avatar:'https://i.pravatar.cc/100?u=chatternet'}]; }
  if(!users.find(u=>u.name==='Me')) users.unshift({name:'Me',avatar:'https://i.pravatar.cc/100?u=me'});
  if(!users.find(u=>u.name==='Chatternet')) users.push({name:'Chatternet',avatar:'https://i.pravatar.cc/100?u=chatternet'});
  save(LS.USERS,users);
})();

/* ===== Header wiring (identical to base stack) ===== */
(function(){
  const prof=(load(LS.PROFILE,{}))['Me']||{};
  const img=$('#myProfile'); if(img){ img.referrerPolicy='no-referrer'; img.loading='lazy'; img.src=prof.avatar||prof.avatarUrl||userByName('Me').avatar; img.onerror=()=>{img.onerror=null; img.src=FALLBACK_AVA}; img.alt=prof.displayName||'Me'; img.onclick=()=>goToProfile('Me'); }
  $('#btnMsgs')?.addEventListener('click',(e)=>{e.preventDefault(); if(window.ctOpen) return ctOpen(); if(window.ChatternetMessenger?.open) return window.ChatternetMessenger.open(""); location.href='messages.html';});

  const nbg=$('#notifBg'), ibg=$('#inboxBg');
  const rN=()=>{const a=load(LS.NOTIF,[]);$('#notifList').innerHTML=a.length?a.map(n=>`<div class="notif-item"><strong>${new Date(n.time).toLocaleString()}</strong><br>${esc(n.text||'')}</div>`).join(''):'<div class="notif-item">No notifications yet.</div>';};
  const rI=()=>{const a=load(LS.INBOX,[]);$('#inboxList').innerHTML=a.length?a.map(n=>`<div class="notif-item"><strong>${new Date(n.time).toLocaleString()}</strong><br>${esc(n.text||'')}</div>`).join(''):'<div class="notif-item">Inbox is empty.</div>';};
  $('#btnNotif').onclick=()=>{rN();nbg.style.display='flex';}; $('#clearNotif').onclick=()=>{save(LS.NOTIF,[]);rN();}; $('#closeNotif').onclick=()=>{nbg.style.display='none';};
  $('#btnInbox').onclick=()=>{rI();ibg.style.display='flex';}; $('#closeInbox').onclick=()=>{ibg.style.display='none';};
})();

/* ===== Notify & privacy (kept) ===== */
const privacy=()=>load(LS.PRIV,null)||{mentions:true,blocked:[],online:true};
const notify=()=>load(LS.NSET,null)||{sound:false,dnd:{en:false,start:'22:00',end:'08:00'}};
let audioCtx=null;
function inDND(){ const n=notify(); if(!n.dnd||!n.dnd.en) return false; const [sh,sm]=(n.dnd.start||'22:00').split(':').map(Number),[eh,em]=(n.dnd.end||'08:00').split(':').map(Number); const cur=new Date().getHours()*60+new Date().getMinutes(),s=sh*60+sm,e=eh*60+em; return s<e?(cur>=s&&cur<e):(cur>=s||cur<e);}
function ping(){ const n=notify(); if(!n.sound||inDND()) return; try{audioCtx=audioCtx||new (window.AudioContext||window.webkitAudioContext)(); const o=audioCtx.createOscillator(),g=audioCtx.createGain(); o.type='sine';o.frequency.value=880;g.gain.value=0.001;o.connect(g);g.connect(audioCtx.destination);o.start();setTimeout(()=>o.stop(),120);}catch{} }

/* ===== Media helpers (kept) ===== */
function ytEmbed(url){ if(!url) return null; try{new URL(url);}catch{return null;} if(url.includes('youtube.com/watch?v=')) return url.replace('watch?v=','embed/')+(url.includes('?')?'&':'?')+'rel=0'; if(url.includes('youtu.be/')) return url.replace('youtu.be/','www.youtube.com/embed/')+(url.includes('?')?'&':'?')+'rel=0'; return null; }
function ytIdFromEmbed(embed){ try{ const u=new URL(embed); const m=u.pathname.match(/embed\/([a-zA-Z0-9_-]+)/); return m?m[1]:null; }catch{return null;} }
function mediaFromURL(url){ if(!url) return null; try{new URL(url);}catch{return null;} const yt=ytEmbed(url); if(yt) return {type:'embed',src:yt,allow:'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share'}; const s=url.toLowerCase(); if(/\.(mp3|wav|ogg|m4a|aac)(\?|$)/.test(s)) return {type:'audio',src:url}; if(/\.(mp4|webm|ogv|mov)(\?|$)/.test(s)) return {type:'video',src:url}; return {type:'link',src:url}; }
function fileToMedia(file){ return new Promise((res,rej)=>{const r=new FileReader(); r.onerror=()=>rej('read'); r.onload=e=>{ if(file.type.startsWith('audio/')) res({type:'audio',src:e.target.result}); else if(file.type.startsWith('video/')) res({type:'video',src:e.target.result}); else res(null); }; r.readAsDataURL(file); }); }

/* ===== Data ===== */
let TRACKS=(load(LS.MUSIC,[])||[]).map(t=>({...t,likes:Array.from(new Set(t.likes||[])),comments:(t.comments||[]).map(c=>({...c,likes:Array.from(new Set(c.likes||[]))}))}));
let PLAYLISTS=load(LS.PLAYLISTS,{});
(function upgradePlaylists(){ let changed=false; if(Array.isArray(PLAYLISTS)){PLAYLISTS={};changed=true;} Object.keys(PLAYLISTS).forEach(k=>{const v=PLAYLISTS[k]; if(Array.isArray(v)){PLAYLISTS[k]={desc:'',ids:v};changed=true;} else if(!v||!Array.isArray(v.ids)){PLAYLISTS[k]={desc:'',ids:[]};changed=true;} }); if(changed) save(LS.PLAYLISTS,PLAYLISTS);})();
const saveTracks=()=>save(LS.MUSIC,TRACKS), savePlaylists=()=>save(LS.PLAYLISTS,PLAYLISTS);
let FAVES=new Set(load(LS.FAVES,[])); const saveFaves=()=>save(LS.FAVES,[...FAVES]);

/* ===== Posting-as (modal picker) ===== */
const Users=load(LS.USERS,[]);
function currentActor(){ const saved=(load(LS.ACTOR,'Chatternet')||'Chatternet'); return Users.find(u=>u.name===saved)?saved:'Me'; }
function setActor(name){ save(LS.ACTOR,name); refreshActorUI(); renderGallery(); }
function refreshActorUI(){ const name=currentActor(); const u=userByName(name); $('#actorAva').src=u.avatar; $('#actorName').textContent=`Posting as ${u.name}`; $('#postingAsHint').textContent=`Your likes/comments will also use “${u.name}”.`; }
refreshActorUI();
$('#rememberActor').onclick=()=>{ save(LS.ACTOR,currentActor()); addNotif(`Default actor set to ${currentActor()}.`); };

const actBg=$('#actorBg'), actList=$('#actorList'), actSearch=$('#actorSearch');
$('#actorChange').onclick=()=>{ openActorPicker(); };
$('#actorClose').onclick=()=>{ actBg.style.display='none'; };
$('#actorDefault').onclick=()=>{ save(LS.ACTOR,currentActor()); addNotif(`Default actor set to ${currentActor()}.`); };
function openActorPicker(){ actBg.style.display='flex'; buildActorList(''); actSearch.value=''; actSearch.focus(); }
function buildActorList(q){ const cur=currentActor(); const term=(q||'').toLowerCase(); actList.innerHTML=''; Users.filter(u=>u.name.toLowerCase().includes(term)).forEach(u=>{ const row=document.createElement('div'); row.className='actor-row'; row.innerHTML=`<img src="${esc(u.avatar)}"><div style="flex:1"><strong>${esc(u.name)}</strong>${u.name===cur?' <span class="muted">(current)</span>':''}</div>`; row.onclick=()=>{ setActor(u.name); actBg.style.display='none'; }; actList.appendChild(row); }); }
actSearch.addEventListener('input',e=>buildActorList(e.target.value));

/* ===== Feed bridge ===== */
function addToGlobalFeed(t){
  const posts=load(LS.FEED,[]); let media=null;
  if(t.media){ if(t.media.type==='video') media={type:'video',src:t.media.src}; else if(t.media.type==='audio'||t.media.type==='link') media={type:'link',src:t.media.src}; else if(t.media.type==='embed') media={type:'embed',src:t.media.src,allow:t.media.allow||''}; }
  posts.push({id:uid('p'), title:t.title, content:(t.description||'')+(t.caption?`\n\n“${t.caption}”`:''), authorName:t.authorName, createdAt:nowISO(), media, comments:[], likes:[]});
  save(LS.FEED,posts); addNotif(`${t.authorName} added “${t.title}” to the Feed.`); ping();
}

/* ===== Uploader ===== */
const playlistSelect=$('#playlistSelect');
function rebuildPlaylistSelect(){ playlistSelect.innerHTML='<option value="">— Add to Playlist (optional) —</option>'; Object.keys(PLAYLISTS).forEach(name=>{ const o=document.createElement('option'); o.value=name; o.textContent=name; playlistSelect.appendChild(o); }); }
$('#createPlaylistBtn').onclick=()=>{ const name=$('#newPlaylistName').value.trim(); const desc=$('#newPlaylistDesc').value.trim(); if(!name) return alert('Enter playlist name'); if(PLAYLISTS[name]) return alert('Playlist exists'); PLAYLISTS[name]={desc,ids:[]}; savePlaylists(); $('#newPlaylistName').value=''; $('#newPlaylistDesc').value=''; rebuildPlaylistSelect(); rebuildPlaylistList(); addNotif(`Created playlist “${name}”.`); ping(); };

$('#uploadMusicBtn').onclick=async ()=>{
  const title=$('#musicTitle').value.trim();
  const description=$('#musicDescription').value.trim();
  const caption=$('#musicCaption').value.trim();
  const author=currentActor();
  const file=$('#musicFile').files[0]; const url=($('#musicURL').value||'').trim();
  const pName=$('#playlistSelect').value;
  if(!title || (!file && !url)) return alert('Provide a title and a file or URL');
  let media=null; if(file){ media=await fileToMedia(file).catch(()=>null); } else media=mediaFromURL(url);
  if(!media) return alert('Unsupported file/URL');

  const tr={ id:uid('t'), title, description, caption, authorName:author, createdAt:nowISO(), media, likes:[], comments:[] };
  TRACKS.push(tr); saveTracks();
  if(pName){ PLAYLISTS[pName]=PLAYLISTS[pName]||{desc:'',ids:[]}; if(!PLAYLISTS[pName].ids.includes(tr.id)) PLAYLISTS[pName].ids.unshift(tr.id); savePlaylists(); rebuildPlaylistList(); }
  $('#musicTitle').value=''; $('#musicDescription').value=''; $('#musicCaption').value=''; $('#musicFile').value=''; $('#musicURL').value=''; $('#playlistSelect').value='';
  addNotif(`${author} uploaded “${title}”.`); ping();
  rebuildPlaylistSelect(); renderGallery();
};

/* ===== Playlist helpers ===== */
function playlistsContaining(id){ return Object.keys(PLAYLISTS).filter(n=>(PLAYLISTS[n].ids||[]).includes(id)); }
function addTrackToPlaylist(trackId, name){ PLAYLISTS[name]=PLAYLISTS[name]||{desc:'',ids:[]}; const ids=PLAYLISTS[name].ids; if(!ids.includes(trackId)){ ids.unshift(trackId); savePlaylists(); addNotif('Added to playlist.'); rebuildPlaylistList(); renderGallery(); } }
function removeTrackFromPlaylist(trackId, name){ const ids=PLAYLISTS[name].ids||[]; PLAYLISTS[name].ids=ids.filter(x=>x!==trackId); savePlaylists(); }
function deletePlaylist(name){ if(!PLAYLISTS[name]) return; if(!confirm(`Delete playlist “${name}”?`)) return; delete PLAYLISTS[name]; savePlaylists(); rebuildPlaylistSelect(); rebuildPlaylistList(); addNotif(`Deleted playlist “${name}”.`); }

/* ===== Playlist list + editor ===== */
const playlistContainer=$('#playlistContainer');
let editingPl=null;
const plEditBg=$('#plEditBg'); const plEditName=$('#plEditName'); const plEditDesc=$('#plEditDesc'); const plEditList=$('#plEditList');
function openEditPlaylist(name){
  editingPl = name;
  plEditName.value = name;
  plEditDesc.value = PLAYLISTS[name]?.desc||'';
  rebuildEditList();
  plEditBg.style.display='flex';
}
function rebuildEditList(){
  plEditList.innerHTML='';
  const ids=(PLAYLISTS[editingPl]?.ids||[]).filter(id=>TRACKS.some(t=>t.id===id));
  if(!ids.length){ plEditList.innerHTML='<div class="muted">(empty)</div>'; return; }
  ids.forEach(id=>{
    const t=TRACKS.find(x=>x.id===id);
    const row=document.createElement('div'); row.className='pl-row';
    row.innerHTML=`<div style="flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title)}</div>`;
    const rm=document.createElement('button'); rm.className='btn danger'; rm.textContent='Remove';
    rm.onclick=()=>{ removeTrackFromPlaylist(id, editingPl); rebuildEditList(); rebuildPlaylistList(); renderGallery(); };
    row.appendChild(rm); plEditList.appendChild(row);
  });
}
$('#plSave').onclick=()=>{ const newName=plEditName.value.trim(); const desc=plEditDesc.value.trim(); if(!newName) return alert('Name required'); if(newName!==editingPl && PLAYLISTS[newName]) return alert('A playlist with that name already exists.');
  const ids=PLAYLISTS[editingPl]?.ids||[]; delete PLAYLISTS[editingPl]; PLAYLISTS[newName]={desc,ids}; savePlaylists(); editingPl=newName; plEditBg.style.display='none'; rebuildPlaylistSelect(); rebuildPlaylistList(); renderGallery(); addNotif('Playlist updated.'); };
$('#plClose').onclick=()=>{ plEditBg.style.display='none'; };

function rebuildPlaylistList(){
  playlistContainer.innerHTML='';
  const names=Object.keys(PLAYLISTS);
  if(!names.length){ playlistContainer.innerHTML='<div class="empty">No playlists yet.</div>'; return; }
  names.forEach(name=>{
    const box=document.createElement('div'); box.style.marginBottom='12px';
    const head=document.createElement('div'); head.className='row'; head.style.justifyContent='space-between';
    head.innerHTML=`<div><strong>${esc(name)}</strong><div class="muted">${esc(PLAYLISTS[name].desc||'')}</div></div>`;
    const act=document.createElement('div'); act.style.display='flex'; act.style.gap='8px';
    const playBtn=document.createElement('button'); playBtn.className='btn ghost'; playBtn.textContent='Play All'; playBtn.onclick=()=>queueAndStart(PLAYLISTS[name].ids);
    const editBtn=document.createElement('button'); editBtn.className='btn ghost'; editBtn.textContent='Edit'; editBtn.onclick=()=>openEditPlaylist(name);
    const delBtn=document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='Delete'; delBtn.onclick=()=>deletePlaylist(name);
    act.append(playBtn,editBtn,delBtn); head.appendChild(act); box.appendChild(head);

    const ids=(PLAYLISTS[name].ids||[]).filter(id=>TRACKS.some(t=>t.id===id));
    if(!ids.length){ const p=document.createElement('div'); p.textContent='(empty)'; p.className='muted'; p.style.padding='6px 0'; box.appendChild(p); }
    else { ids.forEach(id=>{ const t=TRACKS.find(x=>x.id===id); const row=document.createElement('div'); row.style.padding='6px 0'; row.style.cursor='pointer'; row.textContent=t.title; row.onclick=()=>playTrack(t.id,true); box.appendChild(row); }); }
    playlistContainer.appendChild(box);
  });
}

/* ===== Gallery + cards ===== */
const gallery=$('#musicGallery'), galleryEmpty=$('#galleryEmpty');
function isBlockedName(name){ const blk=new Set((privacy().blocked)||[]); return blk.has(name); }
function heartBtn(active){ const b=document.createElement('button'); b.className='heart-btn'; if(active) b.classList.add('active'); b.innerHTML=`<svg viewBox="0 0 24 24"><path d="M12 21s-6.716-4.27-9.167-7.38C.63 11.154 1.57 7.9 3.985 6.54c1.75-1.01 4.005-.63 5.348.89L12 9.2l2.667-1.77c1.343-1.52 3.598-1.9 5.348-.89 2.414 1.36 3.354 4.614 1.152 7.08C18.716 16.73 12 21 12 21z"/></svg>`; return b; }
function commentEl(track,c){ const u=userByName(c.userName); const el=document.createElement('div'); el.className='comment';
  el.innerHTML=`<img class="c-avatar" src="${esc(u.avatar)}" data-profile-name="${esc(u.name)}"><div class="bubble"><span class="by" data-profile-name="${esc(u.name)}">${esc(u.name)}</span> <span class="muted">• ${rel(c.createdAt)}</span><div class="ctxt">${esc(c.text)}</div></div>`; return el; }

function trackCard(t){
  const wrap=document.createElement('div'); wrap.className='music-card'; wrap.id=`track-${t.id}`;
  const u=userByName(t.authorName);
  if(isBlockedName(t.authorName)){
    wrap.innerHTML=`<div class="muted">You blocked ${esc(t.authorName)} — upload hidden. <a href="settings.html?tab=privacy">Manage block list</a></div>`; return wrap;
  }
  let mediaHTML=''; if(t.media){ if(t.media.type==='audio') mediaHTML=`<div class="media"><audio controls src="${esc(t.media.src)}"></audio></div>`;
    else if(t.media.type==='video') mediaHTML=`<div class="media"><video controls src="${esc(t.media.src)}"></video></div>`;
    else if(t.media.type==='embed') mediaHTML=`<div class="media"><iframe src="${esc(t.media.src)}" allow="${t.media.allow||''}" frameborder="0" allowfullscreen></iframe></div>`;
    else if(t.media.type==='link') mediaHTML=`<div class="media"><audio controls src="${esc(t.media.src)}"></audio></div>`; }

  const where=playlistsContaining(t.id);
  wrap.innerHTML=`
    <header>
      <img class="avatar" src="${esc(u.avatar)}" data-profile-name="${esc(u.name)}">
      <div>
        <div class="author" data-profile-name="${esc(u.name)}">${esc(u.name)}</div>
        <div class="meta">${new Date(t.createdAt).toLocaleString()} • ${rel(t.createdAt)}${where.length?` • in ${where.length===1?esc(where[0]):(where.length+' playlists')}`:''}</div>
      </div>
    </header>
    <div class="title">${esc(t.title)}</div>
    ${t.description?`<div class="desc">${esc(t.description)}</div>`:''}
    ${t.caption?`<div class="caption">“${esc(t.caption)}”</div>`:''}
    ${mediaHTML}
  `;

  const util=document.createElement('div'); util.className='util';
  t.likes=t.likes||[]; const me=currentActor(); const like=heartBtn(t.likes.includes(me)); const likeCnt=document.createElement('span'); likeCnt.className='like-count'; likeCnt.textContent=String(t.likes.length);
  like.onclick=()=>{ const set=new Set(t.likes||[]); set.has(me)?set.delete(me):set.add(me); t.likes=[...set]; like.classList.toggle('active',set.has(me)); likeCnt.textContent=String(set.size); const ix=TRACKS.findIndex(x=>x.id===t.id); if(ix>-1){TRACKS[ix].likes=t.likes; saveTracks();} };
  const likeLbl=document.createElement('span'); likeLbl.className='muted'; likeLbl.textContent='Like •';

  const favBtn=document.createElement('button'); favBtn.className='btn ghost'; favBtn.textContent=FAVES.has(t.id)?'★ Favorited':'☆ Favorite';
  favBtn.onclick=()=>{ if(FAVES.has(t.id)) FAVES.delete(t.id); else FAVES.add(t.id); favBtn.textContent=FAVES.has(t.id)?'★ Favorited':'☆ Favorite'; saveFaves(); };

  const qAdd=document.createElement('button'); qAdd.className='btn ghost'; qAdd.textContent='Add to Queue'; qAdd.onclick=()=>{ enqueue(t.id); };
  const qPlay=document.createElement('button'); qPlay.className='btn primary'; qPlay.textContent='Play'; qPlay.onclick=()=>playTrack(t.id,true);

  const share=document.createElement('button'); share.className='btn ghost'; share.textContent='Add to Global Feed'; share.onclick=()=>{ addToGlobalFeed(t); alert('Added to Feed!'); };
  const linkBtn=document.createElement('button'); linkBtn.className='btn ghost'; linkBtn.textContent='Copy Link'; linkBtn.onclick=()=>{ const url=location.origin+location.pathname+'#track-'+t.id; navigator.clipboard.writeText(url); addNotif('Track link copied.'); ping(); };

  const canDel = me===t.authorName; const del=document.createElement('button'); del.className='btn danger'; del.textContent='Delete Upload'; del.style.display=canDel?'inline-flex':'none'; del.onclick=()=>deleteTrack(t.id);

  util.append(like,likeLbl,likeCnt,favBtn,qAdd,qPlay,share,linkBtn,del); wrap.appendChild(util);

  /* Add-to-playlist row */
  const ap=document.createElement('div'); ap.className='add-pl';
  const sel=document.createElement('select'); sel.style.maxWidth='260px';
  sel.innerHTML = `<option value="">— Add to Playlist —</option>` + Object.keys(PLAYLISTS).map(n=>`<option value="${esc(n)}"${(PLAYLISTS[n].ids||[]).includes(t.id)?' disabled':''}>${esc(n)}${(PLAYLISTS[n].ids||[]).includes(t.id)?' (added)':''}</option>`).join('');
  const addBtn=document.createElement('button'); addBtn.className='btn ghost'; addBtn.textContent='Add';
  addBtn.onclick=()=>{ const name=sel.value; if(!name) return alert('Choose a playlist'); addTrackToPlaylist(t.id,name); sel.value=''; };
  const newBtn=document.createElement('button'); newBtn.className='btn ghost'; newBtn.textContent='New +'; newBtn.title='Create a new playlist above'; newBtn.onclick=()=>{ document.getElementById('newPlaylistName').focus(); };
  ap.append(sel,addBtn,newBtn); wrap.appendChild(ap);

  /* Comments */
  const cWrap=document.createElement('div'); cWrap.className='comments';
  const ok=!!privacy().mentions;
  cWrap.innerHTML=`<div class="row"><input class="cIn" placeholder="${ok?'Write a comment':'Wall comments disabled by Privacy settings'}" ${ok?'':'disabled'}><button class="btn primary cGo" ${ok?'':'disabled'}>Comment</button></div><div class="cList"></div>`;
  const cList=cWrap.querySelector('.cList'); (t.comments||[]).forEach(c=>cList.appendChild(commentEl(t,c)));
  cWrap.querySelector('.cGo').onclick=()=>{ const input=cWrap.querySelector('.cIn'); const text=input.value.trim(); if(!text) return; if(!ok) return alert('Comments disabled by privacy settings'); const c={id:uid('c'),userName:me,text,createdAt:nowISO(),likes:[]}; const ix=TRACKS.findIndex(x=>x.id===t.id); if(ix>-1){TRACKS[ix].comments=TRACKS[ix].comments||[]; TRACKS[ix].comments.push(c); saveTracks();} cList.prepend(commentEl(t,c)); input.value=''; addNotif(`${me} commented on “${t.title}”.`); ping(); };
  wrap.appendChild(cWrap);

  return wrap;
}

function deleteTrack(id){
  const t=TRACKS.find(x=>x.id===id); if(!t) return;
  if(!confirm(`Delete upload “${t.title}”?`)) return;
  TRACKS=TRACKS.filter(x=>x.id!==id); saveTracks();
  Object.keys(PLAYLISTS).forEach(n=>{ PLAYLISTS[n].ids=(PLAYLISTS[n].ids||[]).filter(x=>x!==id); }); savePlaylists();
  FAVES.delete(id); saveFaves();
  addNotif(`Deleted upload: ${t.title}`); renderGallery(); rebuildPlaylistList();
}

function renderGallery(){
  const q=($('#searchBox').value||'').toLowerCase(); const sort=$('#sortSel').value; const filter=$('#filterSel').value;
  let list=[...TRACKS];
  list=list.filter(t=>!isBlockedName(t.authorName));
  list=list.filter(t=>(t.title||'').toLowerCase().includes(q) || (t.authorName||'').toLowerCase().includes(q));
  if(filter==='mine') list=list.filter(t=>t.authorName===currentActor());
  if(filter==='faves') list=list.filter(t=>FAVES.has(t.id));
  if(sort==='new') list.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  if(sort==='liked') list.sort((a,b)=>(b.likes?.length||0)-(a.likes?.length||0));
  if(sort==='title') list.sort((a,b)=>String(a.title||'').localeCompare(String(b.title||'')));

  gallery.innerHTML='';
  if(!list.length){ galleryEmpty.style.display='block'; return; }
  galleryEmpty.style.display='none';
  list.forEach(t=>gallery.appendChild(trackCard(t)));
}
$('#searchBox').addEventListener('input',renderGallery);
$('#sortSel').addEventListener('change',renderGallery);
$('#filterSel').addEventListener('change',renderGallery);

/* ===== Queue + mini player (kept) ===== */
let QUEUE=[], CURRENT=null, LOOP=false, SPEED=1, VOLUME=1, PREV=[];
const bar=$('#playerBar'), pTitle=$('#pTitle'), pMeta=$('#pMeta'), pAva=$('#pAva'), qCount=$('#qCount');
const playBtn=$('#playBtn'), prevBtn=$('#prevBtn'), nextBtn=$('#nextBtn'), loopBtn=$('#loopBtn'), queueBtn=$('#queueBtn'), copyBtn=$('#copyBtn'), speedSel=$('#speedSel'), volRange=$('#volRange'), closeBtn=$('#closePlayer');
const audioEl=$('#miniAudio'), videoEl=$('#miniVideo'); let ytPlayer=null, ytReady=false;
function ensureYT(){return new Promise(res=>{if(ytReady){res(true);return;} if(window.YT&&YT.Player){ytReady=true;res(true);return;} const s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; document.head.appendChild(s); window.onYouTubeIframeAPIReady=()=>{ytReady=true;res(true);};});}
function ensureYTPlayer(){return ensureYT().then(()=>{ if(ytPlayer) return ytPlayer; ytPlayer=new YT.Player('ytMiniHolder',{width:200,height:112,videoId:null,events:{onStateChange:(e)=>{ if(e.data===0){ if(LOOP){ ytPlayer.seekTo(0,true); ytPlayer.playVideo(); } else next(); } playBtn.textContent=(e.data===1)?'⏸ Pause':'▶ Play'; }},playerVars:{controls:0,playsinline:1,rel:0}}); return ytPlayer;});}
function setBarVisible(on){ bar.style.display=on?'block':'none'; }
function updateBar(t){ const u=userByName(t.authorName); pTitle.textContent=t.title||'—'; pMeta.textContent=`${t.authorName} • ${new Date(t.createdAt).toLocaleString()}`; pAva.src=u.avatar; qCount.textContent=String(QUEUE.length); }
let mode='none';
function stopAll(){ try{audioEl.pause();}catch{} try{videoEl.pause();}catch{} if(ytPlayer&&ytReady){ try{ ytPlayer.stopVideo(); }catch{} } }
function loadAndPlay(t){
  stopAll(); updateBar(t); setBarVisible(true);
  if(t.media?.type==='audio' || t.media?.type==='link'){
    mode='audio'; audioEl.src=t.media.src; audioEl.loop=false; audioEl.playbackRate=SPEED; audioEl.volume=VOLUME; audioEl.onended=()=>{ if(LOOP){ audioEl.currentTime=0; audioEl.play(); } else next(); }; audioEl.play().catch(()=>{}); playBtn.textContent='⏸ Pause';
  } else if(t.media?.type==='video'){
    mode='video'; videoEl.src=t.media.src; videoEl.loop=false; videoEl.playbackRate=SPEED; videoEl.volume=VOLUME; videoEl.onended=()=>{ if(LOOP){ videoEl.currentTime=0; videoEl.play(); } else next(); }; videoEl.play().catch(()=>{}); playBtn.textContent='⏸ Pause';
  } else if(t.media?.type==='embed'){
    mode='yt'; ensureYTPlayer().then(p=>{ const vid=ytIdFromEmbed(t.media.src); if(vid){ p.loadVideoById({videoId:vid}); p.setPlaybackRate(SPEED); p.setVolume(Math.round(VOLUME*100)); playBtn.textContent='⏸ Pause'; } else { playBtn.textContent='▶ Play'; } });
  } else { mode='none'; playBtn.textContent='▶ Play'; }
}
function playTrack(id,replace=false){ const t=TRACKS.find(x=>x.id===id); if(!t) return; if(CURRENT&&CURRENT!==id) PREV.push(CURRENT); CURRENT=t.id; if(replace){ QUEUE=[...QUEUE.filter(x=>x!==id)]; } loadAndPlay(t); document.getElementById('track-'+t.id)?.scrollIntoView({behavior:'smooth',block:'center'}); }
function enqueue(id){ if(!QUEUE.includes(id)) QUEUE.push(id); qCount.textContent=String(QUEUE.length); setBarVisible(true); addNotif('Added to queue'); }
function queueAndStart(ids){ QUEUE=[...ids]; qCount.textContent=String(QUEUE.length); if(QUEUE.length) playTrack(QUEUE.shift(),true); }
function next(){ if(QUEUE.length){ const id=QUEUE.shift(); qCount.textContent=String(QUEUE.length); playTrack(id,true);} }
function prev(){ const id=PREV.pop(); if(id){ playTrack(id,true); } }
playBtn.onclick=()=>{ if(mode==='audio'){ if(audioEl.paused){ audioEl.play(); playBtn.textContent='⏸ Pause'; } else { audioEl.pause(); playBtn.textContent='▶ Play'; } } else if(mode==='video'){ if(videoEl.paused){ videoEl.play(); playBtn.textContent='⏸ Pause'; } else { videoEl.pause(); playBtn.textContent='▶ Play'; } } else if(mode==='yt'&&ytPlayer){ const s=ytPlayer.getPlayerState(); if(s!==1){ ytPlayer.playVideo(); playBtn.textContent='⏸ Pause'; } else { ytPlayer.pauseVideo(); playBtn.textContent='▶ Play'; } } };
$('#prevBtn').onclick=prev; $('#nextBtn').onclick=next; $('#loopBtn').onclick=()=>{ LOOP=!LOOP; $('#loopBtn').classList.toggle('active',LOOP); };
$('#queueBtn').onclick=()=>alert(`Queue: ${QUEUE.length} item(s)`); $('#copyBtn').onclick=()=>{ if(!CURRENT) return; const url=location.origin+location.pathname+'#track-'+CURRENT; navigator.clipboard.writeText(url); addNotif('Track link copied.'); ping(); };
$('#speedSel').onchange=()=>{ const v=parseFloat($('#speedSel').value||'1'); SPEED=v; audioEl.playbackRate=v; videoEl.playbackRate=v; if(ytPlayer&&ytReady){ try{ ytPlayer.setPlaybackRate(v); }catch{} } };
$('#volRange').oninput=()=>{ const v=parseFloat($('#volRange').value||'1'); VOLUME=v; audioEl.volume=v; videoEl.volume=v; if(ytPlayer&&ytReady){ try{ ytPlayer.setVolume(Math.round(v*100)); }catch{} } };
$('#closePlayer').onclick=()=>{ stopAll(); setBarVisible(false); CURRENT=null; QUEUE=[]; PREV=[]; qCount.textContent='0'; };

/* Boot */
function bootFromHash(){ const h=location.hash||''; const id=h.startsWith('#track-')?h.slice(7):''; if(id && TRACKS.some(t=>t.id===id)){ playTrack(id,true); } }
function rebuildAll(){ rebuildPlaylistSelect(); rebuildPlaylistList(); renderGallery(); refreshActorUI(); }
(function boot(){ rebuildAll(); bootFromHash(); })();
window.addEventListener('hashchange',bootFromHash);
</script>

</body>
</html>
