<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Chatter Market — Chatternet</title>
<style>
  :root{
    --blueTop:132px; --barH:52px; --navH:48px;
    --pagePad:calc(var(--blueTop)+var(--barH)+var(--navH));
    --ink:#0f172a; --muted:#64748b; --line:#e6eaf2; --brand:#0ea5e9;
  }
  html,body{margin:0;padding:0;background:#f5f7fb;color:var(--ink);
    font:14px/1.45 Arial,"Segoe UI",system-ui,-apple-system,sans-serif}
  a{color:#2563eb;text-decoration:none}
  *{box-sizing:border-box}

  /* Blue bar */
  .top-bar{position:fixed;left:0;right:0;top:var(--blueTop);z-index:1200;display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--brand);color:#fff;border-bottom:1px solid rgba(255,255,255,.2)}
  .top-bar h2{margin:0;font-size:18px;font-weight:800}
  .pillbtn{height:36px;padding:0 12px;border-radius:999px;border:1px solid rgba(255,255,255,.7);background:rgba(255,255,255,.15);color:#fff;cursor:pointer}
  .pillbtn:hover{background:rgba(255,255,255,.26)}
  #meAvatar{width:36px;height:36px;border-radius:999px;border:2px solid rgba(255,255,255,.7);object-fit:cover;cursor:pointer}

  /* App nav */
  nav.app-nav{position:fixed;left:0;right:0;top:calc(var(--blueTop)+var(--barH));z-index:1190;background:#fff;border-bottom:1px solid #e6eaf2}
  nav.app-nav .inner{max-width:1180px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px}
  nav.app-nav a{display:inline-block;padding:8px 10px;border-radius:999px;color:#111;background:#f3f4f6;text-decoration:none;font-weight:600}
  nav.app-nav a.active{background:#dbeafe;color:#1e3a8a}
  nav.app-nav a:hover{background:#e5e7eb}

  /* Page shell */
  .page{max-width:1180px;margin:14px auto;padding:0 12px;padding-top:var(--pagePad)}

  /* ===== Typography reset JUST for Market content ===== */
  .market-reset, .market-reset *{
    letter-spacing: normal !important;
    word-spacing: normal !important;
    font-stretch: normal !important;
    font-variant: normal !important;
    font-variant-numeric: normal !important; /* stops tabular/lining spacing from themes */
    text-transform: none !important;
  }

  .card{background:#fff;border:1px solid #e6eaf2;border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(15,23,42,.03)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .muted{color:var(--muted)}
  .btn{padding:8px 12px;border:1px solid #d7d7d7;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:#3b82f6;border-color:#3b82f6;color:#fff}
  .btn.primary:hover{background:#2563eb}
  .btn.bad{background:#fee2e2;border-color:#fecaca;color:#991b1b}

  /* Tabs like Feed chips, stretched */
  .tabs-wrap.card{padding-bottom:10px}
  .tabs{display:grid;gap:10px;grid-template-columns:repeat(6,1fr)}
  @media (max-width:980px){.tabs{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:560px){.tabs{grid-template-columns:repeat(2,1fr)}}
  .tab{width:100%;text-align:center;padding:10px 12px;border-radius:999px;border:1px solid #dfe3f0;background:#f3f4f6;font-weight:700;cursor:pointer}
  .tab.active{background:#dbeafe;border-color:#cfe1ff;color:#1e3a8a}

  /* FEED LAYOUT for all item lists (single column) */
  .grid{display:grid;grid-template-columns:1fr;gap:14px}

  /* Post-like item card */
  .item{border:1px solid #e6eaf2;border-radius:14px;background:#fff;overflow:hidden;display:flex;flex-direction:column}
  .item .img{width:100%;height:auto;max-height:520px;object-fit:cover;background:#f3f4f6;display:block}
  .i-body{padding:12px}
  .price{
    font-weight:800;
    font-size:20px;
    line-height:1.2 !important;
    margin:0 0 4px;
  }
  .title{
    font-weight:800;
    font-size:16px;
    line-height:1.3 !important;
    margin:0 0 3px;
    white-space:normal; overflow-wrap:anywhere; hyphens:auto;
  }
  .i-meta{color:var(--muted);font-size:13px;line-height:1.3 !important}
  .seller{display:flex;gap:8px;align-items:center;margin-top:8px}
  .ava{width:28px;height:28px;border-radius:50%;object-fit:cover;border:1px solid #e6eaf2}
  .i-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  .stars{display:inline-flex;gap:2px}
  .star{width:14px;height:14px;display:inline-block;background:linear-gradient(0deg,#fbbf24,#f59e0b);
    -webkit-mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>') no-repeat center/contain;
            mask:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 17.27 18.18 21 16.54 13.97 22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/></svg>') no-repeat center/contain}

  /* Modals + cart */
  .modalbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:4000}
  .sheet{background:#fff;border-radius:14px;max-width:960px;width:94%;max-height:88vh;overflow:auto;box-shadow:0 18px 50px rgba(0,0,0,.35);padding:16px}
  .gallery{display:grid;grid-template-columns:1.1fr 1fr;gap:14px}
  @media (max-width:900px){.gallery{grid-template-columns:1fr}}
  .g-main{border:1px solid #e6eaf2;border-radius:12px;overflow:hidden}
  .g-main img{width:100%;height:420px;object-fit:cover;display:block;background:#f3f4f6}
  .thumbs{display:flex;gap:8px;margin-top:8px;flex-wrap:wrap}
  .thumbs img{width:70px;height:70px;object-fit:cover;border-radius:8px;border:2px solid transparent;cursor:pointer}
  .thumbs img.active{border-color:#3b82f6}

  .cart-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;z-index:3990}
  .cart{position:fixed;right:0;top:0;bottom:0;width:min(420px,92vw);background:#fff;box-shadow:-8px 0 24px rgba(0,0,0,.25);transform:translateX(100%);transition:transform .25s ease;z-index:4001;display:flex;flex-direction:column}
  .cart.open{transform:translateX(0)}
  .cart-head{padding:14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #e6eaf2}
  .cart-list{padding:12px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:10px}
  .c-item{display:flex;gap:10px;border:1px solid #e6eaf2;border-radius:12px;padding:10px}
  .c-item img{width:64px;height:64px;object-fit:cover;border-radius:8px}
  .cart-foot{border-top:1px solid #e6eaf2;padding:14px}

  /* Saved-for-later (wishlist) inside cart */
  .cart-saved{border-top:1px dashed #e6eaf2;padding:12px}
  .saved-item{display:flex;gap:10px;border:1px dashed #e6eaf2;border-radius:12px;padding:10px;margin-top:8px}

  /* Toast */
  #toast{position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111;color:#fff;padding:10px 14px;border-radius:10px;opacity:0;pointer-events:none;transition:opacity .2s;z-index:5000}
  #toast.show{opacity:1}
</style>

<!-- Positioner: slots blue bar between Weebly header and app nav -->
<script>
(function(){
  var GAP=12, MENU_SELS=['.wsite-nav','.wsite-menu-default','.wsite-menus','.w-nav','.nav-wrapper','.navbar','.siteHeader .nav','.desktop-nav','.top-nav','nav[role="navigation"]','.site-navigation'];
  function pickMenuBottom(){var bottoms=[];for(var i=0;i<MENU_SELS.length;i++){var el=document.querySelector(MENU_SELS[i]);if(!el)continue;var r=el.getBoundingClientRect(),h=r.height,w=r.width;var ok=h>=32&&h<=120&&r.top>-20&&r.top<180&&w>300;if(ok)bottoms.push(Math.round(r.bottom));}var best=bottoms.length?Math.min.apply(null,bottoms):120;if(best>200)best=120;try{var force=localStorage.getItem('ct_force_header_px');if(force)best=parseInt(force,10)||best;}catch{}return best;}
  function measure(el,fb){if(!el)return fb;var r=el.getBoundingClientRect();return Math.max(fb,Math.round(r.height));}
  function apply(){var blueTop=pickMenuBottom()+GAP;var barH=measure(document.querySelector('.top-bar'),52);var navH=measure(document.querySelector('nav.app-nav'),48);
    document.documentElement.style.setProperty('--blueTop',blueTop+'px');
    document.documentElement.style.setProperty('--barH',barH+'px');
    document.documentElement.style.setProperty('--navH',navH+'px');
    document.documentElement.style.setProperty('--pagePad',(blueTop+barH+navH)+'px');}
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',apply);}else{apply();}
  addEventListener('resize',apply,{passive:true}); addEventListener('orientationchange',apply,{passive:true});
})();
</script>
</head>
<body>

<!-- Blue bar -->
<div class="top-bar">
  <h2>Chatter Market</h2>
  <div class="top-actions">
    <button id="btnNotif" class="pillbtn" type="button">Notifications</button>
    <button id="btnInbox" class="pillbtn" type="button">Inbox</button>
    <button id="btnMsgs" class="pillbtn" type="button">Messages</button>
    <button id="cartBtn" class="pillbtn" type="button">Cart</button>
    <img id="meAvatar" alt="My Profile" title="My Profile"/>
  </div>
</div>

<!-- App nav -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="friends.html">Friends</a>
    <a class="active" href="chattermarket.html" aria-current="page">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a href="music.html">Music</a>
    <a href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- Page -->
<div class="page market-reset"><!-- market-reset fixes odd spacing from theme -->

  <!-- Tabs + filters -->
  <section class="card tabs-wrap">
    <div class="tabs" id="tabs">
      <button class="tab active" data-tab="browse" type="button">Browse</button>
      <button class="tab" data-tab="sell" type="button">Sell</button>
      <button class="tab" data-tab="mine" type="button">My Listings</button>
      <button class="tab" data-tab="recent" type="button">Recent</button>
      <button class="tab" data-tab="wishlist" type="button">Wishlist</button>
      <button class="tab" data-tab="reviews" type="button">Reviews</button>
    </div>

    <div class="filters row" data-panel="browse">
      <input id="q" class="input" placeholder="Search items…" style="flex:2 1 320px">
      <select id="cat" class="input" style="flex:1 1 180px">
        <option value="">All categories</option>
        <option>Electronics</option><option>Computers</option><option>Gaming</option>
        <option>Phones</option><option>Audio</option><option>Photography</option>
        <option>Home</option><option>Garden</option><option>DIY</option>
        <option>Fashion</option><option>Sports</option><option>Outdoors</option>
        <option>Cycling</option><option>Toys</option><option>Books</option>
        <option>Collectibles</option><option>Vehicles</option><option>Other</option>
      </select>
      <select id="cond" class="input" style="flex:1 1 160px">
        <option value="">Any condition</option>
        <option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>For parts</option>
      </select>
      <select id="cur" class="input" style="width:120px">
        <option value="">Any currency</option>
        <option value="USD">$ USD</option><option value="GBP">£ GBP</option><option value="EUR">€ EUR</option>
        <option value="CAD">$ CAD</option><option value="AUD">$ AUD</option>
      </select>
      <input id="minp" class="input" type="number" min="0" placeholder="Min">
      <input id="maxp" class="input" type="number" min="0" placeholder="Max">
      <select id="sort" class="input" style="flex:0 0 200px">
        <option value="relevance">Sort: Relevance</option>
        <option value="price-asc">Price: Low → High</option>
        <option value="price-desc">Price: High → Low</option>
        <option value="rating">Rating</option>
        <option value="newest">Newest</option>
      </select>
      <button id="apply" class="btn primary" type="button">Apply</button>
    </div>
  </section>

  <!-- Lists (feed style) -->
  <section id="results" class="card" data-panel="browse"><div id="grid" class="grid"></div></section>
  <section id="recentBox" class="card" data-panel="recent" style="display:none">
    <div class="row" style="justify-content:space-between;align-items:center">
      <h3 style="margin:0;font-size:18px">Recently viewed</h3>
      <button class="btn bad" data-act="clearRecent" type="button">Clear</button>
    </div>
    <div id="recentGrid" class="grid" style="margin-top:10px"></div>
  </section>
  <section id="wishBox" class="card" data-panel="wishlist" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0;font-size:18px">Wishlist</h3>
      <div class="row">
        <button class="btn primary" data-act="wishAllToCart" type="button">Add all to cart</button>
        <button class="btn bad" data-act="wishClear" type="button">Clear wishlist</button>
      </div>
    </div>
    <div id="wishGrid" class="grid" style="margin-top:10px"></div>
  </section>
  <section id="mineBox" class="card" data-panel="mine" style="display:none">
    <div class="row" style="justify-content:space-between">
      <h3 style="margin:0;font-size:18px">My Listings</h3>
      <button class="btn" data-tab="sell" type="button">Create new</button>
    </div>
    <div id="mineGrid" class="grid" style="margin-top:10px"></div>
  </section>
  <section id="reviewsBox" class="card" data-panel="reviews" style="display:none">
    <h3 style="margin:0 0 8px;font-size:18px">Your recent reviews</h3>
    <div id="myReviews"></div>
  </section>

  <!-- Sell -->
  <section id="sellBox" class="card" data-panel="sell" style="display:none">
    <h3 style="margin:0 0 8px;font-size:18px">Sell an Item</h3>
    <div class="row">
      <input id="tTitle" class="input" placeholder="Title" style="flex:2">
      <select id="tSeller" class="input" style="width:200px"></select>
    </div>
    <div class="row"><textarea id="tDesc" class="input" placeholder="Describe your item…" style="flex:1;min-height:110px"></textarea></div>
    <div class="row">
      <input id="tPrice" class="input" type="number" min="0" placeholder="Price">
      <select id="tCur" class="input" style="width:140px">
        <option value="USD">$ USD</option><option value="GBP">£ GBP</option><option value="EUR">€ EUR</option><option value="CAD">$ CAD</option><option value="AUD">$ AUD</option>
      </select>
      <select id="tCat" class="input" style="width:220px">
        <option>Electronics</option><option>Computers</option><option>Gaming</option><option>Phones</option><option>Audio</option><option>Photography</option>
        <option>Home</option><option>Garden</option><option>DIY</option><option>Fashion</option><option>Sports</option><option>Outdoors</option>
        <option>Vehicles</option><option>Collectibles</option><option>Other</option>
      </select>
      <select id="tCond" class="input" style="width:180px"><option>New</option><option>Like New</option><option>Good</option><option>Fair</option><option>For parts</option></select>
    </div>
    <div class="row">
      <input id="tTags" class="input" placeholder="Tags (comma separated)" style="flex:2">
      <input id="tLoc" class="input" placeholder="Location" style="flex:1">
    </div>
    <div class="row">
      <input id="tPhone" class="input" placeholder="Phone (optional)">
      <input id="tSite" class="input" placeholder="Website (optional)">
    </div>
    <div class="row">
      <label class="chip"><input id="dPickup" type="checkbox" style="accent-color:#3b82f6"> Pickup</label>
      <label class="chip"><input id="dShip" type="checkbox" style="accent-color:#3b82f6"> Shipping</label>
      <input id="dShipCost" class="input" type="number" min="0" placeholder="Shipping cost">
    </div>
    <div class="row" style="align-items:flex-start">
      <div class="card" style="flex:1">
        <strong>Images</strong>
        <div class="row" style="margin-top:6px">
          <input id="tImgUrl" class="input" placeholder="Add image URL">
          <button class="btn" data-act="addImgUrl" type="button">Add URL</button>
        </div>
        <div class="row" style="margin-top:6px">
          <input id="tImgFiles" type="file" accept="image/*" multiple>
          <button class="btn" data-act="addImgFiles" type="button">Add uploads</button>
        </div>
        <div id="tImgs" class="thumbs" style="margin-top:8px"></div>
      </div>
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="create" class="btn primary" type="button">Create Listing</button>
      <button id="clear" class="btn" type="button">Clear</button>
    </div>
  </section>

</div>

<!-- Notifs / Inbox -->
<div class="modalbg" id="notifBg"><div class="sheet"><h3 style="margin:0 0 10px">Notifications</h3><div id="notifList"></div><div class="row" style="margin-top:8px"><button id="clearNotif" class="btn primary" type="button">Clear</button><button id="closeNotif" class="btn" type="button">Close</button></div></div></div>
<div class="modalbg" id="inboxBg"><div class="sheet"><h3 style="margin:0 0 10px">Inbox</h3><div id="inboxList"></div><div class="row" style="margin-top:8px"><button id="closeInbox" class="btn" type="button">Close</button></div></div></div>

<!-- Product modal -->
<div class="modalbg" id="pBg" aria-hidden="true">
  <div class="sheet">
    <div class="gallery">
      <div>
        <div class="g-main"><img id="gMain" alt=""></div>
        <div id="gThumbs" class="thumbs"></div>
      </div>
      <div>
        <div class="chips"><span class="chip" id="pCat"></span><span class="chip" id="pCond"></span><span class="chip" id="pLoc"></span></div>
        <h3 id="pTitle" style="margin:8px 0 4px"></h3>
        <div class="row" style="gap:12px"><div id="pPrice" class="price"></div><div id="pStars" class="stars" title="Item rating"></div></div>
        <p id="pDesc" style="margin:8px 0"></p>
        <div class="seller">
          <img id="pSellerAva" class="ava" alt="">
          <div><div id="pSellerName" style="font-weight:700"></div><div class="stars" id="pSellerStars" title="Seller rating"></div></div>
        </div>
        <div class="chips" style="margin-top:8px">
          <span class="chip" id="pDelivery"></span>
          <span class="chip" id="pShipCost" style="display:none"></span>
          <a id="pPhone" class="chip" target="_blank" rel="noopener"></a>
          <a id="pSite" class="chip" target="_blank" rel="noopener"></a>
        </div>
        <div class="row" style="margin-top:10px;flex-wrap:wrap">
          <button id="pMsg" class="btn" type="button">Message Seller</button>
          <button id="pAdd" class="btn primary" type="button" data-act="add">Add to Cart</button>
          <button id="pWish" class="btn" type="button">♡ Wishlist</button>
          <button id="pShare" class="btn" type="button">Share to Feed</button>
          <button id="pReview" class="btn" type="button">Leave review</button>
          <button id="pClose" class="btn" type="button" style="margin-left:auto">Close</button>
        </div>
        <hr style="border:none;border-top:1px solid #e6eaf2;margin:12px 0">
        <div id="pReviewList"></div>
      </div>
    </div>
  </div>
</div>

<!-- Review modal -->
<div class="modalbg" id="rBg">
  <div class="sheet" style="max-width:520px">
    <h3 style="margin:0 0 8px">Leave a review</h3>
    <div class="row">
      <label>Stars
        <select id="rStars" class="input" style="width:120px">
          <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
        </select>
      </label>
      <input id="rName" class="input" placeholder="Display name" style="flex:1">
    </div>
    <div class="row"><textarea id="rText" class="input" placeholder="Write your thoughts…" style="min-height:100px"></textarea></div>
    <div class="row" style="justify-content:flex-end"><button class="btn" id="rCancel" type="button">Cancel</button><button class="btn primary" id="rSave" type="button">Save</button></div>
  </div>
</div>

<!-- Cart -->
<div id="cartBG" class="cart-bg" aria-hidden="true"></div>
<aside id="cart" class="cart" aria-hidden="true">
  <div class="cart-head"><strong>Cart</strong><button id="cartClose" class="btn" type="button">Close</button></div>
  <div id="cartList" class="cart-list"></div>
  <div class="cart-saved">
    <div class="row" style="justify-content:space-between">
      <strong>Saved for later</strong>
      <div class="row">
        <button class="btn" data-act="savedAddAll" type="button">Add all to cart</button>
      </div>
    </div>
    <div id="cartSaved"></div>
  </div>
  <div class="cart-foot">
    <div class="row" style="justify-content:space-between"><div class="muted">Subtotal</div><div id="cartSubtotal" style="font-weight:800"></div></div>
    <button id="checkout" class="btn primary" style="width:100%;margin-top:10px" type="button">Checkout (demo)</button>
  </div>
</aside>

<div id="toast"></div>

<script>
/* ===== Helpers / storage ===== */
const LS={USERS:'ct_users_v3',PROFILE:'ct_profile_data_v1',NOTIF:'ct_notifications_v1',INBOX:'ct_inbox_v1',
          ITEMS:'cm_items_v2',CART:'cm_cart_v1',RECENT:'cm_recent_v1',WISH:'cm_wish_v1',GLOBAL:'ct_global_feed_v1'};
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const load=(k,f)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;}}; const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v));}catch{}};
const uid=(p='m')=>`${p}_${Date.now().toString(36)}_${Math.random().toString(36).slice(2,7)}`;
const nowISO=()=>new Date().toISOString();
const face=n=>`https://i.pravatar.cc/150?u=${encodeURIComponent(n||'me')}`;
const fmt=(n,cur)=>new Intl.NumberFormat(undefined,{style:'currency',currency:cur||'USD'}).format(Number(n)||0);
const toast=m=>{const t=$("#toast");t.textContent=m;t.className="";void t.offsetWidth;t.className="show";setTimeout(()=>t.className="",1200);};
const clean=s=>String(s||'').trim();

/* ===== Header wiring ===== */
(function(){
  const prof=(load(LS.PROFILE,{}))['Me']||{};
  const a=$('#meAvatar'); if(a){ a.src=prof.avatar||face('Me'); a.alt=prof.displayName||'Me'; a.onclick=()=>{ try{localStorage.setItem('ct_profile_view_v1',JSON.stringify({name:'Me'}));}catch{} location.href='profile.html'; }; }
  $('#btnMsgs')?.addEventListener('click',(e)=>{e.preventDefault();if(window.ChatternetMessenger?.open)return ChatternetMessenger.open();if(window.ctOpen)return window.ctOpen();location.href='messages.html';});
  const nbg=$('#notifBg'),ibg=$('#inboxBg');
  function rN(){const a=load(LS.NOTIF,[]);$('#notifList').innerHTML=a.length?a.map(n=>`<div class="chip" style="display:block">${new Date(n.time).toLocaleString()} — ${n.text||''}</div>`).join(''):'No notifications yet.';}
  function rI(){const a=load(LS.INBOX,[]);$('#inboxList').innerHTML=a.length?a.map(n=>`<div class="chip" style="display:block">${new Date(n.time).toLocaleString()} — ${n.text||''}</div>`).join(''):'Inbox is empty.';}
  $('#btnNotif').onclick=()=>{rN();nbg.style.display='flex';}; $('#clearNotif').onclick=()=>{save(LS.NOTIF,[]);rN();}; $('#closeNotif').onclick=()=>{nbg.style.display='none';};
  $('#btnInbox').onclick=()=>{rI();ibg.style.display='flex';}; $('#closeInbox').onclick=()=>{ibg.style.display='none';};
})();

/* ===== Demo seed ===== */
(function seed(){
  let u=load(LS.USERS,null);
  if(!u||!u.length){u=[{name:'Me',avatar:face('Me')},'Grace Lee','Liam Adams','Ava Morgan','Noah Walker','Sophia Turner'].map(x=>typeof x==='string'?{name:x,avatar:face(x)}:x); save(LS.USERS,u);}
  let items=load(LS.ITEMS,null);
  if(!items||!items.length){
    const demo=[
      {t:'Tent',p:800,cur:'GBP',cat:'Outdoors',cond:'Like New',tags:['Crawley','tent','camping'],imgs:['https://images.unsplash.com/photo-1504280390368-3971c192a2b4?q=80&w=1200&auto=format&fit=crop'],desc:'4-person tent, barely used.',loc:'Crawley, UK',seller:'Ava Morgan'},
      {t:'Canon EOS M50',p:420,cur:'USD',cat:'Photography',cond:'Other',tags:['camera','photography','UK'],imgs:['https://images.unsplash.com/photo-1519183071298-a2962be96f83?q=80&w=1200&auto=format&fit=crop'],desc:'Great vlogging camera.',loc:'London, UK',seller:'Liam Adams'},
      {t:'Road Bike',p:350,cur:'USD',cat:'Cycling',cond:'Other',tags:['bike','cycling'],imgs:['https://images.unsplash.com/photo-1496545672447-f699b503d270?q=80&w=1200&auto=format&fit=crop'],desc:'Alloy frame, size M.',loc:'Brighton, UK',seller:'Grace Lee'}
    ];
    items=demo.map(d=>({id:uid('itm'),title:d.t,price:d.p,currency:d.cur,category:d.cat,condition:d.cond,tags:d.tags,images:d.imgs,desc:d.desc,location:d.loc,seller:d.seller,sellerAva:face(d.seller),delivery:{pickup:true,shipping:true,shipCost:10},phone:'',site:'',reviews:[],createdAt:nowISO()}));
    save(LS.ITEMS,items);
  }
})();

/* ===== State ===== */
const state={tab:'browse',current:null,imagesToAdd:[]};

/* ===== Tabs ===== */
$('#tabs').addEventListener('click',e=>{
  const t=e.target.closest('.tab'); if(!t) return;
  $$('#tabs .tab').forEach(x=>x.classList.toggle('active',x===t));
  state.tab=t.dataset.tab;
  $$('[data-panel]').forEach(p=>p.style.display=(p.getAttribute('data-panel').split(' ').includes(state.tab)?'block':'none'));
  renderAll();
});

/* ===== Items ===== */
const items=()=>load(LS.ITEMS,[]); const setItems=a=>save(LS.ITEMS,a);

/* ===== Render helpers ===== */
function starHtml(n){const full=Math.round((Number(n)||0)*2)/2;const count=Math.max(0,Math.min(5,Math.round(full)));return Array.from({length:count}).map(()=>'<i class="star"></i>').join('');}
function sellerRating(name){const it=items();const revs=it.filter(i=>i.seller===name).flatMap(i=>i.reviews||[]);if(!revs.length)return 0;return revs.reduce((s,r)=>s+(Number(r.stars)||0),0)/revs.length;}
function cardHtml(it){
  const rat=it.reviews.length?(it.reviews.reduce((s,r)=>s+Number(r.stars||0),0)/it.reviews.length):0;
  return `<article class="item" data-id="${it.id}">
    <img class="img" src="${(it.images&&it.images[0])||''}" alt="">
    <div class="i-body">
      <div class="price">${fmt(it.price,it.currency)}</div>
      <div class="title">${(it.title||'').slice(0,90)}</div>
      <div class="i-meta">${it.category||'Other'} • ${it.condition||'Other'}</div>
      <div class="row" style="margin-top:4px"><span class="stars" title="Item rating">${starHtml(rat)}</span>${it.reviews.length?`<span class="muted" style="font-size:12px">(${it.reviews.length})</span>`:''}</div>
      <div class="chips" style="margin-top:6px">${(it.tags||[]).slice(0,3).map(t=>`<span class="chip">${t}</span>`).join('')}</div>
      <div class="seller"><img class="ava" src="${it.sellerAva||face(it.seller)}" alt=""><div><div style="font-weight:700">${it.seller}</div><div class="stars">${starHtml(sellerRating(it.seller))}</div></div></div>
      <div class="i-actions">
        <button class="btn" data-act="view" data-id="${it.id}" type="button">View</button>
        <button class="btn primary" data-act="add" data-id="${it.id}" type="button">Add to Cart</button>
        <button class="btn" data-act="wish" data-id="${it.id}" type="button">♡ Wishlist</button>
        <button class="btn" data-act="msg" data-id="${it.id}" type="button">Message</button>
      </div>
    </div>
  </article>`;
}

/* ===== Filters & grid ===== */
$('#apply').onclick=()=>renderGrid();
['q','cat','cond','cur','minp','maxp','sort'].forEach(id=>$('#'+id).addEventListener('keydown',(e)=>{ if(e.key==='Enter') $('#apply').click(); }));
function applyFilters(list){
  const q=clean($('#q').value).toLowerCase(), cat=$('#cat').value, cond=$('#cond').value, cur=$('#cur').value;
  const min=Number($('#minp').value)||-Infinity, max=Number($('#maxp').value)||Infinity;
  let out=list.filter(i=>{
    const hitQ=!q || [i.title,i.desc,i.category,(i.tags||[]).join(' '),(i.seller||'')].join(' ').toLowerCase().includes(q);
    const hitCat=!cat || i.category===cat; const hitCond=!cond || i.condition===cond; const hitCur=!cur || i.currency===cur;
    const price=Number(i.price)||0; const hitP=price>=min&&price<=max;
    return hitQ&&hitCat&&hitCond&&hitCur&&hitP;
  });
  const sort=$('#sort').value;
  if(sort==='price-asc') out.sort((a,b)=>a.price-b.price);
  if(sort==='price-desc') out.sort((a,b)=>b.price-a.price);
  if(sort==='rating') out.sort((a,b)=>((b.reviews?.reduce((s,r)=>s+Number(r.stars||0),0)/(b.reviews?.length||1)) - (a.reviews?.reduce((s,r)=>s+Number(r.stars||0),0)/(a.reviews?.length||1))));
  if(sort==='newest') out.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt));
  return out;
}
function renderGrid(){ $('#grid').innerHTML=(applyFilters(items()).map(cardHtml).join(''))||'<div class="muted">No items match.</div>'; }
function renderRecent(){ const ids=load(LS.RECENT,[]); const map=new Map(items().map(i=>[i.id,i])); const list=ids.map(id=>map.get(id)).filter(Boolean); $('#recentGrid').innerHTML=list.map(cardHtml).join('')||'<div class="muted">Nothing yet — open some items.</div>'; }
function renderWish(){ const ids=load(LS.WISH,[]); const map=new Map(items().map(i=>[i.id,i])); const list=ids.map(id=>map.get(id)).filter(Boolean); $('#wishGrid').innerHTML=list.map(i=>cardHtml(i).replace('data-act="wish"','data-act="wishRemove"').replace('♡ Wishlist','Remove')).join('')||'<div class="muted">Wishlist is empty.</div>'; }
function renderMine(){ const list=items().filter(i=>i.seller==='Me'); $('#mineGrid').innerHTML=list.map(i=>cardHtml(i).replace('data-act="msg"','data-act="del"').replace('Message','Delete')).join('')||'<div class="muted">You haven’t listed anything yet.</div>'; }
function renderMyReviews(){ const me='Me'; const rows=[]; items().forEach(it=>{ (it.reviews||[]).forEach(r=>{ if((r.author||'Me')===me) rows.push({it,r}); }); }); $('#myReviews').innerHTML=rows.length?rows.map(({it,r})=>`<div class="card" style="margin:6px 0"><div class="row" style="justify-content:space-between"><strong>${it.title}</strong><span class="stars">${starHtml(r.stars)}</span></div><div class="muted">${new Date(r.time).toLocaleString()}</div><div style="margin-top:4px">${r.text||''}</div></div>`).join(''):'<div class="muted">No reviews yet.</div>'; }
function renderAll(){ if(state.tab==='browse') renderGrid(); if(state.tab==='recent') renderRecent(); if(state.tab==='wishlist') renderWish(); if(state.tab==='mine') renderMine(); if(state.tab==='reviews') renderMyReviews(); }

/* ===== Robust click wiring (capture) ===== */
document.addEventListener('click',function(e){
  const el=e.target.closest && e.target.closest('[data-act]'); if(!el) return;
  const act=el.getAttribute('data-act'); const id=el.getAttribute('data-id') || el.closest('[data-id]')?.getAttribute('data-id');
  if(act==='view'){ e.preventDefault(); openModal(id); }
  if(act==='add'){ e.preventDefault(); /* cart hook left as-is per your note */ }
  if(act==='wish'){ e.preventDefault(); toggleWish(id||state.current); toast('Saved to wishlist'); }
  if(act==='wishRemove'){ e.preventDefault(); toggleWish(id,true); toast('Removed from wishlist'); }
  if(act==='msg'){ e.preventDefault(); const it=items().find(i=>i.id===id); if(window.ctMessage) ctMessage(it?.seller||''); else if(window.ChatternetMessenger?.open) ChatternetMessenger.open(it?.seller||''); else location.href='messages.html'; }
  if(act==='del'){ e.preventDefault(); const arr=items().filter(i=>i.id!==id); setItems(arr); renderMine(); }
  if(act==='wishAllToCart'){ e.preventDefault(); /* we’ll wire cart next pass */ }
  if(act==='wishClear'){ e.preventDefault(); save(LS.WISH,[]); renderWish(); }
  if(act==='clearRecent'){ e.preventDefault(); save(LS.RECENT,[]); renderRecent(); }
  if(act==='savedAddAll'){ e.preventDefault(); /* cart hook next */ }
}, true);

/* ===== Recent / wishlist ===== */
function pushRecent(id){ const a=load(LS.RECENT,[]); const i=a.indexOf(id); if(i>=0)a.splice(i,1); a.unshift(id); if(a.length>30)a.length=30; save(LS.RECENT,a); }
function toggleWish(id,remove=false){ const a=load(LS.WISH,[]); const i=a.indexOf(id); if(remove){ if(i>=0)a.splice(i,1);}else{ if(i<0)a.unshift(id);} save(LS.WISH,a); if(state.tab==='wishlist') renderWish(); }

/* ===== Cart (left in place, no behavioral changes this pass) ===== */
function renderCart(){ /* kept for later cart work */ }
function openCart(){ document.getElementById('cartBG').style.display='block'; document.getElementById('cart').classList.add('open'); renderCart(); }
function closeCart(){ document.getElementById('cartBG').style.display='none'; document.getElementById('cart').classList.remove('open'); }
document.getElementById('cartBtn').onclick=openCart; document.getElementById('cartClose').onclick=closeCart; document.getElementById('cartBG').onclick=closeCart;

/* ===== Product modal + reviews ===== */
function fillStars(el,n){ el.innerHTML=starHtml(n); }
function renderReviewList(it){
  const r=it.reviews||[];
  document.getElementById('pReviewList').innerHTML = r.length ? r.map(v=>`
    <div class="card" style="margin:8px 0">
      <div class="row" style="justify-content:space-between"><strong>${v.author||'Anon'}</strong><span class="stars">${starHtml(v.stars)}</span></div>
      <div class="muted">${new Date(v.time).toLocaleString()}</div>
      <div style="margin-top:6px">${v.text||''}</div>
    </div>`).join('') : '<div class="muted">No reviews yet. Be the first!</div>';
}
function openModal(id){
  const it=items().find(x=>x.id===id); if(!it) return; state.current=id; pushRecent(id);
  document.getElementById('gMain').src=(it.images&&it.images[0])||''; document.getElementById('gThumbs').innerHTML=(it.images||[]).map((u,i)=>`<img src="${u}" class="${i===0?'active':''}" data-idx="${i}">`).join('');
  document.getElementById('pTitle').textContent=it.title||''; document.getElementById('pPrice').textContent=fmt(it.price,it.currency);
  document.getElementById('pCat').textContent=it.category||'Other'; document.getElementById('pCond').textContent=it.condition||'Other'; document.getElementById('pLoc').textContent=it.location||'';
  document.getElementById('pDesc').textContent=it.desc||''; document.getElementById('pSellerAva').src=it.sellerAva||face(it.seller); document.getElementById('pSellerName').textContent=it.seller||'';
  fillStars(document.getElementById('pStars'), it.reviews.length?(it.reviews.reduce((s,r)=>s+(Number(r.stars)||0),0)/it.reviews.length):0);
  function sellerRatingLocal(name){const itms=items();const revs=itms.filter(i=>i.seller===name).flatMap(i=>i.reviews||[]);if(!revs.length)return 0;return revs.reduce((s,r)=>s+(Number(r.stars)||0),0)/revs.length;}
  fillStars(document.getElementById('pSellerStars'), sellerRatingLocal(it.seller));
  const del=it.delivery||{}; document.getElementById('pDelivery').textContent=del.pickup&&del.shipping?'Pickup / Shipping':del.pickup?'Pickup':del.shipping?'Shipping':'Delivery: N/A';
  const shipEl=document.getElementById('pShipCost');
  if(del.shipping){ shipEl.style.display='inline-block'; shipEl.textContent='Ship: '+fmt(del.shipCost||0,it.currency);} else { shipEl.style.display='none'; }
  const ph=clean(it.phone), site=clean(it.site); const phEl=document.getElementById('pPhone'), stEl=document.getElementById('pSite');
  phEl.style.display=ph?'inline-block':'none'; phEl.textContent=ph?('☎ '+ph):''; phEl.href=ph?('tel:'+ph):'#';
  stEl.style.display=site?'inline-block':'none'; stEl.textContent=site?((new URL(site).hostname)) :''; stEl.href=site||'#';
  renderReviewList(it);
  document.getElementById('pBg').style.display='flex';
}
document.getElementById('pClose').onclick=()=>document.getElementById('pBg').style.display='none';
document.getElementById('gThumbs').addEventListener('click',e=>{const im=e.target.closest('img'); if(!im)return; $$('#gThumbs img').forEach(x=>x.classList.remove('active')); im.classList.add('active'); document.getElementById('gMain').src=im.src;});
document.getElementById('pWish').onclick=()=>{ if(state.current) { toggleWish(state.current); toast('Saved to wishlist'); } };
document.getElementById('pMsg').onclick=()=>{ /* messenger open left as-is */ };
document.getElementById('pShare').onclick=()=>{ const it=items().find(i=>i.id===state.current); if(!it) return; const arr=load(LS.GLOBAL,[]); arr.unshift({id:uid('g'),title:it.title,content:`${it.title} — ${fmt(it.price,it.currency)} (${it.category})`,authorName:'Me',createdAt:nowISO(),media:(it.images&&it.images[0])||null}); save(LS.GLOBAL,arr); toast('Shared to Global Feed'); };
document.getElementById('pReview').onclick=()=>{ document.getElementById('rName').value='Me'; document.getElementById('rText').value=''; document.getElementById('rStars').value='5'; document.getElementById('rBg').style.display='flex'; };
document.getElementById('rCancel').onclick=()=>document.getElementById('rBg').style.display='none';
document.getElementById('rSave').onclick=()=>{
  const arr=items(); const i=arr.findIndex(x=>x.id===state.current); if(i<0) return;
  arr[i].reviews=arr[i].reviews||[]; arr[i].reviews.unshift({author:clean(document.getElementById('rName').value)||'Me',stars:Number(document.getElementById('rStars').value)||5,text:clean(document.getElementById('rText').value),time:nowISO()});
  setItems(arr); document.getElementById('rBg').style.display='none'; toast('Review added'); openModal(state.current);
  if(state.tab==='browse') renderGrid(); if(state.tab==='reviews') renderMyReviews();
};

/* ===== Sell form ===== */
(function hydrateSell(){ const sel=document.getElementById('tSeller'); sel.innerHTML=''; load(LS.USERS,[]).forEach(u=>{const o=document.createElement('option');o.value=u.name;o.textContent=u.name;sel.appendChild(o);}); sel.value='Me'; })();
function renderUploadThumbs(){ const box=document.getElementById('tImgs'); box.innerHTML=state.imagesToAdd.map((u,i)=>`<img src="${u}" data-idx="${i}" title="Click to remove">`).join('')||'<div class="muted">No images yet.</div>'; }
document.body.addEventListener('click',(e)=>{ const a=e.target.closest('[data-act="addImgUrl"]'); if(a){ const u=clean(document.getElementById('tImgUrl').value); if(u){ state.imagesToAdd.push(u); document.getElementById('tImgUrl').value=''; renderUploadThumbs(); } }
  const b=e.target.closest('[data-act="addImgFiles"]'); if(b){ const fs=document.getElementById('tImgFiles').files||[]; if(!fs.length) return; Array.from(fs).slice(0,12).forEach(f=>{const r=new FileReader(); r.onload=e=>{state.imagesToAdd.push(e.target.result); renderUploadThumbs();}; r.readAsDataURL(f);}); document.getElementById('tImgFiles').value=''; }});
document.getElementById('tImgs').addEventListener('click',e=>{const im=e.target.closest('img'); if(!im) return; const i=Number(im.dataset.idx); state.imagesToAdd.splice(i,1); renderUploadThumbs();});
document.getElementById('clear').onclick=()=>{ ['tTitle','tDesc','tPrice','tTags','tLoc','tPhone','tSite','tImgUrl'].forEach(id=>document.getElementById(id).value=''); state.imagesToAdd.length=0; renderUploadThumbs(); };
document.getElementById('create').onclick=()=>{
  const title=clean(document.getElementById('tTitle').value); const price=Number(document.getElementById('tPrice').value)||0; if(!title||!price) return alert('Title and price are required.');
  const obj={id:uid('itm'),title,price,currency:document.getElementById('tCur').value||'USD',category:document.getElementById('tCat').value||'Other',condition:document.getElementById('tCond').value||'Other',
    tags:clean(document.getElementById('tTags').value).split(',').map(t=>clean(t)).filter(Boolean),images:state.imagesToAdd.slice(),desc:clean(document.getElementById('tDesc').value),location:clean(document.getElementById('tLoc').value),
    seller:document.getElementById('tSeller').value||'Me',sellerAva:face(document.getElementById('tSeller').value||'Me'),phone:clean(document.getElementById('tPhone').value),site:clean(document.getElementById('tSite').value),
    delivery:{pickup:!!document.getElementById('dPickup').checked,shipping:!!document.getElementById('dShip').checked,shipCost:Number(document.getElementById('dShipCost').value)||0},reviews:[],createdAt:nowISO()};
  const arr=items(); arr.unshift(obj); setItems(arr); toast('Listing created'); ['tTitle','tDesc','tPrice','tTags','tLoc','tPhone','tSite','tImgUrl'].forEach(id=>document.getElementById(id).value=''); state.imagesToAdd.length=0; renderUploadThumbs();
  state.tab='mine'; $$('#tabs .tab').forEach(x=>x.classList.toggle('active',x.dataset.tab==='mine')); $$('[data-panel]').forEach(p=>p.style.display=(p.getAttribute('data-panel').split(' ').includes('mine')?'block':'none')); renderMine();
};

/* ===== Boot ===== */
renderUploadThumbs(); renderAll();

/* ===== Messenger loader (unchanged) ===== */
(function () {
  var FALLBACK='https://chatternet-backend-1.onrender.com';
  var ls=localStorage.getItem('ct_api_base')||''; var base=(window.CT_API_BASE||ls||FALLBACK).replace(/\/+$/,''); window.CT_API_BASE=base; if(!ls){try{localStorage.setItem('ct_api_base',base);}catch{}}
  function chain(arr,cb){(function next(i){if(i>=arr.length){cb(false);return;}var s=document.createElement('script');s.src=arr[i];s.async=true;s.onload=function(){cb(true)};s.onerror=function(){s.remove();next(i+1)};(document.head||document.documentElement).appendChild(s);})(0);}
  function ensure(cb){ if(window.ChatternetMessenger?.open) return cb(true);
    chain([base+'/assets/messenger.js','/assets/messenger.js','assets/messenger.js','/messenger.js','messenger.js'],function(ok){ if(ok && window.ChatternetMessenger?.open){ window.ctOpen=window.ctOpen||function(){window.ChatternetMessenger.open("")}; window.ctMessage=window.ctMessage||function(n){window.ChatternetMessenger.open(n||"")}; } cb(!!ok); }); }
  document.addEventListener('click',function(e){var a=e.target.closest&&e.target.closest('a[href*="messages.html"]'); if(!a) return; e.preventDefault(); if(window.ctOpen) return window.ctOpen(); ensure(function(ok){ if(ok) window.ChatternetMessenger.open(""); else location.href='messages.html'; });},true);
})();
</script>
</body>
</html>
