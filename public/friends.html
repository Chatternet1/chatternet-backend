<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Friends — Chatternet</title>

<style>
  :root{
    --brand:#0ea5e9; --brand-2:#0989c3;
    --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#667085; --line:#e6eaf2;
    --blueTop:132px; --barH:52px; --navH:48px;
    --pagePad: calc(var(--blueTop) + var(--barH) + var(--navH));
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.45 Arial,"Segoe UI",system-ui,-apple-system,sans-serif}
  a{color:#2563eb;text-decoration:none}

  /* keep typography sane under site theme */
  .top-bar, .top-bar *, nav.app-nav, nav.app-nav *, .page, .page *{
    letter-spacing: normal !important;
    word-spacing: normal !important;
    font-kerning: normal !important;
    font-variant-ligatures: none !important;
    text-rendering: optimizeLegibility !important;
    -webkit-font-smoothing: antialiased !important;
    -moz-osx-font-smoothing: grayscale !important;
    line-height: 1.45;
  }

  /* ===== Fixed blue header ===== */
  .top-bar{
    position:fixed; left:0; right:0; top:var(--blueTop); z-index:1250;
    display:flex; justify-content:space-between; align-items:center;
    padding:10px 14px; background:var(--brand); color:#fff;
    border-bottom:1px solid rgba(255,255,255,.2); box-shadow:0 2px 8px rgba(0,0,0,.12)
  }
  .top-bar h2{margin:0;font-weight:800;font-size:18px}
  .top-actions{display:flex;gap:10px;align-items:center}
  .pillbtn{
    height:36px;padding:0 12px;border-radius:999px;cursor:pointer;
    border:1px solid rgba(255,255,255,.7);background:rgba(255,255,255,.15);color:#fff
  }
  .pillbtn:hover{background:rgba(255,255,255,.26)}
  #myProfile{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.85);object-fit:cover;cursor:pointer}

  /* ===== Fixed app nav ===== */
  nav.app-nav{
    position:fixed; left:0; right:0; top:calc(var(--blueTop) + var(--barH));
    z-index:1190; background:#fff; border-bottom:1px solid var(--line)
  }
  nav.app-nav .inner{
    max-width:1100px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px; justify-content:center;
  }
  nav.app-nav a{
    display:inline-block;padding:8px 10px;border-radius:999px;
    color:#111;background:#f3f4f6;text-decoration:none;font-weight:600;border:1px solid #e6eaf2
  }
  nav.app-nav a.active{background:#dbeafe;color:#1e3a8a}
  nav.app-nav a:hover{background:#e5e7eb}

  /* ===== Layout ===== */
  .page{max-width:1100px;margin:14px auto;padding:0 12px; padding-top:var(--pagePad); display:grid; grid-template-columns:320px 1fr; gap:14px}
  @media (max-width:980px){ .page{grid-template-columns:1fr} }
  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:14px}
  .section-title{font-size:18px;font-weight:800;margin:0 0 8px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}

  /* Left sidebar: tabs */
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
  .tab{padding:8px 12px;border:1px solid #dfe3f0;border-radius:999px;background:#fff;cursor:pointer;font-weight:700;user-select:none}
  .tab.active{background:#e9f2ff;border-color:#cfe1ff}
  .search{width:100%;padding:10px;border:1px solid #d7d7d7;border-radius:10px;font-size:14px}

  /* Lists */
  .list{display:flex;flex-direction:column;gap:8px}
  .person{display:flex;gap:10px;align-items:center;border:1px solid #e6eaf2;border-radius:12px;padding:10px;background:#fff}
  .picon{width:38px;height:38px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6eaf2;background:#f8fafc;border-radius:999px;padding:4px 10px;font-size:12px}
  .btn{padding:8px 12px;border:1px solid #d7d7d7;border-radius:999px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.danger{background:#fee2e2;border-color:#fecaca;color:#991b1b}

  /* Right: profile card + network */
  .profileCard{display:flex;gap:12px;align-items:center}
  .profileCard .avatar{width:64px;height:64px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
  .grid{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:10px}
  @media (max-width:600px){ .grid{grid-template-columns:1fr} }

  /* Modals */
  .modalbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:4000}
  .sheet{background:#fff;border-radius:12px;max-width:520px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 10px 28px rgba(0,0,0,.35);padding:16px}
</style>

<!-- Offset calculator (keeps bars aligned under your site header) -->
<script>
(function(){
  var GAP=12;
  var MENU_SELS=['.wsite-nav','.wsite-menu-default','.wsite-menus','.w-nav','.nav-wrapper','.navbar','.siteHeader .nav','.desktop-nav','.top-nav','nav[role="navigation"]','.site-navigation'];
  function pickMenuBottom(){
    var bottoms=[];
    for(var i=0;i<MENU_SELS.length;i++){
      var el=document.querySelector(MENU_SELS[i]); if(!el) continue;
      var r=el.getBoundingClientRect(), h=r.height, w=r.width;
      var ok=h>=32 && h<=140 && r.top>-20 && r.top<200 && w>300;
      if(ok) bottoms.push(Math.round(r.bottom));
    }
    var best=bottoms.length?Math.min.apply(null,bottoms):120;
    if(best>240) best=120;
    try{ var force=localStorage.getItem('ct_force_header_px'); if(force) best=parseInt(force,10)||best; }catch(_){}
    return best + GAP;
  }
  function measure(el,fb){ if(!el) return fb; var r=el.getBoundingClientRect(); return Math.max(fb, Math.round(r.height)); }
  function apply(){
    var base = pickMenuBottom();
    var bar = document.querySelector('.top-bar');
    var nav = document.querySelector('nav.app-nav');
    if(bar) bar.style.top = base+'px';
    var barH=measure(bar,52), navH=measure(nav,46);
    var root=document.documentElement;
    root.style.setProperty('--blueTop', base+'px');
    root.style.setProperty('--barH', barH+'px');
    root.style.setProperty('--navH', navH+'px');
    root.style.setProperty('--pagePad', (base+barH+navH)+'px');
  }
  var run=function(){ apply(); setTimeout(apply,120); setTimeout(apply,600); };
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', run); } else { run(); }
  addEventListener('resize', apply, {passive:true});
  addEventListener('orientationchange', apply, {passive:true});
})();
</script>
</head>
<body>

<!-- Blue Header -->
<div class="top-bar" role="banner" aria-label="Page header">
  <h2>Friends</h2>
  <div class="top-actions">
    <button id="btnNotif" class="pillbtn" type="button">Notifications</button>
    <button id="btnInbox" class="pillbtn" type="button">Inbox</button>
    <button id="btnMsgs" class="pillbtn" type="button">Messages</button>
    <img id="myProfile" alt="Me" />
  </div>
</div>

<!-- App Nav -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a class="active" href="friends.html" aria-current="page">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a href="music.html">Music</a>
    <a href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- Notifications modal -->
<div id="notifModal" class="modalbg" aria-hidden="true">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="row" style="margin-top:8px">
      <button id="clearNotif" class="btn primary" type="button">Clear</button>
      <button id="closeNotif" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Inbox modal -->
<div id="inboxModal" class="modalbg" aria-hidden="true">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="row" style="margin-top:8px">
      <button id="closeInbox" class="btn" type="button">Close</button>
    </div>
  </div>
</div>

<!-- Page -->
<div class="page">
  <!-- LEFT: tabs + lists -->
  <aside class="card">
    <div class="tabs" id="tabs">
      <div class="tab active" data-tab="mine">My Friends</div>
      <div class="tab" data-tab="requests">Requests</div>
      <div class="tab" data-tab="discover">Discover</div>
    </div>

    <!-- My Friends -->
    <div id="panel-mine">
      <input id="searchMine" class="search" placeholder="Search friends…">
      <div id="listMine" class="list" style="margin-top:8px"></div>
      <div id="emptyMine" class="muted" style="display:none;margin-top:8px">No friends yet. Try Discover to add some.</div>
    </div>

    <!-- Requests -->
    <div id="panel-requests" style="display:none">
      <strong>Incoming</strong>
      <div id="listIn" class="list" style="margin-top:6px"></div>
      <div id="emptyIn" class="muted" style="display:none">No incoming requests.</div>
      <div style="height:8px"></div>
      <strong>Outgoing</strong>
      <div id="listOut" class="list" style="margin-top:6px"></div>
      <div id="emptyOut" class="muted" style="display:none">No outgoing requests.</div>
    </div>

    <!-- Discover -->
    <div id="panel-discover" style="display:none">
      <input id="searchAll" class="search" placeholder="Search people…">
      <div id="listAll" class="list" style="margin-top:8px"></div>
      <div id="emptyAll" class="muted" style="display:none">No people found.</div>
    </div>
  </aside>

  <!-- RIGHT: profile card + public network -->
  <main class="card" id="rightPane">
    <div id="profileCard" class="profileCard" style="margin-bottom:10px">
      <img class="avatar" id="pcAvatar" alt="">
      <div style="min-width:0;flex:1">
        <div class="section-title" id="pcName" style="margin:0 0 2px">Select someone</div>
        <div class="muted" id="pcMeta">View public friends and send a message.</div>
      </div>
      <div class="row" id="pcActions" style="margin-left:auto">
        <button class="btn" id="pcMessage">Message</button>
        <button class="btn" id="pcView">View Profile</button>
      </div>
    </div>

    <div id="publicFriendsWrap" style="display:none">
      <div class="row" style="justify-content:space-between;margin:0 0 8px">
        <strong>Public friends</strong>
        <span class="pill" id="pcCount">0</span>
      </div>
      <div id="publicFriends" class="grid"></div>
    </div>

    <div id="blankRight" class="muted">Tip: click any person to preview their public friend list.</div>
  </main>
</div>

<!-- ===== Data + Page logic ===== -->
<script>
/* Storage keys & helpers */
const LS={
  USERS:'ct_users_v3',
  FRIENDS:'ct_friend_list_v2',          // Me's accepted friends  [ "Kate White", ... ]
  REQ_OUT:'ct_friend_requests_out_v2',  // Me → Others            [ "Grace Lee", ... ]
  REQ_IN:'ct_friend_requests_in_v2',    // Others → Me            [ "Bill Thomas", ... ]
  BOT_GRAPH:'ct_bot_friends_v1',        // Public network { name: [names] }
  PROFILE:'ct_profile_data_v1',
  NOTIF:'ct_notifications_v1',
  INBOX:'ct_inbox_v1'
};
const $=s=>document.querySelector(s);
const $$=s=>Array.from(document.querySelectorAll(s));
const load=(k,f)=>{ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch{ return f; } };
const save=(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} };
const nowISO=()=>new Date().toISOString();
const face=n=>`https://i.pravatar.cc/200?u=${encodeURIComponent(n||'me')}`;
const esc=s=>String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;'}[c]));

/* Header + modals + Messages button (overlay if available) */
(function header(){
  const prof=(load(LS.PROFILE,{}))['Me']||{};
  const ava=prof.avatar||prof.avatarUrl||face('Me');
  $('#myProfile').src=ava; $('#myProfile').referrerPolicy='no-referrer'; $('#myProfile').onclick=()=>{ try{ localStorage.setItem('ct_profile_view_v1',JSON.stringify({name:'Me'})); }catch{}; location.href='profile.html'; };

  $('#btnMsgs').onclick=(e)=>{ e.preventDefault();
    if(window.ChatternetMessenger?.open) return window.ChatternetMessenger.open();
    if(window.ctOpen) return window.ctOpen();
    location.href='messages.html';
  };

  const nM=$('#notifModal'), iM=$('#inboxModal');
  const rN=()=>{ const a=load(LS.NOTIF,[]); $('#notifList').innerHTML=a.length?a.map(n=>`<div class="muted" style="margin:6px 0"><strong>${new Date(n.time).toLocaleString()}</strong><br>${esc(n.text||'')}</div>`).join(''):'No notifications yet.'; };
  const rI=()=>{ const a=load(LS.INBOX,[]); $('#inboxList').innerHTML=a.length?a.map(n=>`<div class="muted" style="margin:6px 0"><strong>${new Date(n.time).toLocaleString()}</strong><br>${esc(n.text||'')}</div>`).join(''):'Inbox is empty.'; };
  $('#btnNotif').onclick=()=>{ rN(); nM.style.display='flex'; };
  $('#clearNotif').onclick=()=>{ save(LS.NOTIF,[]); rN(); };
  $('#closeNotif').onclick=()=>{ nM.style.display='none'; };
  $('#btnInbox').onclick=()=>{ rI(); iM.style.display='flex'; };
  $('#closeInbox').onclick=()=>{ iM.style.display='none'; };
})();

/* Seed users & public friend graph (bots) */
(function seedUsersAndGraph(){
  let users=load(LS.USERS,[]);
  if(!users || !users.length){
    const names=['Me','Chatternet','Bill Thomas','Kate White','Michael Reed','Olivia Perez','David Carter','Grace Lee','Ava Morgan','Noah Walker','Sophia Turner','Mason Hill','Daniel Foster','Jason Brooks','Emily Johnson'];
    users = names.map(n=>({name:n, avatar:face(n)}));
    save(LS.USERS,users);
  }else{
    if(!users.find(u=>u.name==='Me')) users.unshift({name:'Me',avatar:face('Me')});
    save(LS.USERS,users);
  }

  // Public network graph (view-only). Keep symmetric edges.
  let g=load(LS.BOT_GRAPH,null);
  if(!g){
    g={}; const names=users.filter(u=>u.name!=='Me').map(u=>u.name);
    function connect(a,b){ if(a===b) return; g[a]=g[a]||[]; g[b]=g[b]||[]; if(!g[a].includes(b)) g[a].push(b); if(!g[b].includes(a)) g[b].push(a); }
    // random-ish connections
    names.forEach(n=>{
      const picks=[...names].sort(()=>Math.random()-0.5).slice(3, 3+Math.floor(Math.random()*5+2));
      picks.forEach(p=>connect(n,p));
    });
    save(LS.BOT_GRAPH,g);
  }
})();

/* Seed a few incoming requests on first load (demo) */
(function seedRequests(){
  const users=load(LS.USERS,[]).filter(u=>u.name!=='Me');
  let inb=load(LS.REQ_IN,null);
  if(!inb){
    inb = users.sort(()=>Math.random()-0.5).slice(0,2).map(u=>u.name);
    save(LS.REQ_IN,inb);
  }
  if(!load(LS.REQ_OUT,null)) save(LS.REQ_OUT,[]);
  if(!load(LS.FRIENDS,null)) save(LS.FRIENDS,[]);
})();

/* Tabs */
(function tabs(){
  const map={ mine:'#panel-mine', requests:'#panel-requests', discover:'#panel-discover' };
  $('#tabs').addEventListener('click',(e)=>{
    const t=e.target.closest('.tab'); if(!t) return;
    $$('.tab').forEach(x=>x.classList.toggle('active', x===t));
    Object.values(map).forEach(sel=>$(sel).style.display='none');
    $(map[t.getAttribute('data-tab')]).style.display='block';
  });
})();

/* Rendering */
function personRow(name, opts){
  opts=opts||{};
  const u = load(LS.USERS,[]).find(x=>x.name===name) || {name, avatar:face(name)};
  const wrap=document.createElement('div');
  wrap.className='person';
  wrap.innerHTML = `
    <img class="picon" src="${u.avatar||face(name)}" alt="">
    <div style="flex:1;min-width:0">
      <div style="font-weight:700">${esc(name)}</div>
      <div class="muted" style="font-size:12px">@${esc(name.toLowerCase().replace(/\s+/g,'.'))}</div>
    </div>
    ${opts.actions||''}
  `;
  wrap.addEventListener('click',(e)=>{
    if(e.target.closest('button')) return; // buttons handle their own
    previewUser(name);
  });
  return wrap;
}

function renderMine(){
  const q=($('#searchMine').value||'').toLowerCase();
  const friends = load(LS.FRIENDS,[]);
  const box=$('#listMine'); box.innerHTML='';
  const list = friends.filter(n=>n.toLowerCase().includes(q));
  if(!list.length){ $('#emptyMine').style.display='block'; return; }
  $('#emptyMine').style.display='none';
  list.forEach(n=>{
    const actions = `
      <button class="btn" data-act="msg" data-name="${esc(n)}">Message</button>
      <button class="btn danger" data-act="unfriend" data-name="${esc(n)}">Remove</button>
    `;
    box.appendChild(personRow(n,{actions}));
  });
}

function renderRequests(){
  const inb=load(LS.REQ_IN,[]), out=load(LS.REQ_OUT,[]);
  const inBox=$('#listIn'), outBox=$('#listOut');
  inBox.innerHTML=''; outBox.innerHTML='';
  if(!inb.length) $('#emptyIn').style.display='block'; else $('#emptyIn').style.display='none';
  if(!out.length) $('#emptyOut').style.display='block'; else $('#emptyOut').style.display='none';

  inb.forEach(n=>{
    const actions=`
      <button class="btn primary" data-act="accept" data-name="${esc(n)}">Accept</button>
      <button class="btn" data-act="decline" data-name="${esc(n)}">Decline</button>
    `;
    inBox.appendChild(personRow(n,{actions}));
  });
  out.forEach(n=>{
    const actions=`<button class="btn danger" data-act="cancel" data-name="${esc(n)}">Cancel</button>`;
    outBox.appendChild(personRow(n,{actions}));
  });
}

function renderDiscover(){
  const q=($('#searchAll').value||'').toLowerCase();
  const users=load(LS.USERS,[]).filter(u=>u.name!=='Me');
  const friends=new Set(load(LS.FRIENDS,[]));
  const out=new Set(load(LS.REQ_OUT,[]));
  const inb=new Set(load(LS.REQ_IN,[]));
  const list = users.filter(u=>u.name.toLowerCase().includes(q))
                    .filter(u=>!friends.has(u.name));
  const box=$('#listAll'); box.innerHTML='';
  if(!list.length){ $('#emptyAll').style.display='block'; return; }
  $('#emptyAll').style.display='none';
  list.forEach(u=>{
    let label='Add'; let disabled=false;
    if(out.has(u.name)) { label='Sent'; disabled=true; }
    if(inb.has(u.name)) { label='Respond in Requests'; disabled=true; }
    const actions = `
      <button class="btn ${disabled?'':'primary'}" data-act="add" data-name="${esc(u.name)}" ${disabled?'disabled':''}>${label}</button>
      <button class="btn" data-act="msg" data-name="${esc(u.name)}">Message</button>
    `;
    box.appendChild(personRow(u.name,{actions}));
  });
}

/* Right pane: preview public friends (view-only network) */
function previewUser(name){
  const users=load(LS.USERS,[]);
  const u=users.find(x=>x.name===name) || {name,avatar:face(name)};
  $('#pcAvatar').src=u.avatar||face(name);
  $('#pcAvatar').referrerPolicy='no-referrer';
  $('#pcName').textContent = name;
  $('#pcMeta').textContent = `@${name.toLowerCase().replace(/\s+/g,'.')}`;
  $('#blankRight').style.display='none';
  $('#publicFriendsWrap').style.display='';
  const g=load(LS.BOT_GRAPH,{});
  const list=(g[name]||[]).slice().sort((a,b)=>a.localeCompare(b));
  $('#pcCount').textContent = list.length;
  const grid=$('#publicFriends'); grid.innerHTML='';
  list.forEach(n=>{
    const el=document.createElement('div');
    el.className='person';
    el.innerHTML=`
      <img class="picon" src="${face(n)}" alt="">
      <div style="flex:1;min-width:0">
        <div style="font-weight:700">${esc(n)}</div>
        <div class="muted" style="font-size:12px">@${esc(n.toLowerCase().replace(/\s+/g,'.'))}</div>
      </div>
      <button class="btn" data-act="peek" data-name="${esc(n)}">Open</button>
    `;
    el.addEventListener('click',(e)=>{ if(e.target.closest('button')) return; previewUser(n); });
    grid.appendChild(el);
  });

  // header actions
  $('#pcMessage').onclick=()=>{ if(window.ChatternetMessenger?.open) ChatternetMessenger.open(); else if(window.ctOpen) ctOpen(); else location.href='messages.html'; };
  $('#pcView').onclick=()=>{ try{ localStorage.setItem('ct_profile_view_v1',JSON.stringify({name})); }catch{}; location.href='profile.html'; };
}

/* Actions (left lists) — ALWAYS act as "Me" only */
document.addEventListener('click',(e)=>{
  const btn=e.target.closest('button[data-act]'); if(!btn) return;
  const act=btn.getAttribute('data-act');
  const name=btn.getAttribute('data-name');

  let friends=load(LS.FRIENDS,[]);
  let out=load(LS.REQ_OUT,[]);
  let inb=load(LS.REQ_IN,[]);

  if(act==='msg'){
    if(window.ChatternetMessenger?.open) ChatternetMessenger.open();
    else if(window.ctOpen) ctOpen();
    else location.href='messages.html';
    return;
  }
  if(act==='unfriend'){
    friends = friends.filter(n=>n!==name); save(LS.FRIENDS,friends);
    renderMine(); renderDiscover();
    return;
  }
  if(act==='accept'){
    inb = inb.filter(n=>n!==name); save(LS.REQ_IN,inb);
    if(!friends.includes(name)){ friends.unshift(name); save(LS.FRIENDS,friends); }
    renderRequests(); renderMine(); renderDiscover();
    return;
  }
  if(act==='decline'){
    inb = inb.filter(n=>n!==name); save(LS.REQ_IN,inb);
    renderRequests(); renderDiscover();
    return;
  }
  if(act==='cancel'){
    out = out.filter(n=>n!==name); save(LS.REQ_OUT,out);
    renderRequests(); renderDiscover();
    return;
  }
  if(act==='add'){
    if(!out.includes(name)){ out.unshift(name); save(LS.REQ_OUT,out); }
    btn.textContent='Sent'; btn.disabled=true;
    renderRequests(); // show under Outgoing
    return;
  }
  if(act==='peek'){ previewUser(name); return; }
});

/* Search boxes */
$('#searchMine').addEventListener('input', renderMine);
$('#searchAll').addEventListener('input', renderDiscover);

/* Initial render */
renderMine(); renderRequests(); renderDiscover();

/* Auto-open preview if we came with ?who= */
(function(){
  try{
    const u=new URL(location.href); const who=u.searchParams.get('who');
    if(who) previewUser(who);
  }catch{}
})();
</script>

<!-- Universal messenger loader (overlay here; Messages page still navigates) -->
<script>
(function(){
  "use strict";
  var BASE=(window.CT_API_BASE || localStorage.getItem('ct_api_base') || 'https://chatternet-backend-1.onrender.com').replace(/\/+$/,'');
  window.CT_API_BASE = BASE; try{ localStorage.setItem('ct_api_base', BASE); }catch{}
  function tryLoad(list, done){
    (function next(i){ if(i>=list.length){ done(false); return; }
      var s=document.createElement('script'); s.src=list[i]; s.async=true;
      s.onload=function(){ done(true); }; s.onerror=function(){ s.remove(); next(i+1); };
      (document.head||document.documentElement).appendChild(s);
    })(0);
  }
  var paths=[ BASE+'/assets/messenger.js','/assets/messenger.js','assets/messenger.js','/messenger.js','messenger.js' ];
  tryLoad(paths, function(ok){
    if(ok && window.ChatternetMessenger && typeof window.ChatternetMessenger.open==='function'){
      window.ctOpen    = window.ctOpen    || function(){ window.ChatternetMessenger.open(""); };
      window.ctMessage = window.ctMessage || function(n){ window.ChatternetMessenger.open(n||""); };
    }
  });
  // Intercept only on this page to use overlay
  document.addEventListener('click', function(e){
    var a=e.target.closest && e.target.closest('a[href*="messages.html"]'); if(!a) return;
    if(window.ctOpen || (window.ChatternetMessenger && window.ChatternetMessenger.open)){
      e.preventDefault(); (window.ctOpen || window.ChatternetMessenger.open)("");
    }
  }, true);
})();
</script>

</body>
</html>
