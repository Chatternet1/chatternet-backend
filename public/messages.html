<!doctype html> 
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Chatternet — Messages</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<style>
  :root{
    --blueTop:132px;     /* distance from site menu bottom to blue bar */
    --barH:52px;         /* measured height of blue bar */
    --navH:48px;         /* measured height of chip nav */
    --pagePad: calc(var(--blueTop) + var(--barH) + var(--navH));
    --brand:#0ea5e9; --brand-2:#0989c3;
    --bg:#f5f7fb; --card:#fff; --ink:#0f172a; --muted:#667085; --line:#e6eaf2;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);
    font:14px/1.45 Arial,"Segoe UI",system-ui,-apple-system,sans-serif}

  a{color:#2563eb;text-decoration:none}

  /* ===== Fixed blue bar (base stack) ===== */
  .top-bar{
    position:fixed; left:0; right:0; top:var(--blueTop); z-index:1200;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; height:var(--barH);
    background:var(--brand); color:#fff; border-bottom:1px solid rgba(255,255,255,.2);
    box-shadow:0 2px 8px rgba(0,0,0,.12);
  }
  .top-bar h2{margin:0;font-weight:800;font-size:18px;letter-spacing:.2px}
  .top-actions{display:flex;gap:10px;align-items:center}
  .pillbtn{
    height:36px;padding:0 12px;border-radius:999px;cursor:pointer;
    border:1px solid rgba(255,255,255,.7);background:#fff;color:#0b3a67;font-weight:600
  }
  .pillbtn:hover{background:#eef4ff}
  #myProfile{width:36px;height:36px;border-radius:50%;border:2px solid rgba(255,255,255,.85);object-fit:cover;cursor:pointer}

  /* ===== Chip nav (identical across app) ===== */
  nav.app-nav{position:fixed;left:0;right:0;top:calc(var(--blueTop) + var(--barH));z-index:1190;background:#fff;border-bottom:1px solid var(--line)}
  nav.app-nav .inner{max-width:1180px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px}
  nav.app-nav a{display:inline-block;padding:8px 10px;border-radius:999px;background:#f3f4f6;color:#111;font-weight:600;text-decoration:none}
  nav.app-nav a.active{background:#dbeafe;color:#1e3a8a}
  nav.app-nav a:hover{background:#e5e7eb}

  /* ===== Page ===== */
  .page{max-width:1180px;margin:14px auto;padding:0 12px;padding-top:var(--pagePad)}

  .cols{display:grid;grid-template-columns:340px 1fr;gap:14px}
  @media (max-width:980px){.cols{grid-template-columns:1fr}}

  .card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.05);padding:0}

  /* Left: threads list */
  .list-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:8px;align-items:center}
  .list-head input{flex:1;padding:10px;border:1px solid #d7d7d7;border-radius:10px;font-size:14px}
  .threads{padding:6px}
  .thread{display:flex;gap:10px;align-items:center;padding:10px;border-radius:12px;cursor:pointer}
  .thread:hover{background:#f6f9ff}
  .thread.active{background:#eaf2ff}
  .ava{width:44px;height:44px;border-radius:50%;object-fit:cover;border:2px solid #fff;box-shadow:0 1px 3px rgba(0,0,0,.08)}
  .t-meta{flex:1;min-width:0}
  .t-name{font-weight:800;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-last{font-size:13px;color:#475569;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .t-time{font-size:12px;color:#64748b}

  /* Right: chat */
  .chat{display:flex;flex-direction:column;min-height:520px;height:64vh}
  .chat-head{padding:12px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  .chat-head .ava{width:40px;height:40px}
  .chat-head .name{font-weight:800}
  .chat-body{flex:1;overflow:auto;padding:14px;background:#f8fafc}
  .day{position:sticky;top:6px;display:inline-block;margin:8px auto 14px;background:#e5e7eb;color:#374151;padding:4px 10px;border-radius:999px;font-size:12px}
  .msg{max-width:72%;margin:6px 0;display:flex;gap:8px;align-items:flex-end}
  .msg.me{margin-left:auto;flex-direction:row-reverse}
  .bubble{padding:10px 12px;border-radius:14px;border:1px solid #e5e7eb;background:#fff;box-shadow:0 1px 2px rgba(0,0,0,.04);white-space:pre-wrap}
  .msg.me .bubble{background:#e7f0ff;border-color:#d6e6ff}
  .m-time{font-size:11px;color:#64748b;margin:0 6px}
  .chat-input{padding:12px;border-top:1px solid var(--line);display:flex;gap:8px;align-items:center;background:#fff;border-bottom-left-radius:14px;border-bottom-right-radius:14px}
  .chat-input textarea{flex:1;padding:10px;border:1px solid #d7d7d7;border-radius:10px;font-size:14px;resize:none;height:44px}
  .btn{padding:10px 14px;border:1px solid #d7d7d7;border-radius:10px;background:#fff;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:var(--brand);color:#fff}
  .btn.primary:hover{background:var(--brand-2)}

  .empty{color:#6b7280;text-align:center;padding:16px}

  /* Modals */
  .modalbg,.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:2000}
  .sheet{background:#fff;border-radius:12px;max-width:520px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
  .notif-item{padding:10px;border:1px solid #eee;border-radius:10px;background:#fafafa;margin:8px 0}

  /* Error overlay */
  #errOverlay{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.55);z-index:3000}
  #errPanel{margin-top:24px;background:#fff;color:#111;border-radius:12px;max-width:900px;width:92%;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
  #errPanel pre{white-space:pre-wrap;overflow:auto;background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px;max-height:50vh}
</style>

<!-- Positioner -->
<script>
(function(){
  var GAP=12, MENU_SELS=['.wsite-nav','.wsite-menu-default','.wsite-menus','.w-nav','.nav-wrapper','.navbar','.siteHeader .nav','.desktop-nav','.top-nav','nav[role="navigation"]','.site-navigation'];
  function pickMenuBottom(){var bottoms=[];for(var i=0;i<MENU_SELS.length;i++){var el=document.querySelector(MENU_SELS[i]);if(!el)continue;var r=el.getBoundingClientRect(),h=r.height,w=r.width;var ok=h>=32&&h<=120&&r.top>-20&&r.top<180&&w>300;if(ok)bottoms.push(Math.round(r.bottom));}var best=bottoms.length?Math.min.apply(null,bottoms):120;if(best>200)best=120;try{var force=localStorage.getItem('ct_force_header_px');if(force)best=parseInt(force,10)||best;}catch(e){}return best;}
  function measure(el,fb){if(!el)return fb;var r=el.getBoundingClientRect();return Math.max(fb,Math.round(r.height));}
  function apply(){var blueTop=pickMenuBottom()+GAP;var barH=measure(document.querySelector('.top-bar'),52);var navH=measure(document.querySelector('nav.app-nav'),48);
    document.documentElement.style.setProperty('--blueTop',blueTop+'px');
    document.documentElement.style.setProperty('--barH',barH+'px');
    document.documentElement.style.setProperty('--navH',navH+'px');
    document.documentElement.style.setProperty('--pagePad',(blueTop+barH+navH)+'px');}
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',apply);}else{apply();}
  addEventListener('resize',apply,{passive:true}); addEventListener('orientationchange',apply,{passive:true});
})();
</script>
</head>
<body>

<!-- ===== Blue bar ===== -->
<div class="top-bar">
  <h2>Messages</h2>
  <div class="top-actions">
    <button id="btnNotif" class="pillbtn" type="button">Notifications</button>
    <button id="btnInbox" class="pillbtn" type="button">Inbox</button>
    <button id="btnMsgs" class="pillbtn" type="button">Messages</button>
    <img id="myProfile" title="My Profile" />
  </div>
</div>

<!-- ===== Chip nav ===== -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a href="feed.html">Feed</a>
    <a href="friends.html">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a class="active" href="messages.html" aria-current="page">Messages</a>
    <a href="music.html">Music</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- ===== Page ===== -->
<div class="page">
  <div class="cols">

    <!-- Threads -->
    <section class="card">
      <div class="list-head">
        <input id="search" placeholder="Search people…" />
        <button id="newChat" class="btn">New</button>
      </div>
      <div id="threads" class="threads"></div>
      <div id="threadsEmpty" class="empty" style="display:none">No conversations yet.</div>
    </section>

    <!-- Chat -->
    <section class="card">
      <div class="chat" id="chatWrap">
        <div class="chat-head">
          <img class="ava" id="chatAva" alt="">
          <div style="min-width:0">
            <div class="name" id="chatName">—</div>
            <div class="muted" id="chatHint">Select a conversation to start chatting</div>
          </div>
          <div style="margin-left:auto;display:flex;gap:8px">
            <button class="btn" id="viewProfile">View Profile</button>
          </div>
        </div>
        <div class="chat-body" id="chatBody"></div>
        <div class="chat-input">
          <textarea id="composer" placeholder="Type a message…"></textarea>
          <button id="sendBtn" class="btn primary">Send</button>
        </div>
      </div>
    </section>

  </div>
</div>

<!-- Notifications Modal -->
<div class="modalbg" id="notifBg">
  <div class="sheet">
    <h3 style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="list-head" style="border:none;padding:8px 0 0">
      <button id="clearNotif" class="btn primary">Clear</button>
      <button id="closeNotif" class="btn">Close</button>
    </div>
  </div>
</div>
<!-- Inbox Modal -->
<div class="modalbg" id="inboxBg">
  <div class="sheet">
    <h3 style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="list-head" style="border:none;padding:8px 0 0">
      <button id="closeInbox" class="btn">Close</button>
    </div>
  </div>
</div>

<!-- Error overlay -->
<div id="errOverlay"><div id="errPanel">
  <h3 style="margin:0 0 8px">⚠️ Script error</h3>
  <p class="muted" style="margin:0 0 10px">Nothing will blank; details below so we can fix fast:</p>
  <pre id="errText"></pre>
  <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:8px">
    <button class="btn" onclick="document.getElementById('errOverlay').style.display='none'">Close</button>
  </div>
</div></div>

<script>
/* ===== never-blank overlay ===== */
(function(){
  function show(msg){ var o=document.getElementById('errOverlay'); var t=document.getElementById('errText'); if(!o||!t) return; t.textContent=String(msg||'Unknown error'); o.style.display='flex'; }
  window.addEventListener('error',function(e){ show(e.error? (e.error.stack||e.error.message||e.message) : e.message); });
  window.addEventListener('unhandledrejection',function(e){ var r=e.reason; show(r && (r.stack||r.message||String(r))); });
})();
</script>

<script>
/* ===== API base (optional) + remote shim ===== */
var API_BASE=(function(){
  try{
    var win=(window.CT_API_BASE||window.ct_api_base||'');
    var lc =localStorage.getItem('ct_api_base');
    var uc =localStorage.getItem('CT_API_BASE');
    var v=win||lc||uc;
    if(v){ var j=(typeof v==='string')?v:JSON.stringify(v); return (typeof v==='string')?v:JSON.parse(j); }
  }catch(e){}
  return 'https://chatternet-backend-1.onrender.com/api';
})();
async function api(path,opts){
  opts = opts || {};
  var r = await fetch(API_BASE+path,{headers:{'Content-Type':'application/json'},method:opts.method||'GET',body:opts.body||null});
  var t = await r.text(); var j=null; try{ j=t?JSON.parse(t):null; }catch(e){}
  if(!r.ok) throw new Error((j && (j.error||j.message)) || t || 'Request failed');
  return j;
}
/* Prefer window.Api.messages if present; otherwise stay local-only. */
var RemoteDM = {
  available:function(){
    return !!(window.Api && Api.messages && typeof Api.messages.list==='function' && typeof Api.messages.send==='function');
  },
  list: async function(withName){
    if(!this.available()) return null;
    try{ return await Api.messages.list({ with: withName }); }catch(e){ return null; }
  },
  send: async function(to,text){
    if(!this.available()) return null;
    try{ return await Api.messages.send({ to: to, text: text }); }catch(e){ return null; }
  }
};

/* ===== Keys / helpers (shared) ===== */
var LS={
  USERS:'ct_users_v3',
  PROFILE:'ct_profile_data_v1',
  VIEW:'ct_profile_view_v1',
  NOTIF:'ct_notifications_v1',
  INBOX:'ct_inbox_v1',
  MSGS:'ct_messages_v3',
  OUTBOX:'ct_messages_outbox_v1'
};
function $(s){ return document.querySelector(s); }
function $all(s){ return Array.prototype.slice.call(document.querySelectorAll(s)); }
function load(k,f){ try{ var v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch(e){ return f; } }
function save(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} }
function uid(p){ p=p||'id'; return p+'_'+Date.now().toString(36)+'_'+Math.random().toString(36).slice(2,7); }
function nowISO(){ return new Date().toISOString(); }
function esc(s){
  s = String(s==null?'':s);
  var map = {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"};
  return s.replace(/[&<>"']/g, function(c){ return map[c]; });
}
function goToProfile(name){ try{localStorage.setItem(LS.VIEW,JSON.stringify({name:name}));}catch(e){} location.href='profile.html'; }
function addNotif(text){ var arr=load(LS.NOTIF,[]); arr.unshift({id:uid('n'),text:text,time:nowISO()}); save(LS.NOTIF,arr); }
function addInbox(text){ var arr=load(LS.INBOX,[]); arr.unshift({id:uid('m'),text:text,time:nowISO()}); save(LS.INBOX,arr); }

/* ===== Seed users + bots ===== */
var BOTS=[
  {name:'Bill Thomas',u:'bill.thomas'},{name:'Kate White',u:'kate.white'},
  {name:'Michael Reed',u:'michael.reed'},{name:'Olivia Perez',u:'olivia.perez'},
  {name:'David Carter',u:'david.carter'},{name:'Emily Johnson',u:'emily.johnson'},
  {name:'Jason Brooks',u:'jason.brooks'},{name:'Sophia Turner',u:'sophia.turner'},
  {name:'Daniel Foster',u:'daniel.foster'},{name:'Grace Lee',u:'grace.lee'}
];
(function seedUsers(){
  var users=load(LS.USERS,null);
  if(!users){
    users=[{name:'Me',avatar:'https://i.pravatar.cc/100?u=me'}];
    BOTS.forEach(function(b){users.push({name:b.name,avatar:'https://i.pravatar.cc/100?u='+encodeURIComponent(b.u)})});
  }else{
    users=users.filter(function(u){return !/^User\d+$/i.test(u.name);});
    if(!users.find(function(u){return u.name==='Me';})) users.unshift({name:'Me',avatar:'https://i.pravatar.cc/100?u=me'});
    BOTS.forEach(function(b){ if(!users.find(function(u){return u.name===b.name;})) users.push({name:b.name,avatar:'https://i.pravatar.cc/100?u='+encodeURIComponent(b.u)}); });
  }
  save(LS.USERS,users);
})();
var Users=load(LS.USERS,[]);
function userByName(n){ return Users.find(function(u){return u.name===n;})||Users[0]||{name:'Me',avatar:'https://i.pravatar.cc/100?u=me'}; }

/* ===== Header wiring (base stack) ===== */
function meDisplay(){ var p=load(LS.PROFILE,{})['Me']; return (p && p.displayName && p.displayName.trim())?p.displayName.trim():'Me'; }
function meAvatar(){ var arr=load(LS.USERS,[]); var me=(arr||[]).find(function(u){return u.name==='Me';}); return (me&&me.avatar)?me.avatar:'https://i.pravatar.cc/100?u=me'; }
(function wireHeader(){
  var img=$('#myProfile'); if(img){ img.referrerPolicy='no-referrer'; img.loading='lazy'; img.src=meAvatar(); img.alt=meDisplay(); img.onclick=function(){goToProfile('Me');}; }
  var msgsBtn = document.getElementById('btnMsgs');
  if(msgsBtn){ msgsBtn.addEventListener('click',function(e){ e.preventDefault(); if(window.ctOpen){ ctOpen(); return; } if(window.ChatternetMessenger && window.ChatternetMessenger.open){ window.ChatternetMessenger.open(''); return; } location.href='messages.html'; }); }

  // Notifications
  var notifBg=document.getElementById('notifBg'), notifList=document.getElementById('notifList');
  function renderNotif(){ var arr=load(LS.NOTIF,[]); notifList.innerHTML=''; if(!arr.length){notifList.innerHTML='<div class="notif-item">No notifications yet.</div>';return;} arr.forEach(function(n){var d=document.createElement('div'); d.className='notif-item'; d.innerHTML='<strong>'+new Date(n.time).toLocaleString()+'</strong><br>'+esc(n.text); notifList.appendChild(d);});}
  var btnNotif=document.getElementById('btnNotif'); if(btnNotif) btnNotif.addEventListener('click',function(){ renderNotif(); notifBg.style.display='flex'; });
  var clearNotif=document.getElementById('clearNotif'); if(clearNotif) clearNotif.addEventListener('click',function(){ save(LS.NOTIF,[]); renderNotif(); });
  var closeNotif=document.getElementById('closeNotif'); if(closeNotif) closeNotif.addEventListener('click',function(){ notifBg.style.display='none'; });

  // Inbox
  var inboxBg=document.getElementById('inboxBg'), inboxList=document.getElementById('inboxList');
  function renderInbox(){ var arr=load(LS.INBOX,[]); inboxList.innerHTML=''; if(!arr.length){inboxList.innerHTML='<div class="notif-item">Inbox is empty.</div>';return;} arr.forEach(function(n){var d=document.createElement('div'); d.className='notif-item'; d.innerHTML='<strong>'+new Date(n.time).toLocaleString()+'</strong><br>'+esc(n.text); inboxList.appendChild(d);});}
  var btnInbox=document.getElementById('btnInbox'); if(btnInbox) btnInbox.addEventListener('click',function(){ renderInbox(); inboxBg.style.display='flex'; });
  var closeInbox=document.getElementById('closeInbox'); if(closeInbox) closeInbox.addEventListener('click',function(){ inboxBg.style.display='none'; });

  document.addEventListener('click',function(e){ var t=e.target && e.target.closest && e.target.closest('[data-profile-name]'); if(t){ goToProfile(t.getAttribute('data-profile-name')); } });
})();

/* ===== Local message store + outbox ===== */
var DM = {
  all:function(){ return load(LS.MSGS,[]); },
  save:function(arr){ save(LS.MSGS,arr); },
  outbox:function(){ return load(LS.OUTBOX,[]); },
  saveOutbox:function(arr){ save(LS.OUTBOX,arr); },
  listThreadNames:function(){
    var set={};
    this.all().forEach(function(m){ if(m.a!=='Me') set[m.a]=1; if(m.b!=='Me') set[m.b]=1; });
    Users.forEach(function(u){ if(u.name!=='Me') set[u.name]=1; });
    return Object.keys(set);
  },
  listWith:function(name){
    return this.all().filter(function(m){ return (m.a==='Me'&&m.b===name) || (m.a===name&&m.b==='Me'); })
      .sort(function(x,y){ return new Date(x.timeISO)-new Date(y.timeISO); });
  },
  addLocal:function(msg){
    var arr=this.all();
    if(!arr.find(function(x){return x.id===msg.id;})) arr.push(msg);
    this.save(arr);
  },
  markDelivered:function(localId){
    var arr=this.all();
    var it=arr.find(function(x){return x.id===localId;});
    if(it){ delete it.pending; this.save(arr); }
  }
};

/* ===== Bots (fun replies) ===== */
var BOT_NAMES = (function(){ var s={}; BOTS.forEach(function(b){s[b.name]=1;}); return s; })();
var BOT_LINES = [
  "Sounds good", "Let me check on that.", "Nice!", "I agree.", "Haha true",
  "What's your take?", "I’ll get back to you.", "Interesting point.", "Totally!", "Thanks for sharing."
];
function randomBotLine(){ return BOT_LINES[Math.floor(Math.random()*BOT_LINES.length)]; }
function maybeBotReply(peer){
  if(!BOT_NAMES[peer]) return;
  var when = 400 + Math.floor(Math.random()*700);
  setTimeout(function(){
    var msg={ id:uid('m'), a:peer, b:'Me', text:randomBotLine(), timeISO:nowISO(), origin:'local' };
    DM.addLocal(msg);
    addInbox(peer+' replied: "'+msg.text+'"');
    if(ACTIVE===peer){ renderChat(peer); renderThreads(); }
  }, when);
}

/* ===== Remote sync (optional) ===== */
async function syncOutbox(){
  if(!RemoteDM.available()) return;
  var pending=DM.outbox(); if(!pending.length) return;
  var remain=[];
  for(var i=0;i<pending.length;i++){
    var item=pending[i];
    try{ await RemoteDM.send(item.to, item.text); DM.markDelivered(item.localId); }
    catch(e){ remain.push(item); }
  }
  DM.saveOutbox(remain);
}
async function pullRemote(withName){
  if(!RemoteDM.available()) return false;
  try{
    var list=await RemoteDM.list(withName || null);
    if(!Array.isArray(list)) return false;
    list.forEach(function(r){
      var msg={
        id:String(r.id||uid('rm')),
        a: r.from==='Me'?'Me':(r.from||withName||''),
        b: r.to==='Me'?'Me':(r.to||'Me'),
        text: r.text||'',
        timeISO: r.createdAt || nowISO(),
        origin:'remote'
      };
      DM.addLocal(msg);
    });
    return true;
  }catch(e){ return false; }
}

/* ===== UI state ===== */
var ACTIVE='';
var threadsEl=document.getElementById('threads'), threadsEmpty=document.getElementById('threadsEmpty');
var chatName=document.getElementById('chatName'), chatHint=document.getElementById('chatHint'), chatAva=document.getElementById('chatAva');
var chatBody=document.getElementById('chatBody'), composer=document.getElementById('composer');

function threadRow(name){
  var u=userByName(name);
  var msgs=DM.listWith(name);
  var last=msgs[msgs.length-1];
  var row=document.createElement('div'); row.className='thread'; if(name===ACTIVE) row.className+=' active';
  var lastLine = last ? ((last.a==='Me'?'You: ':'') + (last.text||'')) : 'No messages yet';
  row.innerHTML='<img class="ava" src="'+esc(u.avatar)+'" alt="'+esc(name)+'" />\
    <div class="t-meta">\
      <div class="t-name" data-profile-name="'+esc(name)+'">'+esc(name)+'</div>\
      <div class="t-last">'+esc(lastLine)+'</div>\
    </div>\
    <div class="t-time">'+(last? new Date(last.timeISO).toLocaleTimeString(): '')+'</div>';
  row.onclick=function(){ openChat(name); };
  return row;
}

function renderThreads(){
  var q=(document.getElementById('search').value||'').toLowerCase();
  var names=DM.listThreadNames().filter(function(n){return n.toLowerCase().indexOf(q)>-1;});
  threadsEl.innerHTML='';
  if(!names.length){ threadsEmpty.style.display='block'; return; }
  threadsEmpty.style.display='none';
  names.sort(function(a,b){return a.localeCompare(b);}).forEach(function(n){threadsEl.appendChild(threadRow(n));});
}

function dayLabel(dateISO){
  var d=new Date(dateISO), today=new Date(); var yest=new Date(Date.now()-86400000);
  var dStr=d.toDateString(), tStr=today.toDateString(), yStr=yest.toDateString();
  return dStr===tStr?'Today': dStr===yStr?'Yesterday' : d.toLocaleDateString();
}

function messageBubble(m){
  var me = (m.a==='Me');
  var d=document.createElement('div'); d.className='msg'+(me?' me':'');
  var pending = me && m.pending ? ' • sending…' : '';
  d.innerHTML='<div class="bubble">'+esc(m.text||'')+'</div><div class="m-time">'+new Date(m.timeISO).toLocaleTimeString()+pending+'</div>';
  return d;
}

function renderChat(name){
  var u=userByName(name);
  chatAva.src=u.avatar; chatAva.alt=name;
  chatName.textContent = name==='Me'?meDisplay():name;
  chatHint.textContent = 'Chatting with '+name;
  var msgs=DM.listWith(name);
  chatBody.innerHTML='';
  var lastDay='';
  msgs.forEach(function(m){
    var label=dayLabel(m.timeISO);
    if(label!==lastDay){ var tag=document.createElement('div'); tag.className='day'; tag.textContent=label; chatBody.appendChild(tag); lastDay=label; }
    chatBody.appendChild(messageBubble(m));
  });
  chatBody.scrollTop=chatBody.scrollHeight;
}

function openChat(name){
  ACTIVE=name;
  renderThreads();
  renderChat(name);
  var vp=document.getElementById('viewProfile');
  if(vp){ vp.onclick=function(){ goToProfile(name); }; }
  composer.focus();
  pullRemote(name).then(function(updated){ if(updated){ renderChat(name); renderThreads(); }});
}

document.getElementById('search').addEventListener('input',renderThreads);
document.getElementById('newChat').onclick=function(){
  var name = prompt('Start a chat with… (exact name)', '');
  if(!name) return;
  var u=userByName(name);
  if(!u){ alert('User not found on this device.'); return; }
  openChat(name);
};

async function sendMessage(){
  var text=(composer.value||'').trim();
  if(!ACTIVE){ alert('Pick someone to chat with.'); return; }
  if(!text){ return; }

  var localId=uid('m');
  var localMsg={ id:localId, a:'Me', b:ACTIVE, text:text, timeISO:nowISO(), pending:true, origin:'local' };
  DM.addLocal(localMsg);

  var box=DM.outbox(); box.push({ localId:localId, to:ACTIVE, text:text }); DM.saveOutbox(box);

  composer.value=''; renderChat(ACTIVE); renderThreads();
  addInbox('New message to '+ACTIVE+': "'+text.slice(0,80)+(text.length>80?'…':'')+'"');

  if(RemoteDM.available()){
    try{ await RemoteDM.send(ACTIVE,text); DM.markDelivered(localId); if(ACTIVE){ renderChat(ACTIVE); } }
    catch(e){ /* keep pending; will retry via syncOutbox */ }
  } else {
    maybeBotReply(ACTIVE);
  }
}
document.getElementById('sendBtn').onclick=sendMessage;
composer.addEventListener('keydown',function(e){
  if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});

/* ===== Boot ===== */
(function boot(){
  var msgsBtn=document.getElementById('btnMsgs');
  if(msgsBtn){ msgsBtn.onclick=function(e){ e.preventDefault(); if(window.ctOpen){ ctOpen(); return; } location.href='messages.html'; }; }

  renderThreads();
  try{
    var qs=new URLSearchParams(location.search);
    var withName=qs.get('with');
    if(withName && userByName(withName)){ openChat(withName); }
  }catch(e){}

  setInterval(async function(){
    await syncOutbox();
    if(ACTIVE){ var updated = await pullRemote(ACTIVE); if(updated) { renderChat(ACTIVE); renderThreads(); } }
  }, 8000);
})();
</script>

<!-- ===== Inline BASE GATE (device-only lock) ===== -->
<style>
  .gate-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:4000}
  .gate{width:min(520px,92vw);background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:16px}
  .gate h3{margin:0 0 6px;font-weight:800}
  .gate p{margin:4px 0 10px;color:#667085}
  .gate .row{display:flex;gap:8px}
  .gate input,.gate button{padding:10px;border-radius:10px;border:1px solid #d7d7d7;font-size:14px}
  .gate input{flex:1}
  .gate .primary{background:#3498db;border-color:#3498db;color:#fff;cursor:pointer}
  .gate .err{color:#b91c1c;margin-top:6px;display:none}
</style>
<div id="ctGate" class="gate-bg" aria-hidden="true">
  <div class="gate" role="dialog" aria-modal="true" aria-labelledby="ctGateTitle">
    <h3 id="ctGateTitle">Welcome back</h3>
    <p>This lock screen protects your pages on this device only.</p>
    <div class="row" style="margin:6px 0"><input id="gateEmail" type="email" placeholder="Email" autocomplete="username" /></div>
    <div class="row" style="margin:6px 0"><input id="gatePass" type="password" placeholder="Password" autocomplete="current-password" /></div>
    <div class="row" style="margin-top:6px">
      <button id="gateSubmit" class="primary" style="flex:1">Continue</button>
      <button id="gateMode" type="button" style="flex:0 0 140px">Use sign up</button>
    </div>
    <div id="gateErr" class="err">Invalid email or password.</div>
    <p class="muted" style="margin-top:10px;font-size:12px">Data lives in your browser (localStorage).</p>
  </div>
</div>
<script>
(function(){
  var LS_ACC='ct_accounts_v2', LS_SESS='ct_session_v2', LS_SESS_V1='ct_session_v1';
  function qs(s){ return document.querySelector(s); }
  function load(k,f){ try{ var v=localStorage.getItem(k); return v?JSON.parse(v):f; }catch(e){ return f; } }
  function save(k,v){ try{ localStorage.setItem(k,JSON.stringify(v)); }catch(e){} }
  function isLoggedIn(){ var s=load(LS_SESS,null), accs=load(LS_ACC,{}); return !!(s && accs[s.user]); }
  function setSession(user){ var sess={user:user,time:new Date().toISOString()}; save(LS_SESS,sess); save(LS_SESS_V1,sess); try{ window.dispatchEvent(new CustomEvent('ct:login',{detail:sess})); }catch(e){} }
  function clearSession(){ try{ localStorage.removeItem(LS_SESS); localStorage.removeItem(LS_SESS_V1); }catch(e){} try{ window.dispatchEvent(new Event('ct:logout')); }catch(e){} }
  var Gate={
    open:function(){ var bg=qs('#ctGate'); if(bg){ bg.style.display='flex'; bg.setAttribute('aria-hidden','false'); var ge=qs('#gateEmail'); if(ge) setTimeout(function(){ ge.focus(); },0); } },
    close:function(){ var bg=qs('#ctGate'); if(bg){ bg.style.display='none'; bg.setAttribute('aria-hidden','true'); var er=qs('#gateErr'); if(er) er.style.display='none'; } },
    require:function(){ if(isLoggedIn()) return true; Gate.open(); return false; },
    logout:function(){ clearSession(); Gate.open(); }
  };
  window.Gate=Gate;
  window.Auth = window.Auth || {};
  window.Auth.isLoggedIn = isLoggedIn;
  window.Auth.require = function(){ return Gate.require(); };

  var signup=false;
  qs('#gateMode').onclick=function(){ signup=!signup; qs('#gateMode').textContent = signup?'Use login':'Use sign up'; qs('#ctGateTitle').textContent = signup?'Create account':'Welcome back'; };
  qs('#gateSubmit').onclick=function(){
    var email=(qs('#gateEmail').value||'').trim().toLowerCase();
    var pass =(qs('#gatePass').value||'').trim();
    if(!email || !pass){ var er=qs('#gateErr'); if(er){ er.textContent='Enter email & password.'; er.style.display='block'; } return; }
    var acc=load(LS_ACC,{}); var key='Me';
    if(signup || !acc[key]){ acc[key]={email:email,password:pass}; save(LS_ACC,acc); setSession(key); Gate.close(); return; }
    if(acc[key] && acc[key].password===pass){ setSession(key); Gate.close(); } else { var er2=qs('#gateErr'); if(er2){ er2.textContent='Invalid email or password.'; er2.style.display='block'; } }
  };

  if (!window.CT_GATE_DISABLE) Gate.require();
})();
</script>
<!-- ===== /Inline BASE GATE ===== -->

</body>
</html>
