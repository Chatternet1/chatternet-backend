<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Feed — Chatternet</title>

  <!-- Layout shim: places blue bar just under Weebly menu -->
  <script src="assets/ct-layout.js" defer></script>

  <style>
    :root{
      --brand:#2563eb;
      --blue-top: var(--ct-bluebar-top, 132px);
    }
    html,body{overflow-y:auto !important}
    *{box-sizing:border-box}
    body{
      margin:0;
      font:14px/1.45 "Segoe UI", Arial, system-ui, -apple-system, sans-serif;
      color:#0f172a; background:#f5f7fb;
      /* Blue bar (48) + app-nav (≈48) */
      padding-top: calc(var(--blue-top) + 96px);
    }
    a{color:var(--brand);text-decoration:none}

    /* Top blue bar */
    .top-bar{
      position:sticky; top:var(--blue-top); z-index:1200;
      display:flex; align-items:center; justify-content:space-between;
      padding:10px 14px; background:#0ea5e9; color:#fff;
      border-bottom:1px solid rgba(255,255,255,.2);
    }
    .top-bar h2{margin:0;font-size:18px}
    .top-actions{display:flex; gap:10px; align-items:center}
    .top-actions button{
      height:36px; padding:0 12px; border-radius:999px;
      border:1px solid rgba(255,255,255,.7);
      background:rgba(255,255,255,.15); color:#fff; cursor:pointer
    }
    .top-actions button:hover{background:rgba(255,255,255,.26)}
    #meAvatar{width:36px;height:36px;border-radius:999px;border:2px solid rgba(255,255,255,.7);object-fit:cover;cursor:pointer}

    /* App nav (IDENTICAL to Friends) */
    nav.app-nav{
      position:sticky; top:calc(var(--blue-top) + 48px); z-index:1100;
      background:#fff; border-bottom:1px solid #e6eaf2;
    }
    nav.app-nav .inner{max-width:1100px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px}
    nav.app-nav a{padding:8px 10px;border-radius:999px;color:#111;background:#f3f4f6}
    nav.app-nav a.active{background:#dbeafe;color:#1e3a8a}
    nav.app-nav a:hover{background:#e5e7eb}

    /* Page */
    .page{max-width:1100px;margin:14px auto;padding:0 12px;display:grid;grid-template-columns:1fr 320px;gap:14px}
    @media (max-width:1020px){ .page{grid-template-columns:1fr} }

    .card{background:#fff;border:1px solid #e6eaf2;border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(15,23,42,.03)}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:#6b7280}

    /* Composer */
    .composer .who{display:flex;gap:10px; align-items:center; margin-bottom:10px}
    .composer .ava{width:42px;height:42px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
    .composer textarea{
      width:100%; min-height:130px; resize:vertical; padding:12px;
      border:1px solid #d7d7d7; border-radius:12px; outline:none;
    }
    .composer .tools{display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:8px}
    .btn{padding:8px 12px;border:1px solid #d7d7d7;border-radius:999px;background:#fff;cursor:pointer}
    .btn.primary{background:#3b82f6;border-color:#3b82f6;color:#fff}
    .btn.warn{border-color:#ef4444;color:#b91c1c}
    .input{padding:8px 10px;border:1px solid #d7d7d7;border-radius:10px;min-width:0}
    .input.url{flex:1 1 220px}

    /* Feed list */
    .feed{display:flex;flex-direction:column;gap:10px}
    .post{border:1px solid #e6eaf2;border-radius:14px;padding:12px}
    .post .head{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    .post .ava{width:40px;height:40px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
    .post .author{font-weight:600}
    .post .time{font-size:12px;color:#6b7280}
    .post .txt{white-space:pre-wrap;margin:6px 0 8px}
    .post .img{width:100%;border-radius:12px;border:1px solid #eee;margin:8px 0;display:block}
    .post .actions{display:flex;gap:8px;align-items:center}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6eaf2;background:#f8fafc;border-radius:999px;padding:4px 10px;font-size:12px}

    /* Right column */
    .side .section{margin-bottom:12px}
    .people{display:flex;flex-direction:column;gap:8px}
    .person{display:flex;gap:8px;align-items:center}
    .person .ava{width:34px;height:34px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
  </style>
</head>
<body>

<!-- Sticky blue bar -->
<div class="top-bar" role="banner" aria-label="Page header">
  <h2>Feed</h2>
  <div class="top-actions">
    <button id="btnNotif">Notifications</button>
    <button id="btnInbox">Inbox</button>
    <button id="btnMsgs">Messages</button>
    <img id="meAvatar" alt="My Profile" title="My Profile" />
  </div>
</div>

<!-- App Nav (identical to Friends) -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a class="active" href="feed.html" aria-current="page">Feed</a>
    <a href="friends.html">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a href="music.html">Music</a>
    <a href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- Page -->
<div class="page">

  <!-- Main column -->
  <main>
    <!-- Composer -->
    <section class="card composer">
      <div class="who">
        <img id="meAvatar2" class="ava" alt="">
        <div>
          <div><strong id="meName">Me</strong></div>
          <div class="muted" style="font-size:12px">What’s on your mind?</div>
        </div>
      </div>
      <textarea id="composerText" placeholder="Write something to your friends…"></textarea>
      <div class="tools">
        <input id="imgUrl" class="input url" placeholder="Optional image URL (paste and Post)"/>
        <button id="btnPost" class="btn primary">Post</button>
        <button id="btnClear" class="btn">Clear</button>
      </div>
    </section>

    <!-- Feed list -->
    <section id="feedList" class="feed"></section>
  </main>

  <!-- Right column -->
  <aside class="side">
    <div class="card section">
      <div class="row" style="justify-content:space-between">
        <strong>People you may know</strong>
        <a href="friends.html">See all</a>
      </div>
      <div id="suggestions" class="people"></div>
    </div>

    <div class="card section">
      <strong>Quick actions</strong>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="qaToFriends">Open Friends</button>
        <button class="btn" id="qaToMessages">New Message</button>
        <button class="btn" id="qaClearFeed">Clear Feed</button>
      </div>
    </div>
  </aside>
</div>

<!-- Notifications / Inbox Modals -->
<div class="modalbg" id="notifBg">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="row" style="margin-top:8px">
      <button id="clearNotif" class="btn primary">Clear</button>
      <button id="closeNotif" class="btn">Close</button>
    </div>
  </div>
</div>
<div class="modalbg" id="inboxBg">
  <div class="sheet">
    <h3 class="section-title" style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="row" style="margin-top:8px">
      <button id="closeInbox" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
/* ===== Keys & helpers ===== */
const LS = {
  USERS:'ct_users_v3', PROFILE:'ct_profile_data_v1',
  NOTIF:'ct_notifications_v1', INBOX:'ct_inbox_v1',
  FEED:'ct_feed_posts_v1'
};
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const load=(k,f)=>{ try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;} };
const save=(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} };
const nowISO=()=>new Date().toISOString();
const esc=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'","&#39;");
const face=n=>`https://i.pravatar.cc/200?u=${encodeURIComponent(n||'me')}`;
const timeAgo = (iso)=>{ const d=(Date.now()-new Date(iso).getTime())/1000;
  if(d<60) return `${Math.floor(d)}s`; if(d<3600) return `${Math.floor(d/60)}m`;
  if(d<86400) return `${Math.floor(d/3600)}h`; return `${Math.floor(d/86400)}d`; };

/* ===== Header wiring ===== */
(function header(){
  const prof=(load(LS.PROFILE,{}))['Me']||{};
  const meA=$('#meAvatar'); if(meA){ meA.referrerPolicy='no-referrer'; meA.loading='lazy'; meA.src=prof.avatar||face('Me'); meA.alt='Me';
    meA.onclick=()=>{ try{localStorage.setItem('ct_profile_view_v1',JSON.stringify({name:'Me'}));}catch{} location.href='profile.html'; }; }
  const meA2=$('#meAvatar2'); if(meA2){ meA2.referrerPolicy='no-referrer'; meA2.loading='lazy'; meA2.src=prof.avatar||face('Me'); }
  $('#meName').textContent = prof.displayName || 'Me';

  $('#btnMsgs')?.addEventListener('click',e=>{
    e.preventDefault();
    if(window.ctOpen) return ctOpen();
    if(window.ChatternetMessenger?.open) return window.ChatternetMessenger.open();
    location.href='messages.html';
  });

  const nbg=$('#notifBg'), ibg=$('#inboxBg');
  function rN(){ const arr=load(LS.NOTIF,[]); const box=$('#notifList');
    box.innerHTML=arr.length?arr.map(n=>`<div class="pill" style="display:block">${new Date(n.time).toLocaleString()} — ${esc(n.text||'')}</div>`).join(''):'No notifications yet.'; }
  function rI(){ const arr=load(LS.INBOX,[]); const box=$('#inboxList');
    box.innerHTML=arr.length?arr.map(n=>`<div class="pill" style="display:block">${new Date(n.time).toLocaleString()} — ${esc(n.text||'')}</div>`).join(''):'Inbox is empty.'; }
  $('#btnNotif').onclick=()=>{ rN(); nbg.style.display='flex'; };
  $('#clearNotif').onclick=()=>{ save(LS.NOTIF,[]); rN(); };
  $('#closeNotif').onclick=()=>{ nbg.style.display='none'; };
  $('#btnInbox').onclick=()=>{ rI(); ibg.style.display='flex'; };
  $('#closeInbox').onclick=()=>{ ibg.style.display='none'; };
})();

/* ===== Seed users (so feed/suggestions have people) ===== */
(function seedUsers(){
  let u = load(LS.USERS, []);
  const WANT = ['Emma Davis','Ethan Brooks','Olivia Perez','Logan Price','Mia Carter','Lucas Reed','Chloe Evans','Henry Scott','Amelia Ross','Elijah Gray','Isabella Wood','James Hall','Luna Kelly','Benjamin Ward','Aria King','Michael Reed','Jason Brooks','Daniel Foster','Echo Bot'];
  const names = new Set(u.map(x=>x && x.name).filter(Boolean));
  if(!names.has('Me')) u.unshift({name:'Me',avatar:face('Me')});
  if(u.filter(x=>x.name!=='Me').length < 8){
    WANT.forEach(n=>{ if(!names.has(n)){ u.push({name:n, avatar:face(n)}); names.add(n); } });
  }
  save(LS.USERS, u);
})();

/* ===== Feed store ===== */
const posts   = ()=>load(LS.FEED, []);
const setPosts= (arr)=>save(LS.FEED, arr);

/* Seed posts if empty */
(function seedFeed(){
  let p = posts();
  if(Array.isArray(p) && p.length) return;
  const take = load(LS.USERS,[]).filter(x=>x.name!=='Me').slice(0,5).map(x=>x.name);
  const demo = [
    {a: take[0]||'Emma Davis', t:"What a sunny day in Horsham ☀️ Walking the dog later!"},
    {a: take[1]||'Ethan Brooks', t:"Cooking pasta tonight. Any favorite sauces?"},
    {a: 'Me', t:"Hello, world! First post on Chatternet 🎉"},
    {a: take[2]||'Olivia Perez', t:"Finished a great documentary—recommendations welcome."},
    {a: take[3]||'Logan Price', t:"Gym done ✅ Coffee time."}
  ];
  p = demo.map(d=>({
    id: 'p_'+Math.random().toString(36).slice(2),
    author: d.a, avatar: face(d.a), text: d.t, time: nowISO(),
    likes: Math.floor(Math.random()*15), comments: Math.floor(Math.random()*6),
    img: null
  }));
  setPosts(p);
})();

/* ===== Composer ===== */
$('#btnPost').addEventListener('click', ()=>{
  const txt = ($('#composerText').value||'').trim();
  const img = ($('#imgUrl').value||'').trim();
  if(!txt && !img) return;
  const me = 'Me';
  const p = posts();
  p.unshift({
    id:'p_'+Math.random().toString(36).slice(2),
    author: me, avatar: face(me), text: txt, time: nowISO(),
    likes:0, comments:0, img: img||null
  });
  setPosts(p);
  $('#composerText').value=''; $('#imgUrl').value='';
  renderFeed();
});
$('#btnClear').addEventListener('click', ()=>{ $('#composerText').value=''; $('#imgUrl').value=''; });

/* ===== Render feed ===== */
function postHtml(p){
  return `
  <article class="post" data-id="${esc(p.id)}">
    <div class="head">
      <img class="ava" src="${esc(p.avatar||face(p.author))}" alt="">
      <div style="min-width:0;flex:1">
        <div class="author">${esc(p.author)}</div>
        <div class="time">${esc(timeAgo(p.time))} ago</div>
      </div>
      <button class="btn" data-act="message" data-name="${esc(p.author)}">Message</button>
    </div>
    <div class="txt">${esc(p.text||'')}</div>
    ${p.img ? `<img class="img" src="${esc(p.img)}" alt="">` : ``}
    <div class="actions">
      <button class="btn" data-act="like">👍 Like</button>
      <span class="pill" data-role="counts">${p.likes} likes • ${p.comments} comments</span>
      <button class="btn" data-act="comment">💬 Comment</button>
      <button class="btn warn" data-act="delete">Delete</button>
    </div>
  </article>`;
}
function renderFeed(){
  const box = $('#feedList'); const p = posts();
  box.innerHTML = p.length ? p.map(postHtml).join('') : '<div class="card muted">No posts yet. Say hello using the composer above.</div>';
}
renderFeed();

/* Post actions */
$('#feedList').addEventListener('click', (e)=>{
  const btn = e.target.closest('button[data-act]'); if(!btn) return;
  const act = btn.getAttribute('data-act');
  const art = btn.closest('.post'); if(!art) return;
  const id  = art.getAttribute('data-id');
  let p = posts(); const i = p.findIndex(x=>x.id===id); if(i<0) return;

  if(act==='like'){ p[i].likes += 1; setPosts(p); renderFeed(); }
  else if(act==='comment'){ p[i].comments += 1; setPosts(p); renderFeed(); }
  else if(act==='delete'){ p.splice(i,1); setPosts(p); renderFeed(); }
  else if(act==='message'){ const name = btn.getAttribute('data-name') || p[i].author; if(window.ctMessage) ctMessage(name); else location.href='messages.html'; }
});

/* Suggestions (right column) */
(function suggestions(){
  const box = $('#suggestions'); const u = load(LS.USERS, []).filter(x=>x.name!=='Me').slice(0,6);
  box.innerHTML = u.map(x=>`
    <div class="person">
      <img class="ava" src="${esc(x.avatar||face(x.name))}" alt="">
      <div style="flex:1;min-width:0">
        <div style="font-weight:600">${esc(x.name)}</div>
        <div class="muted" style="font-size:12px">@${esc(x.name.toLowerCase().replace(/\s+/g,'.'))}</div>
      </div>
      <button class="btn" data-add="${esc(x.name)}">Add</button>
    </div>`).join('');
  box.addEventListener('click',(e)=>{
    const b=e.target.closest('button[data-add]'); if(!b) return;
    const name=b.getAttribute('data-add'); try{
      const k='ct_friend_requests_out_v2'; const out=load(k,[]); if(!out.includes(name)) out.unshift(name); save(k,out);
      const n=load(LS.NOTIF,[]); n.unshift({text:`Friend request sent to ${name}.`,time:nowISO()}); save(LS.NOTIF,n);
      b.textContent='Sent'; b.disabled=true;
    }catch{}
  });
})();

/* Quick actions */
$('#qaToFriends').onclick = ()=>location.href='friends.html';
$('#qaToMessages').onclick = ()=>{ if(window.ctOpen) ctOpen(); else location.href='messages.html'; };
$('#qaClearFeed').onclick  = ()=>{ save(LS.FEED,[]); renderFeed(); };
</script>

<!-- Base loader: shared helpers + messenger overlay -->
<script src="assets/common.js" defer></script>
<script>
(function(){
  "use strict";
  var BASE=(window.CT_API_BASE || localStorage.getItem('ct_api_base') || 'https://chatternet-backend-1.onrender.com').replace(/\/+$/,'');
  window.CT_API_BASE = BASE; try{ localStorage.setItem('ct_api_base', BASE); }catch{}

  function tryLoad(list, done){
    (function next(i){ if(i>=list.length){ done(false); return; }
      var s=document.createElement('script'); s.src=list[i]; s.async=true;
      s.onload=function(){ done(true); }; s.onerror=function(){ s.remove(); next(i+1); };
      (document.head||document.documentElement).appendChild(s);
    })(0);
  }
  var msgPaths=[ BASE+'/assets/messenger.js','/assets/messenger.js','assets/messenger.js','/messenger.js','messenger.js' ];
  tryLoad(msgPaths, function(){
    if(!window.ctOpen){
      window.ctOpen = function(){
        if(window.ChatternetMessenger && typeof window.ChatternetMessenger.open==='function') return window.ChatternetMessenger.open();
        location.href='messages.html';
      };
    }
    if(!window.ctMessage) window.ctMessage = window.ctOpen;
  });
})();
</script>

</body>
</html>
