<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Feed — Chatternet</title>
<style>
  :root{
    --blueTop: 132px;   /* set precisely by script */
    --barH: 52px;       /* measured height of blue bar */
    --navH: 48px;       /* measured height of app nav */
    --pagePad: calc(var(--blueTop) + var(--barH) + var(--navH));
  }
  html,body{margin:0;padding:0;background:#f5f7fb;color:#0f172a;
    font:14px/1.45 "Segoe UI", Arial, system-ui, -apple-system, sans-serif}
  a{color:#2563eb;text-decoration:none}
  *{box-sizing:border-box}

  /* Fixed blue bar (no scrolling) */
  .top-bar{
    position:fixed; left:0; right:0; top:var(--blueTop); z-index:1200;
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 14px; background:#0ea5e9; color:#fff;
    border-bottom:1px solid rgba(255,255,255,.2);
  }
  .top-bar h2{margin:0;font-size:18px;font-weight:700}
  .top-actions{display:flex;gap:10px;align-items:center}
  .pillbtn{
    height:36px;padding:0 12px;border-radius:999px;cursor:pointer;
    border:1px solid rgba(255,255,255,.7);background:rgba(255,255,255,.15);color:#fff
  }
  .pillbtn:hover{background:rgba(255,255,255,.26)}
  #meAvatar{width:36px;height:36px;border-radius:999px;border:2px solid rgba(255,255,255,.7);object-fit:cover;cursor:pointer}

  /* App nav — fixed under blue bar (always visible) */
  nav.app-nav{
    position:fixed; left:0; right:0;
    top:calc(var(--blueTop) + var(--barH));
    z-index:1190; background:#fff; border-bottom:1px solid #e6eaf2;
    visibility:visible !important;
  }
  nav.app-nav .inner{max-width:1100px;margin:0 auto;display:flex;gap:10px;flex-wrap:wrap;padding:8px 12px}
  nav.app-nav a{
    display:inline-block !important; padding:8px 10px !important; border-radius:999px !important;
    color:#111 !important; background:#f3f4f6 !important; text-decoration:none !important;
    line-height:1 !important; font-weight:500 !important;
  }
  nav.app-nav a.active{background:#dbeafe !important; color:#1e3a8a !important}
  nav.app-nav a:hover{background:#e5e7eb !important}

  /* Page: pad = menu->blue gap + blue height + nav height */
  .page{
    max-width:1100px;margin:14px auto;padding:0 12px;
    display:grid;grid-template-columns:1fr 320px;gap:14px;
    padding-top: var(--pagePad);
  }
  @media (max-width:1020px){ .page{grid-template-columns:1fr} }

  .card{background:#fff;border:1px solid #e6eaf2;border-radius:14px;padding:14px;box-shadow:0 4px 12px rgba(15,23,42,.03)}
  .row{display:flex;gap:8px;align-items:center}
  .muted{color:#6b7280}

  /* Composer */
  .who{display:flex;gap:10px;align-items:center;margin-bottom:10px}
  .ava{width:42px;height:42px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
  .composer{min-height:130px;width:100%;resize:vertical;padding:12px;border:1px solid #d7d7d7;border-radius:12px;outline:none}
  .tools{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .btn{padding:8px 12px;border:1px solid #d7d7d7;border-radius:999px;background:#fff;cursor:pointer}
  .btn.primary{background:#3b82f6;border-color:#3b82f6;color:#fff}
  .btn.warn{border-color:#ef4444;color:#b91c1c}
  .input{padding:8px 10px;border:1px solid #d7d7d7;border-radius:10px;min-width:0}
  .input.url{flex:1 1 220px}

  /* Feed */
  .feed{display:flex;flex-direction:column;gap:10px}
  .post{border:1px solid #e6eaf2;border-radius:14px;padding:12px}
  .post .head{display:flex;gap:10px;align-items:center;margin-bottom:8px}
  .post .pava{width:40px;height:40px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
  .post .author{font-weight:600}
  .post .time{font-size:12px;color:#6b7280}
  .post .txt{white-space:pre-wrap;margin:6px 0 8px}
  .post .img{width:100%;border-radius:12px;border:1px solid #eee;margin:8px 0;display:block}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid #e6eaf2;background:#f8fafc;border-radius:999px;padding:4px 10px;font-size:12px}

  /* Comments */
  .cmts{margin-top:10px;border-top:1px solid #eef2f7;padding-top:8px}
  .cmt-item{display:flex;gap:8px;align-items:flex-start;margin:8px 0}
  .cmt-ava{width:28px;height:28px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}
  .cmt-bubble{background:#f8fafc;border:1px solid #e6eaf2;border-radius:12px;padding:8px 10px;max-width:100%}
  .cmt-meta{font-size:12px;color:#6b7280;margin-bottom:4px}
  .cmt-form{display:flex;gap:8px;align-items:center;margin-top:8px}
  .cmt-input{flex:1 1 auto;padding:8px 10px;border:1px solid #d7d7d7;border-radius:999px}
  .cmt-send{padding:8px 12px;border:1px solid #3b82f6;background:#3b82f6;color:#fff;border-radius:999px;cursor:pointer}

  /* Right column */
  .side .section{margin-bottom:12px}
  .people{display:flex;flex-direction:column;gap:8px}
  .person{display:flex;gap:8px;align-items:center}
  .person .picon{width:34px;height:34px;border-radius:999px;border:1px solid #e4e4e7;object-fit:cover}

  /* Modals */
  .modalbg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:4000}
  .sheet{background:#fff;border-radius:12px;max-width:520px;width:92%;max-height:80vh;overflow:auto;box-shadow:0 10px 30px rgba(0,0,0,.3);padding:16px}
</style>

<script>
/* ==== Positioner (measures real heights; picks nearest menu) ==== */
(function(){
  var GAP = 12;
  var MENU_SELS = [
    '.wsite-nav','.wsite-menu-default','.wsite-menus',
    '.w-nav','.nav-wrapper','.navbar',
    '.siteHeader .nav','.desktop-nav','.top-nav',
    'nav[role="navigation"]','.site-navigation'
  ];
  function pickMenuBottom(){
    var bottoms=[];
    for(var i=0;i<MENU_SELS.length;i++){
      var el=document.querySelector(MENU_SELS[i]); if(!el) continue;
      var r=el.getBoundingClientRect(), h=r.height, w=r.width;
      var plausible = h>=32 && h<=120 && r.top>-20 && r.top<180 && w>300;
      if(plausible) bottoms.push(Math.round(r.bottom));
    }
    var best = bottoms.length ? Math.min.apply(null,bottoms) : 120;
    if(best>200) best=120;
    try{ var force=localStorage.getItem('ct_force_header_px'); if(force) best=parseInt(force,10)||best; }catch(e){}
    return best;
  }
  function measure(el, fallback){ if(!el) return fallback; var r=el.getBoundingClientRect(); return Math.max(fallback, Math.round(r.height)); }
  function apply(){
    var blueTop = pickMenuBottom() + GAP;
    var barH = measure(document.querySelector('.top-bar'), 50);
    var navH = measure(document.querySelector('nav.app-nav'), 46);
    document.documentElement.style.setProperty('--blueTop', blueTop+'px');
    document.documentElement.style.setProperty('--barH', barH+'px');
    document.documentElement.style.setProperty('--navH', navH+'px');
    document.documentElement.style.setProperty('--pagePad', (blueTop+barH+navH)+'px');
  }
  if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', apply); } else { apply(); }
  addEventListener('resize', apply, {passive:true});
  addEventListener('orientationchange', apply, {passive:true});
})();
</script>
</head>
<body>

<!-- Fixed blue bar -->
<div class="top-bar" role="banner" aria-label="Page header">
  <h2>Feed</h2>
  <div class="top-actions">
    <button id="btnNotif" class="pillbtn">Notifications</button>
    <button id="btnInbox" class="pillbtn">Inbox</button>
    <button id="btnMsgs" class="pillbtn">Messages</button>
    <img id="meAvatar" alt="My Profile" title="My Profile" />
  </div>
</div>

<!-- Fixed App Nav (under blue bar) -->
<nav class="app-nav" aria-label="Site">
  <div class="inner">
    <a href="index.html">Home</a>
    <a class="active" href="feed.html" aria-current="page">Feed</a>
    <a href="friends.html">Friends</a>
    <a href="chattermarket.html">Market</a>
    <a href="groups.html">Groups</a>
    <a href="events.html">Events</a>
    <a href="media.html">Media</a>
    <a href="dating.html">Dating</a>
    <a href="blogs.html">Blogs</a>
    <a href="polls.html">Polls</a>
    <a href="music.html">Music</a>
    <a href="messages.html">Messages</a>
    <a href="profile.html">Profile</a>
    <a href="settings.html">Settings</a>
  </div>
</nav>

<!-- Page -->
<div class="page">

  <!-- Main column -->
  <main>
    <!-- Composer -->
    <section class="card">
      <div class="who">
        <img id="meAvatar2" class="ava" alt="">
        <div>
          <div><strong id="meName">Me</strong></div>
          <div class="muted" style="font-size:12px">What’s on your mind?</div>
        </div>
      </div>
      <textarea id="composerText" class="composer" placeholder="Write something to your friends…"></textarea>
      <div class="tools">
        <input id="imgUrl" class="input url" placeholder="Optional image URL (paste and Post)"/>
        <button id="btnPost" class="btn primary">Post</button>
        <button id="btnClear" class="btn">Clear</button>
      </div>
    </section>

    <!-- Feed list -->
    <section id="feedList" class="feed"></section>
  </main>

  <!-- Right column -->
  <aside class="side">
    <div class="card section">
      <div class="row" style="justify-content:space-between">
        <strong>People you may know</strong>
        <a href="friends.html">See all</a>
      </div>
      <div id="suggestions" class="people"></div>
    </div>

    <div class="card section">
      <strong>Quick actions</strong>
      <div class="row" style="margin-top:8px;flex-wrap:wrap">
        <button class="btn" id="qaToFriends">Open Friends</button>
        <button class="btn" id="qaToMessages">New Message</button>
        <button class="btn" id="qaClearFeed">Clear Feed</button>
      </div>
    </div>
  </aside>
</div>

<!-- Notifications / Inbox Modals -->
<div class="modalbg" id="notifBg">
  <div class="sheet">
    <h3 style="margin:0 0 10px">Notifications</h3>
    <div id="notifList"></div>
    <div class="row" style="margin-top:8px">
      <button id="clearNotif" class="btn primary">Clear</button>
      <button id="closeNotif" class="btn">Close</button>
    </div>
  </div>
</div>
<div class="modalbg" id="inboxBg">
  <div class="sheet">
    <h3 style="margin:0 0 10px">Inbox</h3>
    <div id="inboxList"></div>
    <div class="row" style="margin-top:8px">
      <button id="closeInbox" class="btn">Close</button>
    </div>
  </div>
</div>

<script>
/* ===== Store & helpers ===== */
const LS={ USERS:'ct_users_v3', PROFILE:'ct_profile_data_v1', NOTIF:'ct_notifications_v1', INBOX:'ct_inbox_v1', FEED:'ct_feed_posts_v1' };
const $=s=>document.querySelector(s);
const load=(k,f)=>{ try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;} };
const save=(k,v)=>{ try{ localStorage.setItem(k,JSON.stringify(v)); }catch{} };
const nowISO=()=>new Date().toISOString();
const face=n=>`https://i.pravatar.cc/200?u=${encodeURIComponent(n||'me')}`;
const timeAgo=(iso)=>{ const s=(Date.now()-new Date(iso).getTime())/1000; if(s<60)return Math.floor(s)+'s'; if(s<3600)return Math.floor(s/60)+'m'; if(s<86400)return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d'; };

/* ===== Header wiring & overlay button ===== */
(function header(){
  const prof=(load(LS.PROFILE,{}))['Me']||{};
  const me=$('#meAvatar'); if(me){ me.referrerPolicy='no-referrer'; me.loading='lazy'; me.src=prof.avatar||face('Me'); me.alt='Me'; me.onclick=()=>{ try{localStorage.setItem('ct_profile_view_v1',JSON.stringify({name:'Me'}));}catch{}; location.href='profile.html'; }; }
  const me2=$('#meAvatar2'); if(me2){ me2.referrerPolicy='no-referrer'; me2.loading='lazy'; me2.src=prof.avatar||face('Me'); }
  document.getElementById('btnMsgs').onclick = (e)=>{ e.preventDefault(); if(window.ChatternetMessenger?.open) return window.ChatternetMessenger.open(); if(window.ctOpen) return window.ctOpen(); location.href='messages.html'; };

  const nbg=document.getElementById('notifBg'), ibg=document.getElementById('inboxBg');
  function rN(){ const arr=load(LS.NOTIF,[]); document.getElementById('notifList').innerHTML=arr.length?arr.map(n=>`<div class="pill" style="display:block;margin:4px 0">${new Date(n.time).toLocaleString()} — ${n.text||''}</div>`).join(''):'No notifications yet.'; }
  function rI(){ const arr=load(LS.INBOX,[]); document.getElementById('inboxList').innerHTML=arr.length?arr.map(n=>`<div class="pill" style="display:block;margin:4px 0">${new Date(n.time).toLocaleString()} — ${n.text||''}</div>`).join(''):'Inbox is empty.'; }
  document.getElementById('btnNotif').onclick=()=>{ rN(); nbg.style.display='flex'; };
  document.getElementById('clearNotif').onclick=()=>{ save(LS.NOTIF,[]); rN(); };
  document.getElementById('closeNotif').onclick=()=>{ nbg.style.display='none'; };
  document.getElementById('btnInbox').onclick=()=>{ rI(); ibg.style.display='flex'; };
  document.getElementById('closeInbox').onclick=()=>{ ibg.style.display='none'; };
})();

/* ===== Seed users ===== */
(function seedUsers(){
  let u = load(LS.USERS, []);
  const WANT = ['Chatternet','Bill Thomas','Kate White','Michael Reed','Olivia Perez','David Carter','Grace Lee','Liam Adams','Ava Morgan','Noah Walker','Sophia Turner','Mason Hill'];
  const names = new Set(u.map(x=>x && x.name).filter(Boolean));
  if(!names.has('Me')) u.unshift({name:'Me',avatar:face('Me')});
  if(u.filter(x=>x.name!=='Me').length < 8){ WANT.forEach(n=>{ if(!names.has(n)){ u.push({name:n, avatar:face(n)}); names.add(n);} }); }
  save(LS.USERS, u);
})();

/* ===== Feed store ===== */
const posts = ()=>load(LS.FEED,[]);
const setPosts = a=>save(LS.FEED,a);

/* Seed initial demo posts */
(function seedFeed(){
  let p=posts(); if(p && p.length) return;
  const take = load(LS.USERS,[]).filter(x=>x.name!=='Me').slice(0,5).map(x=>x.name);
  const demo=[ {a:take[0]||'Grace Lee',t:"What a sunny day in Horsham ☀️ Walking the dog later!"}, {a:take[1]||'Liam Adams',t:"Cooking pasta tonight. Any favorite sauces?"}, {a:'Me',t:"Hello, world! First post on Chatternet □"}, {a:take[2]||'Ava Morgan',t:"Finished a great documentary—recommendations welcome."}, {a:take[3]||'Noah Walker',t:"Gym done ✅ Coffee time."} ];
  p = demo.map(d=>({id:'p_'+Math.random().toString(36).slice(2),author:d.a,avatar:face(d.a),text:d.t,time:nowISO(),likes:Math.floor(Math.random()*15),comments:0,cmts:[],img:null}));
  setPosts(p);
})();

/* ===== Composer ===== */
document.getElementById('btnPost').onclick=()=>{
  const txt=(document.getElementById('composerText').value||'').trim(), img=(document.getElementById('imgUrl').value||'').trim();
  if(!txt && !img) return;
  const me='Me', p=posts();
  p.unshift({id:'p_'+Math.random().toString(36).slice(2),author:me,avatar:face(me),text:txt,time:nowISO(),likes:0,comments:0,cmts:[],img:img||null});
  setPosts(p); document.getElementById('composerText').value=''; document.getElementById('imgUrl').value=''; renderFeed();
};
document.getElementById('btnClear').onclick=()=>{ document.getElementById('composerText').value=''; document.getElementById('imgUrl').value=''; };

/* ===== Utilities ===== */
const esc=s=>String(s||'').replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
function ensureCmts(p){ if(!Array.isArray(p.cmts)) p.cmts=[]; if(typeof p.comments!=='number') p.comments=p.cmts.length; }

/* ===== Render feed (with comments UI) ===== */
function cmtHtml(c){
  return `
    <div class="cmt-item">
      <img class="cmt-ava" src="${esc(c.avatar||face(c.author))}" alt="">
      <div class="cmt-bubble">
        <div class="cmt-meta"><strong>${esc(c.author||'Me')}</strong> • ${timeAgo(c.time)} ago</div>
        <div>${esc(c.text)}</div>
      </div>
    </div>
  `;
}
function postHtml(p){
  ensureCmts(p);
  const counts = `${p.likes} likes • ${p.cmts.length} comments`;
  const cmtsList = p.cmts.map(cmtHtml).join('');
  return `
  <article class="post" data-id="${p.id}">
    <div class="head">
      <img class="pava" src="${p.avatar||face(p.author)}" alt="">
      <div style="min-width:0;flex:1">
        <div class="author">${esc(p.author)}</div>
        <div class="time">${timeAgo(p.time)} ago</div>
      </div>
      <button class="btn" data-act="message" data-name="${esc(p.author)}">Message</button>
    </div>
    <div class="txt">${esc(p.text)}</div>
    ${p.img?`<img class="img" src="${esc(p.img)}" alt="">`:``}
    <div class="row">
      <button class="btn" data-act="like">❤️ Like</button>
      <span class="pill" data-role="counts">${counts}</span>
      <button class="btn" data-act="toggleComments">□ Comment</button>
      <button class="btn warn" data-act="delete">Delete</button>
    </div>

    <div class="cmts" data-role="cmts" hidden>
      <div data-role="list">${cmtsList || '<div class="muted">Be the first to comment.</div>'}</div>
      <div class="cmt-form">
        <input class="cmt-input" type="text" placeholder="Write a comment…" data-role="input"/>
        <button class="cmt-send" data-act="sendComment">Post</button>
      </div>
    </div>
  </article>`;
}
function renderFeed(){
  const box=document.getElementById('feedList'), p=posts();
  p.forEach(ensureCmts); setPosts(p);
  box.innerHTML = p.length ? p.map(postHtml).join('') : '<div class="card muted">No posts yet. Say hello using the composer above.</div>';
}
renderFeed();

/* ===== Post actions ===== */
document.getElementById('feedList').addEventListener('click',(e)=>{
  const b=e.target.closest('button[data-act]'); if(!b) return;
  const act=b.getAttribute('data-act');
  const art=b.closest('.post'); if(!art) return;
  const id=art.getAttribute('data-id');
  let p=posts(); const i=p.findIndex(x=>x.id===id); if(i<0) return;
  ensureCmts(p[i]);

  if(act==='like'){
    p[i].likes++; setPosts(p);
    art.querySelector('[data-role="counts"]').textContent = `${p[i].likes} likes • ${p[i].cmts.length} comments`;
  } else if(act==='toggleComments'){
    const box=art.querySelector('[data-role="cmts"]');
    if(box) box.hidden = !box.hidden;
    if(box && !box.hidden){ const inp=box.querySelector('[data-role="input"]'); if(inp) inp.focus(); }
  } else if(act==='sendComment'){
    const box=art.querySelector('[data-role="cmts"]');
    const inp=box && box.querySelector('[data-role="input"]');
    const val=(inp && inp.value.trim())||'';
    if(!val) return;
    const me='Me';
    p[i].cmts.push({author:me, avatar:face(me), text:val, time:nowISO()});
    p[i].comments = p[i].cmts.length;
    setPosts(p);
    const list=box.querySelector('[data-role="list"]');
    list.insertAdjacentHTML('beforeend', cmtHtml(p[i].cmts[p[i].cmts.length-1]));
    art.querySelector('[data-role="counts"]').textContent = `${p[i].likes} likes • ${p[i].cmts.length} comments`;
    inp.value='';
  } else if(act==='delete'){
    p.splice(i,1); setPosts(p); renderFeed();
  } else if(act==='message'){
    const name=b.getAttribute('data-name')||p[i].author;
    if(window.ChatternetMessenger?.open) ChatternetMessenger.open();
    else if(window.ctOpen) ctOpen();
    else location.href='messages.html';
  }
});

/* Submit comment on Enter */
document.getElementById('feedList').addEventListener('keydown',(e)=>{
  if(e.key!=='Enter') return;
  const inp=e.target.closest('.cmt-input'); if(!inp) return;
  e.preventDefault();
  const art=e.target.closest('.post'); if(!art) return;
  const sendBtn=art.querySelector('button[data-act="sendComment"]');
  if(sendBtn) sendBtn.click();
});

/* Suggestions (right column) */
(function suggestions(){
  const box=document.getElementById('suggestions'); const u=load(LS.USERS,[]).filter(x=>x.name!=='Me').slice(0,6);
  box.innerHTML=u.map(x=>`
    <div class="person">
      <img class="picon" src="${x.avatar||face(x.name)}" alt="">
      <div style="flex:1;min-width:0">
        <div style="font-weight:600">${x.name}</div>
        <div class="muted" style="font-size:12px">@${x.name.toLowerCase().replace(/\s+/g,'.')}</div>
      </div>
      <button class="btn" data-add="${x.name}">Add</button>
    </div>`).join('');
  box.addEventListener('click',(e)=>{
    const b=e.target.closest('button[data-add]'); if(!b) return;
    const name=b.getAttribute('data-add'); try{
      const k='ct_friend_requests_out_v2'; const out=load(k,[]); if(!out.includes(name)) out.unshift(name); save(k,out);
      const n=load(LS.NOTIF,[]); n.unshift({text:`Friend request sent to ${name}.`,time:nowISO()}); save(LS.NOTIF,n);
      b.textContent='Sent'; b.disabled=true;
    }catch{}
  });
})();

/* Quick actions */
document.getElementById('qaToFriends').onclick=()=>location.href='friends.html';
document.getElementById('qaToMessages').onclick=()=>{ if(window.ChatternetMessenger?.open) ChatternetMessenger.open(); else if(window.ctOpen) ctOpen(); else location.href='messages.html'; };
document.getElementById('qaClearFeed').onclick=()=>{ save(LS.FEED,[]); renderFeed(); };
</script>

</body>
</html>
